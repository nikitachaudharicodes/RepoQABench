{
  "repo_name": "oppia_oppia",
  "issue_id": "16016",
  "issue_description": "# Dev server dummy topic should come pre-populated without any validation errors\n\nWhen loading the dummy topic on the dev server, it comes loaded with 4 validation errors. We should just pre-populate it to not have any validation errors. Otherwise, developers will always need to fix those errors before being able to publish it. It's also weird that I've always had this 1 SVG file saved on my computer just for the purpose of uploading it to Oppia's dev server.",
  "issue_comments": [
    {
      "id": 1833843816,
      "user": "seanlip",
      "body": "I am marking this as a good first issue. To address this issue, I suggest doing the following:\r\n\r\n1) Try reproducing the error locally. Go to /admin > Activities and click each of the \"load dummy data\" buttons at the bottom. Record each of the errors that occur.\r\n2) Fix each of the errors you found in (1) so that loading of dummy data works seamlessly.\r\n3) Give yourself superadmin permissions, and visit the editor pages (topic editor, skill editor, exploration editor, etc.) for each of the dummy data items created. Check that each item is saveable without any warnings (i.e. that if you make a trivial change, you can publish the change automatically and there is no warning icon in the navbar). If there are warnings, fix the dummy data so that those warnings do not appear (see the [LaCE onboarding guide](https://github.com/oppia/oppia/wiki/LaCE-onboarding-guide) for details). Provide before-and-after screenshots of the topic editor / skill editor / etc. pages as well so we can confirm they look good.\r\n4) (If needed) Extend the dummy data loading to add any missing steps that might have arisen due to infrastructural changes since they were implemented, Make sure the wording next to each button accurately describes the final state of things after the operation initiated by the button is fully performed.\r\n\r\n**Note**: As you investigate this issue, we recommend chronicling your progress in a [debugging doc](https://github.com/oppia/oppia/wiki/Debugging-Docs). This can help others see your progress and help you if needed.\r\n\r\nIf you would like to take up this issue, please provide an explanation of what your PR will do (with names of files you're changing, what you plan to change in each file, etc.), and a link to your debugging doc (above). If it looks good, we can assign you to this issue."
    },
    {
      "id": 1860278582,
      "user": "11happy",
      "body": "Hello @EricZLou I have been able to successfully setup the dev server\r\n\r\n and and successfully did the Step 1 as mentioned above , tried to reproduce the error however I have not faced any validation errors, can you please tell me how to reproduce the issue. I am interested to take this issue. However during \"Load new Dummy structures data\" got one error on the console. I am also attaching the error I got.\r\nThank you\r\n<img width=\"468\" alt=\"image\" src=\"https://github.com/oppia/oppia/assets/76656712/f6c3977a-ada2-45ee-9376-14cf87d15fe3\">\r\n\r\n\r\n"
    },
    {
      "id": 1869614316,
      "user": "seanlip",
      "body": "@11happy Thanks for your note and sorry for the late reply. I just realized I missed a step in the [instructions above](https://github.com/oppia/oppia/issues/16016#issuecomment-1833843816), I've gone back and fixed them. Please could you take a look? (It's step 3.)\r\n\r\nAlso, the warnings that you have here (about the app not being able to send emails to users) are not relevant to this issue, so don't worry about those."
    },
    {
      "id": 1869693569,
      "user": "11happy",
      "body": "Sure I will look into it."
    },
    {
      "id": 1871217248,
      "user": "masterboy376",
      "body": "Hello @seanlip, I successfully performed 1st step and following error occurs:\r\n\"Server error: Topic with name 'Dummy Topic 1' already exists\""
    },
    {
      "id": 1871921989,
      "user": "seanlip",
      "body": "@masterboy376 You probably already have that topic loaded. You might need to restart from a clean server.\r\n\r\nAlso next time, please always post the error logs and full stacktrace when you post an error message -- it makes things easier to debug."
    },
    {
      "id": 1872478726,
      "user": "masterboy376",
      "body": "Hello @seanlip,\r\nI have successfully reproduced the above issue.\r\nOn the editor tab, there are 4 validation warnings which come preloaded in a dummy topic:\r\n![Screenshot (11)](https://github.com/oppia/oppia/assets/92575005/a5126cf3-44c3-47fb-ba5d-458869982ede)\r\n\r\nThere are 2 possible solutions to this issue that I can think of at this moment:\r\n1. First Solution: \r\n- Make necessary changes to the dummy data to avoid  validation warnings, by making changes to [core/templates/pages/admin-page/activities-tab/admin-dev-mode-activities-tab.component.ts](core/templates/pages/admin-page/activities-tab/admin-dev-mode-activities-tab.component.ts) and [core/controllers/admin.py](core/controllers/admin.py)\r\n- Leaving the validation rules intact, which are defined in [core/templates/domain/topic/topic-object.model.ts](core/templates/domain/topic/topic-object.model.ts)\r\n\r\n2. Second Solution:\r\n- Here we change the validation rules according to dummy data, which are defined in [core/templates/domain/topic/topic-object.model.ts](core/templates/domain/topic/topic-object.model.ts)\r\n\r\nI prefer the first solution. Though, which ever solution you suggest can be implemented. I will be more than interested in solving this issue. \r\nAny Inputs from the community will help and is appreciated.\r\nRegards"
    },
    {
      "id": 1873406924,
      "user": "seanlip",
      "body": "@masterboy376 Please go with the first solution. Can you explain what changes you'll make exactly and show proof that those changes don't result in warnings?\r\n\r\nAlso, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow? (As part of the fix for this issue, we should maybe add a backend test that tries to load dummy data so it catches this, and the backend ought to fail noisily if the dummy data doesn't pass strict validation -- that way, anyone who makes changes that result in strict validation failing will need to fix them so that this doesn't break other developers, and that is probably better than leaving the dummy data invalid which would cause problems for other devs.)"
    },
    {
      "id": 1873941267,
      "user": "masterboy376",
      "body": "> @masterboy376 Please go with the first solution. Can you explain what changes you'll make exactly and show proof that those changes don't result in warnings?\r\n> \r\n> Also, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow? (As part of the fix for this issue, we should maybe add a backend test that tries to load dummy data so it catches this, and the backend ought to fail noisily if the dummy data doesn't pass strict validation -- that way, anyone who makes changes that result in strict validation failing will need to fix them so that this doesn't break other developers, and that is probably better than leaving the dummy data invalid which would cause problems for other devs.)\r\n\r\n@seanlip ,\r\n\r\nI will change implementation of function _load_dummy_new_structures_data so that the all the validation checks passes on the dummy topic by default.\r\n\r\nFor the part of loading dummy data, the thing I found wrong is that it requires  the user to be a Curriculum Admin to load dummy data, but on the activities page it erroneously writes: admin can access that particular feature instead of writing Curriculum Admin.\r\n\r\nAlso, we can add a backend test that tries load dummy data by adding some tests to the existing activities.component.spec.ts.\r\n\r\nResult:\r\n![Screenshot (12)](https://github.com/oppia/oppia/assets/92575005/3018bfe5-f6f1-4841-a50b-53ecbb4b2a72)\r\n\r\nDummy data ready to be published by default.\r\n"
    },
    {
      "id": 1874342842,
      "user": "seanlip",
      "body": "@masterboy376 Thanks, some notes:\r\n\r\n- You haven't answered this question: \"Also, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow?\". Why is the current dummy data not resulting in a server error when the button is clicked, and what specifically would you modify in the code to make that happen? For this question, please point to the specific line of code and show your proposed edits.\r\n- Re \"For the part of loading dummy data, the thing I found wrong is that it requires the user to be a Curriculum Admin to load dummy data, but on the activities page it erroneously writes: admin can access that particular feature instead of writing Curriculum Admin.\" -- we might need to fix that, yup. Probably just changing the text is enough (to direct the admin to give themselves Curriculum Admin permissions on the Roles tab).\r\n- \"Also, we can add a backend test that tries load dummy data by adding some tests to the existing activities.component.spec.ts.\" - I don't think this will work. The file you're referring to is a frontend file and it's not going to have access to the backend data. Given that this response is wrong, I can't conclude that you have a good enough understanding of this project to tackle it (at least not yet). I'm now going to ask that you try actually writing the test, running it to make sure it works, and screenshotting it here, before we assign you the issue.\r\n\r\nFeel free to ask if you have any questions about the above -- thanks."
    },
    {
      "id": 1875484507,
      "user": "masterboy376",
      "body": "@seanlip, Thank you so much for these valuable inputs.\r\n\r\n1. Current Dummy data is not resulting in a server error, because currently the \"load data button\" generate two topics with incomplete fields, which fails the pre-publish validation checks preventing these topics to be readily published. There is no validation tests to test whether the generated topic ( by the function \"_load_dummy_new_structures_data\" ) passes all validation checks until we actually try to publish it (we should add a backend test to check this). I made following changes to resolve the validation warning issues:\r\n  1.1. added meta data content to the dummy topic 1:\r\n   ![Screenshot (13)](https://github.com/oppia/oppia/assets/92575005/1781b4d4-c871-4f89-a679-f52a2c7d244e)\r\n   1.2. added default thumbnail background image and color:\r\n   ![Screenshot (14)](https://github.com/oppia/oppia/assets/92575005/01750215-06ec-46f1-9718-9ff9864b12f6)\r\n   1.3. added default thumbnail background image and color to dummy subtopic:\r\n   ![Screenshot (15)](https://github.com/oppia/oppia/assets/92575005/ebaa1cd5-7f2a-49ae-9dea-24c430cdd6d4)\r\n   1.4. added diagnostic test to the topic testing atleast one skill (with at least 3 quesstions):\r\n   ![Screenshot (16)](https://github.com/oppia/oppia/assets/92575005/ad29723e-45a4-4d69-a880-3d2f26e79a09)\r\n   ![Screenshot (17)](https://github.com/oppia/oppia/assets/92575005/607c079b-1519-4536-8ff1-0e3bf868d1e9)\r\n   ![Screenshot (18)](https://github.com/oppia/oppia/assets/92575005/35794f89-3db8-448c-8e00-1b9a261e8477)\r\n   ![Screenshot (19)](https://github.com/oppia/oppia/assets/92575005/d6754888-4ee5-4ac1-92f7-6f940f25329b)\r\n   ![Screenshot (20)](https://github.com/oppia/oppia/assets/92575005/15dabf14-be8f-4ff7-8d67-247e91c285f6)\r\n\r\n2. I am working on the Backend test and will soon come up with it.\r\n\r\nI have following queries related to this issue:\r\n\r\n1.  Currently the \"_load_dummy_new_structures_data\" function generates two topics with name \"Dummy Topic 1\" and \"Empty Topic\". In the above screenshots I only resolved the validation warnings is the \"Dummy Topic 1\". In the later one, as the suggests, the topic should be empty. So, should I resolve warnings in \"Empty Topic\" as well or should it be left as it is? \r\n2. On the thumbnail upload modal there are two different guidelines of which the first on is applicable in the dev server.\r\n![Screenshot (21)](https://github.com/oppia/oppia/assets/92575005/401430c0-aed0-4787-9b34-4354f161b659)\r\n\r\n"
    },
    {
      "id": 1875780091,
      "user": "seanlip",
      "body": "Thanks @masterboy376  -- I'll wait to see your backend test.\r\n\r\nFor the validation error analysis: just to check, when we load the dummy data, does it not end up in a \"published\" state? If not, then your explanation seems reasonable. But if it is, then my question stands: on the (automatic) publication why doesn't the publication fail?\r\n\r\nFor your questions:\r\n1. What's the empty topic used for?\r\n2. This is a bit weird and might be a bug. The uploaded image should satisfy all the guidelines given. But I think the person who implemented the inline warning in the \"Drag an image into this area\" section might not have seen this modal. If you get a chance, could you please find which PR did that (perhaps using git blame) so that I can advise on what to do here? Thanks!"
    },
    {
      "id": 1876786561,
      "user": "masterboy376",
      "body": "@seanlip ,\r\nAs per current implementation, upon loading dummy data, dummy topics do not end up in \"published\" state.\r\n\r\nFor questions:\r\n\r\n1. \"Empty topic\" is the name of one of the dummy topics generated. \"Empty topic\" is similar to other topics generated on loading dummy data. I suggest changing its name to \"Dummy Topic 2\" to make it more reasonable.\r\n2. I will find PR thet might have been caused this bug shortly."
    },
    {
      "id": 1878129691,
      "user": "seanlip",
      "body": "OK thanks. One question then. Should those topics end up in a \"published\" state, do you think?\r\n\r\n1. Hm, I think it's OK to just delete \"Empty topic\" TBH. If the dev wants a new topic they can easily create it. Let's optimize so that the final state of things is easy for devs to use.\r\n2. Sounds good, please let me know when you do that.\r\n\r\nAlso noting here that this is still waiting on the backend test (so it doesn't get lost in the comments above). "
    },
    {
      "id": 1878823667,
      "user": "masterboy376",
      "body": "Hello @seanlip ,\r\nFor the backend testing part I made following changes to [test_load_new_structures_data](https://github.com/oppia/oppia/blob/6171792008266ad07826564316712b4b7b10eb61/core/controllers/admin_test.py#L537C1-L537C1) function in admin_test.py file:\r\n![Screenshot (23)](https://github.com/oppia/oppia/assets/92575005/effd1af1-6c09-4f29-904a-fa2d7e1232ea)\r\nthese changes successfully tests for all the possible validation errors:\r\n![Screenshot (24)](https://github.com/oppia/oppia/assets/92575005/5f54658b-b89e-4124-bdbc-fbf87ee63b99)\r\nI would appreciate any valuable suggestions.\r\n\r\nI think the generated topics, through load dummy data button, should not end up in \"published\" state. There is an existing functionality serving that purpose:\r\n![Screenshot (25)](https://github.com/oppia/oppia/assets/92575005/b0736797-b178-4e76-bcee-01d98c269154)\r\n\r\nAlso, I think it would be best to leave to \"Empty topic as it is\" because its already mentioned to the user that the load dummy data will load 2 topics (one of which will be Empty). So, I will wait for your confirmation on this one to make changes.\r\n![Screenshot (26)](https://github.com/oppia/oppia/assets/92575005/e669e6e3-13da-41d0-92a9-8287ec9dc4eb)\r\n\r\nI believe [this commit](https://github.com/oppia/oppia/commit/77d2c9e84e281ca32da9ebfab246270da8293470) from [this PR](https://github.com/oppia/oppia/pull/12667) cause the bug in thumbnail uploader modal.\r\nTo solve this bug we have to change image-uploader component. I believe it is as a much larger issue because there are different components that use the same image uploader, and all these components have there own criteria for allowed image format. If you allow I can create a separate issue and a PR for this one (As I have already figured out the possible way of solving this one).\r\n\r\nCan I create PR for this issue now?"
    },
    {
      "id": 1880454014,
      "user": "masterboy376",
      "body": "Hello @seanlip ,\r\nWhile browsing the codebase I found that someone has made some changes to Dummy Topic 1 in this [commit ](https://github.com/oppia/oppia/commit/6171792008266ad07826564316712b4b7b10eb61) so it partially passes the validation checks and still there is no backend test for the same.\r\nAlso after this commit we are unable to open the subtopic editor :\r\n![Screenshot (45)](https://github.com/oppia/oppia/assets/92575005/6f38b404-4020-453c-aabe-963136a6d76e)\r\nthis is because the implementation in this commit does not add a subtopic to the dummy topic. In my implementation I have fixed this error using topic_id_1.add_subtopic() function.\r\nIf you allow then I can proceed with the PR which solves the above issue completely."
    },
    {
      "id": 1880807377,
      "user": "seanlip",
      "body": "@masterboy376 Thanks. Let's clean things up a bit:\r\n\r\n1. It is fine to clean up the empty topic and update the admin page message accordingly.\r\n2. Let's publish the generated topics. I don't see any harm in doing that. If the developer wants to create unpublished topics subsequently, they can do so manually.\r\n3. For the backend test, I wouldn't put all the individual validations in admin_test.py. I think publishing the topics (as mentioned in point 2 above) might solve it because a validation step runs, so it might get tested automatically if you do that step and just load the dummy data in tests. If/When you create a PR for this issue, then please demonstrate in the opening description that, if you change the dummy data to something invalid, then the backend test fails.\r\n4. Thanks for finding the old PR. I think that's not actually the issue -- there was probably a PR that changed the error message in the bottom-left yellow box. Can you find it? I think it is also OK to file a new issue to fix that.\r\n5. For the PR that broke the subtopic editor -- I don't quite understand what you mean. If there are no subtopics in the topic then how does a user get to the page with the error?\r\n\r\nIf you can respond with the answers to (4) and (5) (and file a clear issue for point 4), then I'd be happy to assign you to this issue. Thanks!"
    },
    {
      "id": 1881039377,
      "user": "masterboy376",
      "body": "@seanlip Thank you for your remarks:\r\n\r\n1. Point 1, 2, 3 are done as suggested.\r\n2.  Point 4: I think the PR that changed the error message in the bottom-left yellow box is [Fix #17711: Add Image Upload Prerequisites (#19194)](https://github.com/oppia/oppia/commit/5e8738af4a8daf0a02ecc7f22e36fbf8cb898816).\r\n3. Point 5: I apologies if the previous comment was not clear. I meant to say that the PR I referred to earlier added a subtopic to \"subtopics\" array property of \"Dummy Topic 1\" without using the proper function to do that, which is \"add_subtopic()\"function which properly creates a default subtopic associated with a topic, current Implementation broke the subtopic editor due to this reason. The same issue can also be seen in the topics generated by \"generate_dummy_classroom\" button.\r\nCurrent Implementation:\r\n![Screenshot (54)](https://github.com/oppia/oppia/assets/92575005/bb8de485-b08e-4bef-8f2b-a9a15d5ea45e)\r\nSuggested Implementation:\r\n![Screenshot (53)](https://github.com/oppia/oppia/assets/92575005/eb8fc400-c183-4a82-b145-ab3cdd16a700)\r\nThe suggested Implementation fixes the subtopic editor.\r\n"
    },
    {
      "id": 1881172771,
      "user": "seanlip",
      "body": "Great -- you are correct re (4). /cc @AFZL210 so that he's aware of the breakage here. Can you please file the new issue?\r\n\r\nFor (5), ok sounds good, you might as well just fix it I think.\r\n\r\nPlease file the issue mentioned above and then link it here, then I'll assign you to this. Thanks!"
    },
    {
      "id": 1881585474,
      "user": "masterboy376",
      "body": "@seanlip Thankyou,\r\nI created the following [Issue](https://github.com/oppia/oppia/issues/19424) Please take a look and suggest any changes if any."
    },
    {
      "id": 1881655781,
      "user": "seanlip",
      "body": "Thanks! Looks good, assigned you :)"
    },
    {
      "id": 1882792425,
      "user": "masterboy376",
      "body": "Thank you @seanlip for assigning me this issue I will make a pull request within a day."
    }
  ],
  "text_context": "# Dev server dummy topic should come pre-populated without any validation errors\n\nWhen loading the dummy topic on the dev server, it comes loaded with 4 validation errors. We should just pre-populate it to not have any validation errors. Otherwise, developers will always need to fix those errors before being able to publish it. It's also weird that I've always had this 1 SVG file saved on my computer just for the purpose of uploading it to Oppia's dev server.\n\nI am marking this as a good first issue. To address this issue, I suggest doing the following:\r\n\r\n1) Try reproducing the error locally. Go to /admin > Activities and click each of the \"load dummy data\" buttons at the bottom. Record each of the errors that occur.\r\n2) Fix each of the errors you found in (1) so that loading of dummy data works seamlessly.\r\n3) Give yourself superadmin permissions, and visit the editor pages (topic editor, skill editor, exploration editor, etc.) for each of the dummy data items created. Check that each item is saveable without any warnings (i.e. that if you make a trivial change, you can publish the change automatically and there is no warning icon in the navbar). If there are warnings, fix the dummy data so that those warnings do not appear (see the [LaCE onboarding guide](https://github.com/oppia/oppia/wiki/LaCE-onboarding-guide) for details). Provide before-and-after screenshots of the topic editor / skill editor / etc. pages as well so we can confirm they look good.\r\n4) (If needed) Extend the dummy data loading to add any missing steps that might have arisen due to infrastructural changes since they were implemented, Make sure the wording next to each button accurately describes the final state of things after the operation initiated by the button is fully performed.\r\n\r\n**Note**: As you investigate this issue, we recommend chronicling your progress in a [debugging doc](https://github.com/oppia/oppia/wiki/Debugging-Docs). This can help others see your progress and help you if needed.\r\n\r\nIf you would like to take up this issue, please provide an explanation of what your PR will do (with names of files you're changing, what you plan to change in each file, etc.), and a link to your debugging doc (above). If it looks good, we can assign you to this issue.\n\nHello @EricZLou I have been able to successfully setup the dev server\r\n\r\n and and successfully did the Step 1 as mentioned above , tried to reproduce the error however I have not faced any validation errors, can you please tell me how to reproduce the issue. I am interested to take this issue. However during \"Load new Dummy structures data\" got one error on the console. I am also attaching the error I got.\r\nThank you\r\n<img width=\"468\" alt=\"image\" src=\"https://github.com/oppia/oppia/assets/76656712/f6c3977a-ada2-45ee-9376-14cf87d15fe3\">\r\n\r\n\r\n\n\n@11happy Thanks for your note and sorry for the late reply. I just realized I missed a step in the [instructions above](https://github.com/oppia/oppia/issues/16016#issuecomment-1833843816), I've gone back and fixed them. Please could you take a look? (It's step 3.)\r\n\r\nAlso, the warnings that you have here (about the app not being able to send emails to users) are not relevant to this issue, so don't worry about those.\n\nSure I will look into it.\n\nHello @seanlip, I successfully performed 1st step and following error occurs:\r\n\"Server error: Topic with name 'Dummy Topic 1' already exists\"\n\n@masterboy376 You probably already have that topic loaded. You might need to restart from a clean server.\r\n\r\nAlso next time, please always post the error logs and full stacktrace when you post an error message -- it makes things easier to debug.\n\nHello @seanlip,\r\nI have successfully reproduced the above issue.\r\nOn the editor tab, there are 4 validation warnings which come preloaded in a dummy topic:\r\n![Screenshot (11)](https://github.com/oppia/oppia/assets/92575005/a5126cf3-44c3-47fb-ba5d-458869982ede)\r\n\r\nThere are 2 possible solutions to this issue that I can think of at this moment:\r\n1. First Solution: \r\n- Make necessary changes to the dummy data to avoid  validation warnings, by making changes to [core/templates/pages/admin-page/activities-tab/admin-dev-mode-activities-tab.component.ts](core/templates/pages/admin-page/activities-tab/admin-dev-mode-activities-tab.component.ts) and [core/controllers/admin.py](core/controllers/admin.py)\r\n- Leaving the validation rules intact, which are defined in [core/templates/domain/topic/topic-object.model.ts](core/templates/domain/topic/topic-object.model.ts)\r\n\r\n2. Second Solution:\r\n- Here we change the validation rules according to dummy data, which are defined in [core/templates/domain/topic/topic-object.model.ts](core/templates/domain/topic/topic-object.model.ts)\r\n\r\nI prefer the first solution. Though, which ever solution you suggest can be implemented. I will be more than interested in solving this issue. \r\nAny Inputs from the community will help and is appreciated.\r\nRegards\n\n@masterboy376 Please go with the first solution. Can you explain what changes you'll make exactly and show proof that those changes don't result in warnings?\r\n\r\nAlso, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow? (As part of the fix for this issue, we should maybe add a backend test that tries to load dummy data so it catches this, and the backend ought to fail noisily if the dummy data doesn't pass strict validation -- that way, anyone who makes changes that result in strict validation failing will need to fix them so that this doesn't break other developers, and that is probably better than leaving the dummy data invalid which would cause problems for other devs.)\n\n> @masterboy376 Please go with the first solution. Can you explain what changes you'll make exactly and show proof that those changes don't result in warnings?\r\n> \r\n> Also, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow? (As part of the fix for this issue, we should maybe add a backend test that tries to load dummy data so it catches this, and the backend ought to fail noisily if the dummy data doesn't pass strict validation -- that way, anyone who makes changes that result in strict validation failing will need to fix them so that this doesn't break other developers, and that is probably better than leaving the dummy data invalid which would cause problems for other devs.)\r\n\r\n@seanlip ,\r\n\r\nI will change implementation of function _load_dummy_new_structures_data so that the all the validation checks passes on the dummy topic by default.\r\n\r\nFor the part of loading dummy data, the thing I found wrong is that it requires  the user to be a Curriculum Admin to load dummy data, but on the activities page it erroneously writes: admin can access that particular feature instead of writing Curriculum Admin.\r\n\r\nAlso, we can add a backend test that tries load dummy data by adding some tests to the existing activities.component.spec.ts.\r\n\r\nResult:\r\n![Screenshot (12)](https://github.com/oppia/oppia/assets/92575005/3018bfe5-f6f1-4841-a50b-53ecbb4b2a72)\r\n\r\nDummy data ready to be published by default.\r\n\n\n@masterboy376 Thanks, some notes:\r\n\r\n- You haven't answered this question: \"Also, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow?\". Why is the current dummy data not resulting in a server error when the button is clicked, and what specifically would you modify in the code to make that happen? For this question, please point to the specific line of code and show your proposed edits.\r\n- Re \"For the part of loading dummy data, the thing I found wrong is that it requires the user to be a Curriculum Admin to load dummy data, but on the activities page it erroneously writes: admin can access that particular feature instead of writing Curriculum Admin.\" -- we might need to fix that, yup. Probably just changing the text is enough (to direct the admin to give themselves Curriculum Admin permissions on the Roles tab).\r\n- \"Also, we can add a backend test that tries load dummy data by adding some tests to the existing activities.component.spec.ts.\" - I don't think this will work. The file you're referring to is a frontend file and it's not going to have access to the backend data. Given that this response is wrong, I can't conclude that you have a good enough understanding of this project to tackle it (at least not yet). I'm now going to ask that you try actually writing the test, running it to make sure it works, and screenshotting it here, before we assign you the issue.\r\n\r\nFeel free to ask if you have any questions about the above -- thanks.\n\n@seanlip, Thank you so much for these valuable inputs.\r\n\r\n1. Current Dummy data is not resulting in a server error, because currently the \"load data button\" generate two topics with incomplete fields, which fails the pre-publish validation checks preventing these topics to be readily published. There is no validation tests to test whether the generated topic ( by the function \"_load_dummy_new_structures_data\" ) passes all validation checks until we actually try to publish it (we should add a backend test to check this). I made following changes to resolve the validation warning issues:\r\n  1.1. added meta data content to the dummy topic 1:\r\n   ![Screenshot (13)](https://github.com/oppia/oppia/assets/92575005/1781b4d4-c871-4f89-a679-f52a2c7d244e)\r\n   1.2. added default thumbnail background image and color:\r\n   ![Screenshot (14)](https://github.com/oppia/oppia/assets/92575005/01750215-06ec-46f1-9718-9ff9864b12f6)\r\n   1.3. added default thumbnail background image and color to dummy subtopic:\r\n   ![Screenshot (15)](https://github.com/oppia/oppia/assets/92575005/ebaa1cd5-7f2a-49ae-9dea-24c430cdd6d4)\r\n   1.4. added diagnostic test to the topic testing atleast one skill (with at least 3 quesstions):\r\n   ![Screenshot (16)](https://github.com/oppia/oppia/assets/92575005/ad29723e-45a4-4d69-a880-3d2f26e79a09)\r\n   ![Screenshot (17)](https://github.com/oppia/oppia/assets/92575005/607c079b-1519-4536-8ff1-0e3bf868d1e9)\r\n   ![Screenshot (18)](https://github.com/oppia/oppia/assets/92575005/35794f89-3db8-448c-8e00-1b9a261e8477)\r\n   ![Screenshot (19)](https://github.com/oppia/oppia/assets/92575005/d6754888-4ee5-4ac1-92f7-6f940f25329b)\r\n   ![Screenshot (20)](https://github.com/oppia/oppia/assets/92575005/15dabf14-be8f-4ff7-8d67-247e91c285f6)\r\n\r\n2. I am working on the Backend test and will soon come up with it.\r\n\r\nI have following queries related to this issue:\r\n\r\n1.  Currently the \"_load_dummy_new_structures_data\" function generates two topics with name \"Dummy Topic 1\" and \"Empty Topic\". In the above screenshots I only resolved the validation warnings is the \"Dummy Topic 1\". In the later one, as the suggests, the topic should be empty. So, should I resolve warnings in \"Empty Topic\" as well or should it be left as it is? \r\n2. On the thumbnail upload modal there are two different guidelines of which the first on is applicable in the dev server.\r\n![Screenshot (21)](https://github.com/oppia/oppia/assets/92575005/401430c0-aed0-4787-9b34-4354f161b659)\r\n\r\n\n\nThanks @masterboy376  -- I'll wait to see your backend test.\r\n\r\nFor the validation error analysis: just to check, when we load the dummy data, does it not end up in a \"published\" state? If not, then your explanation seems reasonable. But if it is, then my question stands: on the (automatic) publication why doesn't the publication fail?\r\n\r\nFor your questions:\r\n1. What's the empty topic used for?\r\n2. This is a bit weird and might be a bug. The uploaded image should satisfy all the guidelines given. But I think the person who implemented the inline warning in the \"Drag an image into this area\" section might not have seen this modal. If you get a chance, could you please find which PR did that (perhaps using git blame) so that I can advise on what to do here? Thanks!\n\n@seanlip ,\r\nAs per current implementation, upon loading dummy data, dummy topics do not end up in \"published\" state.\r\n\r\nFor questions:\r\n\r\n1. \"Empty topic\" is the name of one of the dummy topics generated. \"Empty topic\" is similar to other topics generated on loading dummy data. I suggest changing its name to \"Dummy Topic 2\" to make it more reasonable.\r\n2. I will find PR thet might have been caused this bug shortly.\n\nOK thanks. One question then. Should those topics end up in a \"published\" state, do you think?\r\n\r\n1. Hm, I think it's OK to just delete \"Empty topic\" TBH. If the dev wants a new topic they can easily create it. Let's optimize so that the final state of things is easy for devs to use.\r\n2. Sounds good, please let me know when you do that.\r\n\r\nAlso noting here that this is still waiting on the backend test (so it doesn't get lost in the comments above). \n\nHello @seanlip ,\r\nFor the backend testing part I made following changes to [test_load_new_structures_data](https://github.com/oppia/oppia/blob/6171792008266ad07826564316712b4b7b10eb61/core/controllers/admin_test.py#L537C1-L537C1) function in admin_test.py file:\r\n![Screenshot (23)](https://github.com/oppia/oppia/assets/92575005/effd1af1-6c09-4f29-904a-fa2d7e1232ea)\r\nthese changes successfully tests for all the possible validation errors:\r\n![Screenshot (24)](https://github.com/oppia/oppia/assets/92575005/5f54658b-b89e-4124-bdbc-fbf87ee63b99)\r\nI would appreciate any valuable suggestions.\r\n\r\nI think the generated topics, through load dummy data button, should not end up in \"published\" state. There is an existing functionality serving that purpose:\r\n![Screenshot (25)](https://github.com/oppia/oppia/assets/92575005/b0736797-b178-4e76-bcee-01d98c269154)\r\n\r\nAlso, I think it would be best to leave to \"Empty topic as it is\" because its already mentioned to the user that the load dummy data will load 2 topics (one of which will be Empty). So, I will wait for your confirmation on this one to make changes.\r\n![Screenshot (26)](https://github.com/oppia/oppia/assets/92575005/e669e6e3-13da-41d0-92a9-8287ec9dc4eb)\r\n\r\nI believe [this commit](https://github.com/oppia/oppia/commit/77d2c9e84e281ca32da9ebfab246270da8293470) from [this PR](https://github.com/oppia/oppia/pull/12667) cause the bug in thumbnail uploader modal.\r\nTo solve this bug we have to change image-uploader component. I believe it is as a much larger issue because there are different components that use the same image uploader, and all these components have there own criteria for allowed image format. If you allow I can create a separate issue and a PR for this one (As I have already figured out the possible way of solving this one).\r\n\r\nCan I create PR for this issue now?\n\nHello @seanlip ,\r\nWhile browsing the codebase I found that someone has made some changes to Dummy Topic 1 in this [commit ](https://github.com/oppia/oppia/commit/6171792008266ad07826564316712b4b7b10eb61) so it partially passes the validation checks and still there is no backend test for the same.\r\nAlso after this commit we are unable to open the subtopic editor :\r\n![Screenshot (45)](https://github.com/oppia/oppia/assets/92575005/6f38b404-4020-453c-aabe-963136a6d76e)\r\nthis is because the implementation in this commit does not add a subtopic to the dummy topic. In my implementation I have fixed this error using topic_id_1.add_subtopic() function.\r\nIf you allow then I can proceed with the PR which solves the above issue completely.\n\n@masterboy376 Thanks. Let's clean things up a bit:\r\n\r\n1. It is fine to clean up the empty topic and update the admin page message accordingly.\r\n2. Let's publish the generated topics. I don't see any harm in doing that. If the developer wants to create unpublished topics subsequently, they can do so manually.\r\n3. For the backend test, I wouldn't put all the individual validations in admin_test.py. I think publishing the topics (as mentioned in point 2 above) might solve it because a validation step runs, so it might get tested automatically if you do that step and just load the dummy data in tests. If/When you create a PR for this issue, then please demonstrate in the opening description that, if you change the dummy data to something invalid, then the backend test fails.\r\n4. Thanks for finding the old PR. I think that's not actually the issue -- there was probably a PR that changed the error message in the bottom-left yellow box. Can you find it? I think it is also OK to file a new issue to fix that.\r\n5. For the PR that broke the subtopic editor -- I don't quite understand what you mean. If there are no subtopics in the topic then how does a user get to the page with the error?\r\n\r\nIf you can respond with the answers to (4) and (5) (and file a clear issue for point 4), then I'd be happy to assign you to this issue. Thanks!\n\n@seanlip Thank you for your remarks:\r\n\r\n1. Point 1, 2, 3 are done as suggested.\r\n2.  Point 4: I think the PR that changed the error message in the bottom-left yellow box is [Fix #17711: Add Image Upload Prerequisites (#19194)](https://github.com/oppia/oppia/commit/5e8738af4a8daf0a02ecc7f22e36fbf8cb898816).\r\n3. Point 5: I apologies if the previous comment was not clear. I meant to say that the PR I referred to earlier added a subtopic to \"subtopics\" array property of \"Dummy Topic 1\" without using the proper function to do that, which is \"add_subtopic()\"function which properly creates a default subtopic associated with a topic, current Implementation broke the subtopic editor due to this reason. The same issue can also be seen in the topics generated by \"generate_dummy_classroom\" button.\r\nCurrent Implementation:\r\n![Screenshot (54)](https://github.com/oppia/oppia/assets/92575005/bb8de485-b08e-4bef-8f2b-a9a15d5ea45e)\r\nSuggested Implementation:\r\n![Screenshot (53)](https://github.com/oppia/oppia/assets/92575005/eb8fc400-c183-4a82-b145-ab3cdd16a700)\r\nThe suggested Implementation fixes the subtopic editor.\r\n\n\nGreat -- you are correct re (4). /cc @AFZL210 so that he's aware of the breakage here. Can you please file the new issue?\r\n\r\nFor (5), ok sounds good, you might as well just fix it I think.\r\n\r\nPlease file the issue mentioned above and then link it here, then I'll assign you to this. Thanks!\n\n@seanlip Thankyou,\r\nI created the following [Issue](https://github.com/oppia/oppia/issues/19424) Please take a look and suggest any changes if any.\n\nThanks! Looks good, assigned you :)\n\nThank you @seanlip for assigning me this issue I will make a pull request within a day.",
  "pr_link": "https://github.com/oppia/oppia/pull/12667",
  "code_context": [
    {
      "filename": "core/templates/components/entity-creation-services/topic-creation.service.ts",
      "content": "// Copyright 2018 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Modal and functionality for the create topic button.\n */\n\nrequire(\n  'components/forms/custom-forms-directives/select2-dropdown.directive.ts');\nrequire(\n  'components/forms/custom-forms-directives/thumbnail-uploader.component.ts');\nrequire('domain/topic/topic-update.service.ts');\nrequire('domain/utilities/url-interpolation.service.ts');\nrequire('domain/topic/topic-creation-backend-api.service.ts');\nrequire('pages/topic-editor-page/services/topic-editor-state.service.ts');\nrequire(\n  'domain/topics_and_skills_dashboard/' +\n  'topics-and-skills-dashboard-backend-api.service.ts');\nrequire(\n  'pages/topics-and-skills-dashboard-page/' +\n    'create-new-topic-modal.controller.ts');\nrequire('services/alerts.service.ts');\nrequire('services/context.service.ts');\nrequire('services/image-local-storage.service.ts');\nrequire('services/image-upload-helper.service.ts');\n\nangular.module('oppia').factory('TopicCreationService', [\n  '$uibModal', '$window', 'AlertsService', 'ContextService',\n  'ImageLocalStorageService', 'TopicCreationBackendApiService',\n  'TopicsAndSkillsDashboardBackendApiService', 'UrlInterpolationService',\n  function(\n      $uibModal, $window, AlertsService, ContextService,\n      ImageLocalStorageService, TopicCreationBackendApiService,\n      TopicsAndSkillsDashboardBackendApiService, UrlInterpolationService) {\n    var TOPIC_EDITOR_URL_TEMPLATE = '/topic_editor/<topic_id>';\n    var topicCreationInProgress = false;\n\n    return {\n      createNewTopic: function() {\n        if (topicCreationInProgress) {\n          return;\n        }\n        ContextService.setImageSaveDestinationToLocalStorage();\n        $uibModal.open({\n          templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n            '/pages/topics-and-skills-dashboard-page/templates/' +\n            'create-new-topic-modal.template.html'),\n          backdrop: 'static',\n          windowClass: 'create-new-topic',\n          controller: 'CreateNewTopicModalController'\n        }).result.then(function(newlyCreatedTopic) {\n          if (!newlyCreatedTopic.isValid()) {\n            throw new Error('Topic fields cannot be empty');\n          }\n          topicCreationInProgress = true;\n          AlertsService.clearWarnings();\n          // $window.open has to be initialized separately since if the 'open\n          // new tab' action does not directly result from a user input (which\n          // is not the case, if we wait for result from the backend before\n          // opening a new tab), some browsers block it as a popup. Here, the\n          // new tab is created as soon as the user clicks the 'Create' button\n          // and filled with URL once the details are fetched from the backend.\n          var newTab = $window.open();\n          var imagesData = ImageLocalStorageService.getStoredImagesData();\n          var bgColor = ImageLocalStorageService.getThumbnailBgColor();\n          TopicCreationBackendApiService.createTopicAsync(\n            newlyCreatedTopic, imagesData, bgColor).then(\n            function(response) {\n              TopicsAndSkillsDashboardBackendApiService.\n                onTopicsAndSkillsDashboardReinitialized.emit();\n              topicCreationInProgress = false;\n              ImageLocalStorageService.flushStoredImagesData();\n              ContextService.resetImageSaveDestination();\n              newTab.location.href = UrlInterpolationService.interpolateUrl(\n                TOPIC_EDITOR_URL_TEMPLATE, {\n                  topic_id: response.topicId\n                });\n            }, function(errorResponse) {\n              newTab.close();\n              topicCreationInProgress = false;\n              AlertsService.addWarning(errorResponse.error);\n            });\n        }, function() {\n          // Note to developers:\n          // This callback is triggered when the Cancel button is\n          // clicked. No further action is needed.\n        });\n      }\n    };\n  }\n]);\n"
    },
    {
      "filename": "core/templates/components/forms/custom-forms-directives/edit-thumbnail-modal.component.html",
      "content": "<div class=\"oppia-edit-thumbnail-container\">\n  <div class=\"modal-header\">\n    <h3>Upload Thumbnail</h3>\n  </div>\n\n  <div class=\"modal-body oppia-thumbnail-uploader-container\">\n    <div class=\"oppia-thumbnail-uploader\">\n      <div [hidden]=\"uploadedImage\">\n        <strong>Please upload an SVG image.</strong>\n        <div class=\"alert alert-warning\">\n          <span>Here are some guidelines to follow:</span>\n          <ul>\n            <li>Uploaded image should have an aspect ratio of {{ aspectRatio }}.</li>\n            <li>Uploaded image should have a transparent background.</li>\n            <li>Please ensure that the uploaded image is less than 100 KB.</li>\n          </ul>\n        </div>\n        <oppia-image-uploader (fileChanged)=\"onFileChanged($event)\"\n                              [allowedImageFormats]=\"allowedImageFormats\">\n        </oppia-image-uploader>\n      </div>\n      <div class=\"oppia-form-error\" *ngIf=\"invalidImageWarningIsShown\">\n        Please upload a valid SVG image.\n      </div>\n      <div class=\"oppia-form-error\" *ngIf=\"invalidTagsAndAttributes?.tags.length\">\n        Unsupported SVG tags found: {{ invalidTagsAndAttributes.tags }}\n      </div>\n      <div class=\"oppia-form-error\" *ngIf=\"invalidTagsAndAttributes?.attrs.length\">\n        Unsupported SVG attributes found: {{ invalidTagsAndAttributes.attrs }}\n      </div>\n      <div [hidden]=\"!uploadedImage\">\n        <div [hidden]=\"!allowedBgColors\">\n          <div [hidden]=\"!(allowedBgColors.length > 1)\">Choose background color:</div>\n          <div [hidden]=\"!(allowedBgColors.length > 1)\" class=\"oppia-thumbnail-colour-select\">\n            <div *ngFor=\"let color of allowedBgColors\"\n                 [ngStyle]=\"{'background': color}\"\n                 (click)=\"updateBackgroundColor(color)\">\n            </div>\n          </div>\n          <div [hidden]=\"!(allowedBgColors.length === 1)\" class=\"alert alert-warning\">\n            <span>\n              Please check that the thumbnail below has the following background color:\n              <i class=\"fa fa-square\" [ngStyle]=\"{'color': allowedBgColors[0]}\"></i>.\n              If not, please ensure that you are uploading an image with transparent background. Thanks!\n            </span>\n          </div>\n        </div>\n        <div @fade class=\"oppia-thumbnail-container protractor-test-thumbnail-container\" *ngIf=\"uploadedImage\"\n             [ngStyle]=\"{'background': previewDescriptionBgColor, 'color': previewDescriptionBgColor ? '#FFFFFF' : '', 'width': aspectRatio === '4:3' ? '248px' : '320px' }\">\n          <button class=\"btn btn-secondary oppia-thumbnail-reset-button protractor-thumbnail-reset-button\" (click)=\"reset()\">\n            <i class=\"material-icons oppia-vcenter\">&#xE14C;</i>\n          </button>\n          <div>\n            <oppia-thumbnail-display *ngIf=\"uploadedImage\"\n                                     [classes]=\"['oppia-thumbnail-image']\"\n                                     [imgSrc]=\"uploadedImage\"\n                                     [aspectRatio]=\"'16:9'\"\n                                     [background]=\"bgColor\">\n            </oppia-thumbnail-display>\n            <div class=\"oppia-thumbnail-preview-title\">\n              {{ previewTitle }}\n            </div>\n            <div class=\"oppia-thumbnail-preview-description\">\n              {{ previewDescription }}\n            </div>\n            <div *ngIf=\"previewFooter\" class=\"oppia-thumbnail-preview-footer\">\n              {{ previewFooter }}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"modal-footer\">\n    <button class=\"btn btn-secondary\" (click)=\"cancel()\" [innerHTML]=\"'I18N_MODAL_CANCEL_BUTTON' | translate\"></button>\n    <button class=\"btn btn-success protractor-test-photo-upload-submit\"\n            (click)=\"confirm()\"\n            [disabled]=\"!uploadedImage\">\n      Add Thumbnail\n    </button>\n  </div>\n</div>\n<style>\n  .oppia-thumbnail-container {\n    border-radius: 4px 4px 4px 4px;\n    box-shadow: 0 4.5px 10px rgba(0, 0, 0, 0.25);\n    height: 260px;\n    margin: 0 auto 15px auto;\n    max-width: 100%;\n    position: relative;\n  }\n  .oppia-thumbnail-container img {\n    border-radius: 4px 4px 0 0;\n  }\n  .oppia-thumbnail-reset-button {\n    position: absolute;\n    right: -50px;\n    top: 0;\n  }\n  .oppia-thumbnail-uploader {\n    word-break: break-word;\n  }\n  .oppia-thumbnail-confirm-button {\n    position: absolute;\n    right: -50px;\n    top: 40px;\n  }\n  .oppia-thumbnail-colour-select {\n    display: grid;\n    grid-gap: 5px;\n    grid-template-columns: 25px 25px 25px 25px;\n    grid-template-rows: 20px;\n    margin-bottom: 7px;\n  }\n\n  .oppia-thumbnail-colour-select > * {\n    border: 1px solid;\n    border-radius: 10%\n  }\n\n  .oppia-thumbnail-colour-select > *:hover,\n  .oppia-thumbnail-colour-select > *:focus {\n    border: 2px solid;\n    cursor: pointer;\n  }\n  .oppia-thumbnail-preview-description {\n    font-size: 16px;\n    line-height: 1.2;\n    overflow: hidden;\n    padding: 0 16px 0 16px;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .oppia-thumbnail-preview-footer {\n    bottom: 10px;\n    font-size: 16px;\n    font-style: italic;\n    line-height: 1.2;\n    padding: 0 16px 0 16px;\n    position: absolute;\n  }\n  .oppia-thumbnail-preview-title {\n    font-size: 18px;\n    font-weight: bold;\n    overflow: hidden;\n    padding: 10px 16px 10px 16px;\n    text-align: left;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .oppia-thumbnail-uploader-container {\n    min-height: 300px;\n  }\n  .oppia-form-error {\n    margin-top: 15px;\n    word-break: break-word;\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/components/forms/custom-forms-directives/edit-thumbnail-modal.component.spec.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Unit tests for Edit Thumbnail Modal Component.\n */\n\nimport { HttpClientTestingModule } from '@angular/common/http/testing';\nimport { ComponentFixture, TestBed, waitForAsync } from '@angular/core/testing';\nimport { EditThumbnailModalComponent } from './edit-thumbnail-modal.component';\nimport { NgbActiveModal } from '@ng-bootstrap/ng-bootstrap';\nimport { NO_ERRORS_SCHEMA, Pipe } from '@angular/core';\nimport { SvgSanitizerService } from 'services/svg-sanitizer.service';\n\n@Pipe({name: 'translate'})\nclass MockTranslatePipe {\n  transform(value: string): string {\n    return value;\n  }\n}\n\nclass MockActiveModal {\n  dismiss(): void {\n    return;\n  }\n\n  close(): void {\n    return;\n  }\n}\n\ndescribe('Edit Thumbnail Modal Component', () => {\n  let component: EditThumbnailModalComponent;\n  let fixture: ComponentFixture<EditThumbnailModalComponent>;\n  let ngbActiveModal: NgbActiveModal;\n  let closeSpy: jasmine.Spy;\n  let dismissSpy: jasmine.Spy;\n\n  class MockReaderObject {\n    result = null;\n    onload = null;\n    constructor() {\n      this.onload = () => {\n        return 'Fake onload executed';\n      };\n    }\n    readAsDataURL(file) {\n      this.onload();\n      return 'The file is loaded';\n    }\n  }\n\n  class MockImageObject {\n    source = null;\n    onload = null;\n    constructor() {\n      this.onload = () => {\n        return 'Fake onload executed';\n      };\n    }\n    set src(url) {\n      this.onload();\n    }\n  }\n\n  let mockSvgSanitizerService = {\n    getInvalidSvgTagsAndAttrsFromDataUri: (dataUri) => {\n      return { tags: ['script'], attrs: [] };\n    },\n  };\n\n  beforeEach(waitForAsync(() => {\n    TestBed.configureTestingModule({\n      imports: [HttpClientTestingModule],\n      declarations: [\n        EditThumbnailModalComponent,\n        MockTranslatePipe\n      ],\n      providers: [\n        {\n          provide: NgbActiveModal,\n          useClass: MockActiveModal\n        },\n        {\n          provide: SvgSanitizerService,\n          useValue: mockSvgSanitizerService\n        }\n      ],\n      schemas: [NO_ERRORS_SCHEMA]\n    }).compileComponents();\n    fixture = TestBed.createComponent(EditThumbnailModalComponent);\n    component = fixture.componentInstance;\n    ngbActiveModal = TestBed.inject(NgbActiveModal);\n    closeSpy = spyOn(ngbActiveModal, 'close').and.callThrough();\n    dismissSpy = spyOn(ngbActiveModal, 'dismiss').and.callThrough();\n    // This throws \"Argument of type 'mockImageObject' is not assignable to\n    // parameter of type 'HTMLImageElement'.\". We need to suppress this\n    // error because 'HTMLImageElement' has around 250 more properties.\n    // We have only defined the properties we need in 'mockImageObject'.\n    // @ts-expect-error\n    spyOn(window, 'Image').and.returnValue(new MockImageObject());\n    // This throws \"Argument of type 'mockReaderObject' is not assignable to\n    // parameter of type 'HTMLImageElement'.\". We need to suppress this\n    // error because 'HTMLImageElement' has around 250 more properties.\n    // We have only defined the properties we need in 'mockReaderObject'.\n    // @ts-expect-error\n    spyOn(window, 'FileReader').and.returnValue(new MockReaderObject());\n    spyOn(component, 'updateBackgroundColor').and.callThrough();\n    spyOn(component, 'setImageDimensions').and.callThrough();\n  }));\n\n  it('should load a image file in onchange event and save it if it\\'s a' +\n    ' svg file', () => {\n    spyOn(component, 'isUploadedImageSvg').and.returnValue(true);\n    const resetSpy = spyOn(component, 'reset').and.callThrough();\n    let fileContent = (\n      'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjA' +\n      'wMC9zdmciICB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PGNpcmNsZSBjeD0iNTAiIGN5' +\n      'PSI1MCIgcj0iNDAiIHN0cm9rZT0iZ3JlZW4iIHN0cm9rZS13aWR0aD0iNCIgZmlsbD0ie' +\n      'WVsbG93IiAvPjwvc3ZnPg==');\n    let file = new File([fileContent], 'circle.svg', {type: 'image/svg'});\n    component.invalidImageWarningIsShown = false;\n    component.uploadedImageMimeType = 'image/svg+xml';\n    component.imgSrc = 'source';\n\n    component.onFileChanged(file);\n    expect(component.invalidImageWarningIsShown).toBe(false);\n    expect(component.tags).toEqual(['script']);\n    expect(component.attrs).toEqual([]);\n    expect(resetSpy).toHaveBeenCalled();\n  });\n\n  it('should not load file if it is not a svg type', () => {\n    spyOn(component, 'isUploadedImageSvg').and.returnValue(false);\n    expect(component.invalidImageWarningIsShown).toBe(false);\n    // This is just a mocked base 64 in order to test the FileReader event\n    // and its result property.\n    const dataBase64Mock = 'PHN2ZyB4bWxucz0iaHR0cDo';\n    const arrayBuffer = Uint8Array.from(\n      window.atob(dataBase64Mock), c => c.charCodeAt(0));\n    const file = new File([arrayBuffer], 'thumbnail.png');\n\n    component.onFileChanged(file);\n\n    expect(component.uploadedImage).toBeNull();\n    expect(component.invalidImageWarningIsShown).toBeTrue();\n  });\n\n  it('should update bgColor on initialization of modal', () => {\n    component.bgColor = '#FFFFFF';\n    component.ngOnInit();\n    expect(component.updateBackgroundColor).toHaveBeenCalled();\n  });\n\n  it('should check for uploaded image to be svg', () => {\n    component.uploadedImageMimeType = 'image/svg+xml';\n    let result = component.isUploadedImageSvg();\n    expect(result).toBeTrue();\n  });\n\n  it('should set image dimensions', () => {\n    component.dimensions = {\n      height: 0,\n      width: 0\n    };\n    component.setImageDimensions(180, 180);\n    expect(component.dimensions).toEqual({ height: 180, width: 180 });\n  });\n\n  it('should reset the uploaded image on clicking reset button', () => {\n    component.reset();\n    expect(component.uploadedImage).toBeNull();\n    expect(component.openInUploadMode).toBeTrue();\n  });\n\n  it('should reset the uploaded Image and show a warning', () => {\n    component.onInvalidImageLoaded();\n    expect(component.uploadedImage).toBeNull();\n    expect(component.invalidImageWarningIsShown).toBeTrue();\n  });\n\n  it('should close the modal when clicking on Add Thumbnail Button', () => {\n    component.uploadedImage = 'uploaded_img.svg';\n    component.bgColor = '#fff';\n    component.openInUploadMode = false;\n    component.dimensions = {\n      height: 180,\n      width: 180\n    };\n    component.confirm();\n    expect(closeSpy).toHaveBeenCalledWith({\n      newThumbnailDataUrl: 'uploaded_img.svg',\n      newBgColor: '#fff',\n      openInUploadMode: false,\n      dimensions: {\n        height: 180,\n        width: 180\n      }\n    });\n  });\n\n  it('should close the modal on clicking cancel button', () => {\n    component.cancel();\n    expect(dismissSpy).toHaveBeenCalled();\n  });\n});\n"
    },
    {
      "filename": "core/templates/components/forms/custom-forms-directives/edit-thumbnail-modal.component.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Component for edit thumbnail modal.\n */\n\nimport { trigger, transition, style, animate } from '@angular/animations';\nimport { Component, Input, OnInit } from '@angular/core';\nimport { NgbActiveModal } from '@ng-bootstrap/ng-bootstrap';\nimport { SvgSanitizerService } from 'services/svg-sanitizer.service';\n\ninterface InvalidTagsAndAttributes {\n  tags: string[];\n  attrs: string[];\n}\n\n@Component({\n  selector: 'edit-thumbnail-modal',\n  templateUrl: './edit-thumbnail-modal.component.html',\n  animations: [\n    trigger('fade', [\n      transition('void => *', [\n        style({opacity: 0}),\n        animate(500, style({opacity: 1}))\n      ])\n    ])\n  ]\n})\nexport class EditThumbnailModalComponent implements OnInit {\n  @Input() bgColor: string;\n  @Input() uploadedImage: string | null;\n  @Input() aspectRatio: string;\n  @Input() previewDescription: string;\n  @Input() previewDescriptionBgColor: string;\n  @Input() previewFooter: string;\n  @Input() previewTitle: string;\n  @Input() allowedBgColors: string[];\n  @Input() tempBgColor: string;\n  @Input() dimensions: { height: number; width: number; };\n  @Input() openInUploadMode: boolean;\n  @Input() uploadedImageMimeType: string;\n\n  invalidImageWarningIsShown = false;\n  allowedImageFormats = ['svg'];\n  file: Blob;\n  tags: string[];\n  attrs: string[];\n  imgSrc: string;\n  invalidTagsAndAttributes: InvalidTagsAndAttributes;\n\n  constructor(\n    private svgSanitizerService: SvgSanitizerService,\n    private ngbActiveModal: NgbActiveModal,\n  ) {}\n\n  ngOnInit(): void {\n    this.updateBackgroundColor(this.bgColor);\n  }\n\n  setImageDimensions(height: number, width: number): void {\n    this.dimensions = {\n      height: Math.round(height),\n      width: Math.round(width)\n    };\n  }\n\n  isUploadedImageSvg(): boolean {\n    return this.uploadedImageMimeType === 'image/svg+xml';\n  }\n\n  updateBackgroundColor(color: string): void {\n    this.bgColor = color;\n  }\n\n  setUploadedFile(file: File): void {\n    const reader = new FileReader();\n    reader.onload = () => {\n      const img = new Image();\n      img.onload = () => {\n        //   Setting a default height of 300px and width of\n        //   150px since most browsers use these dimensions\n        //   for SVG files that do not have an explicit\n        //   height and width defined.\n        this.setImageDimensions(\n          img.naturalHeight || 150,\n          img.naturalWidth || 300);\n      };\n      this.imgSrc = <string>reader.result;\n      this.updateBackgroundColor(this.tempBgColor);\n      img.src = this.imgSrc;\n      this.uploadedImage = this.imgSrc;\n      this.invalidTagsAndAttributes = (\n        this.svgSanitizerService.getInvalidSvgTagsAndAttrsFromDataUri(\n          this.imgSrc));\n      this.tags = this.invalidTagsAndAttributes.tags;\n      this.attrs = this.invalidTagsAndAttributes.attrs;\n      if (this.tags.length > 0 || this.attrs.length > 0) {\n        this.reset();\n      }\n    };\n    reader.readAsDataURL(file);\n  }\n\n  onFileChanged(file: File): void {\n    this.uploadedImageMimeType = file.type;\n    this.invalidImageWarningIsShown = false;\n    this.invalidTagsAndAttributes = {\n      tags: [],\n      attrs: []\n    };\n    if (this.isUploadedImageSvg()) {\n      this.setUploadedFile(file);\n    } else {\n      this.reset();\n      this.invalidImageWarningIsShown = true;\n    }\n  }\n\n  reset(): void {\n    this.uploadedImage = null;\n    this.openInUploadMode = true;\n  }\n\n  onInvalidImageLoaded(): void {\n    this.uploadedImage = null;\n    this.invalidImageWarningIsShown = true;\n  }\n\n  confirm(): void {\n    this.ngbActiveModal.close({\n      newThumbnailDataUrl: this.uploadedImage,\n      newBgColor: this.bgColor,\n      openInUploadMode: this.openInUploadMode,\n      dimensions: this.dimensions\n    });\n  }\n\n  cancel(): void {\n    this.ngbActiveModal.dismiss();\n  }\n}\n"
    },
    {
      "filename": "core/templates/components/forms/custom-forms-directives/thumbnail-display.component.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Component for thumbnail display.\n */\n\nimport { Component, Input, OnChanges, OnInit } from '@angular/core';\nimport { downgradeComponent } from '@angular/upgrade/static';\n\nimport { SvgSanitizerService } from 'services/svg-sanitizer.service';\n\n@Component({\n  selector: 'oppia-thumbnail-display',\n  templateUrl: './thumbnail-display.component.html',\n  styleUrls: []\n})\nexport class ThumbnailDisplayComponent implements OnInit, OnChanges {\n  constructor(private svgSanitizerService: SvgSanitizerService) {}\n  @Input() imgSrc: string;\n  @Input() aspectRatio: string;\n  @Input() classes: string[];\n  @Input() background: string;\n  imageSourceInView = null;\n  height = '180px';\n  width = '320px';\n  ngOnInit(): void {\n    if (this.imgSrc !== undefined) {\n      this.updateSvgInViewIfSafe();\n    }\n  }\n\n  /**\n   * Update the SVG data if the SVG  given is valid.\n   */\n  updateSvgInViewIfSafe(): void {\n    // If the SVG image is passed as base64 data.\n    if (this.imgSrc.indexOf('data:image/svg+xml;base64') === 0) {\n      const safeResourceUrl = this.svgSanitizerService.getTrustedSvgResourceUrl(\n        this.imgSrc);\n      if (safeResourceUrl !== null) {\n        this.imageSourceInView = safeResourceUrl;\n      }\n    } else {\n      this.imageSourceInView = this.imgSrc;\n    }\n    this.width = this.aspectRatio === '4:3' ? '248px' : '320px';\n    this.height = this.aspectRatio === '4:3' ? '100px' : '180px';\n  }\n\n  ngOnChanges(): void {\n    if (this.imgSrc !== undefined) {\n      this.updateSvgInViewIfSafe();\n      this.width = this.aspectRatio === '4:3' ? '248px' : '320px';\n      this.height = this.aspectRatio === '4:3' ? '100px' : '180px';\n    }\n  }\n}\n\nangular.module('oppia').directive(\n  'oppiaThumbnailDisplay', downgradeComponent(\n    {component: ThumbnailDisplayComponent}));\n"
    },
    {
      "filename": "core/templates/components/forms/custom-forms-directives/thumbnail-uploader.component.html",
      "content": "<div class=\"thumbnail-editor form-group\">\n  <div>\n    <div class=\"oppia-editable-section float-left\" title=\"Change Thumbnail\"\n         [ngStyle]=\"{background: bgColor}\">\n      <div class=\"oppia-click-to-start-editing protractor-test-photo-button\"\n           (click)=\"showEditThumbnailModal()\"\n           aria-label=\"upload or edit thumbnail\">\n      </div>\n      <i class=\"material-icons oppia-editor-edit-icon oppia-pencil-icon\">\n        &#xE254;\n      </i>\n      <img [hidden]=\"!hidePlaceholder\" [src]=\"placeholderImageUrl\" align=\"center\" class=\"oppia-thumbnail-placeholder\" alt=\"\">\n      <oppia-thumbnail-display *ngIf=\"editableThumbnailDataUrl\"\n                               [hidden]=\"!thumbnailIsLoading\"\n                               [imgSrc]=\"editableThumbnailDataUrl\"\n                               [aspectRatio]=\"aspectRatio\"\n                               [classes]=\"['img-thumbnail', 'protractor-test-custom-photo']\"\n                               [background]=\"bgColor\">\n      </oppia-thumbnail-display>\n      <oppia-thumbnail-display *ngIf=\"useLocalStorage && newThumbnailDataUrl\"\n                               [imgSrc]=\"newThumbnailDataUrl\"\n                               [aspectRatio]=\"aspectRatio\"\n                               [classes]=\"['img-thumbnail', 'protractor-test-custom-photo']\"\n                               [background]=\"localStorageBgcolor\">\n      </oppia-thumbnail-display>\n    </div>\n  </div>\n</div>\n\n<style>\n  .oppia-thumbnail-placeholder {\n    height: 120px;\n    width: 120px;\n  }\n\n  .thumbnail-editor {\n    height: 100px;\n  }\n\n  .oppia-editable-section {\n    border-radius: 0.25rem;\n    display: table-cell;\n    height: 100px;\n    text-align: center;\n    vertical-align: middle;\n    width: 180px;\n  }\n\n  .img-thumbnail {\n    border: none;\n    max-height: 100%;\n    max-width: 100%;\n  }\n\n  .oppia-pencil-icon {\n    right: 8px;\n    top: 8px;\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/components/forms/custom-forms-directives/thumbnail-uploader.component.ts",
      "content": "// Copyright 2016 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Component for uploading images.\n */\n\nimport { EventEmitter, OnInit, Output } from '@angular/core';\nimport { OnChanges, SimpleChanges } from '@angular/core';\nimport { Component, Input } from '@angular/core';\nimport { downgradeComponent } from '@angular/upgrade/static';\nimport { NgbModal } from '@ng-bootstrap/ng-bootstrap';\nimport { UrlInterpolationService } from 'domain/utilities/url-interpolation.service';\nimport { AlertsService } from 'services/alerts.service';\nimport { AssetsBackendApiService } from 'services/assets-backend-api.service';\nimport { ContextService } from 'services/context.service';\nimport { ImageLocalStorageService } from 'services/image-local-storage.service';\nimport { ImageUploadHelperService } from 'services/image-upload-helper.service';\nimport { EditThumbnailModalComponent } from './edit-thumbnail-modal.component';\n\n@Component({\n  selector: 'oppia-thumbnail-uploader',\n  templateUrl: './thumbnail-uploader.component.html'\n})\nexport class ThumbnailUploaderComponent implements OnInit, OnChanges {\n  @Input() disabled: boolean;\n  @Input() useLocalStorage: boolean;\n  @Input() allowedBgColors: string[];\n  @Input() aspectRatio: string;\n  @Input() bgColor: string;\n  @Input() filename: string;\n  @Input() previewDescription: string;\n  @Input() previewDescriptionBgColor: string;\n  @Input() previewFooter: string;\n  @Input() previewTitle: string;\n  @Output() updateBgColor: EventEmitter<string> = new EventEmitter() ;\n  @Output() updateFilename: EventEmitter<string> = new EventEmitter();\n  @Output() imageSave: EventEmitter<void> = new EventEmitter();\n  openInUploadMode: boolean;\n  tempBgColor: string;\n  tempImageName: string;\n  uploadedImage: string;\n  uploadedImageMimeType: string;\n  dimensions: { height: number; width: number; };\n  resampledFile: Blob;\n  newThumbnailDataUrl: string;\n  localStorageBgcolor: string;\n  imageUploadUrlTemplate: string;\n  hidePlaceholder = true;\n  placeholderImageUrl = (\n    this.urlInterpolationService.getStaticImageUrl(\n      '/icons/story-image-icon.png'));\n  editableThumbnailDataUrl: string;\n  transformedData: string;\n  parsedResponse;\n  encodedImageURI: string;\n\n  constructor(\n    private imageUploadHelperService: ImageUploadHelperService,\n    private alertsService: AlertsService,\n    private contextService: ContextService,\n    private imageLocalStorageService: ImageLocalStorageService,\n    private ngbModal: NgbModal,\n    private urlInterpolationService: UrlInterpolationService,\n    private assetsBackendApiService: AssetsBackendApiService\n  ) {}\n  placeholderImageDataUrl = (\n    this.urlInterpolationService.getStaticImageUrl(\n      '/icons/story-image-icon.png'));\n  thumbnailIsLoading = true;\n\n  ngOnInit(): void {\n    if (this.filename !== null &&\n        this.filename !== undefined &&\n        this.filename !== '') {\n      this.hidePlaceholder = false;\n      this.editableThumbnailDataUrl = (\n        this.imageUploadHelperService.getTrustedResourceUrlForThumbnailFilename(\n          this.filename,\n          this.contextService.getEntityType(),\n          this.contextService.getEntityId()));\n      this.uploadedImage = this.editableThumbnailDataUrl;\n    }\n  }\n\n  // 'ngOnChanges' is required here to update the thumbnail image\n  // everytime the thumbnail filename changes (eg. draft is discarded).\n  // The trusted resource url for the thumbnail should not be directly\n  // bound to ngSrc because it can cause an infinite digest error.\n  // This watcher is triggered only if the thumbnail filename of the\n  // model changes. It would change for the following operations:\n  // 1. Initial render of the page containing this directive.\n  // 2. When a thumbnail is uploaded.\n  // 3. When a saved draft is discarded.\n  ngOnChanges(changes: SimpleChanges): void {\n    if (\n      changes.filename &&\n      changes.filename.currentValue !== changes.filename.previousValue) {\n      const newValue = changes.filename.currentValue;\n      const previousValue = changes.filename.previousValue;\n      this.filenameChanges(newValue, previousValue);\n    }\n  }\n\n  filenameChanges(newFilename: string, prevFilename: string): void {\n    if (newFilename) {\n      this.editableThumbnailDataUrl = (\n        this.imageUploadHelperService\n          .getTrustedResourceUrlForThumbnailFilename(\n            newFilename,\n            this.contextService.getEntityType(),\n            this.contextService.getEntityId()));\n      this.uploadedImage = this.editableThumbnailDataUrl;\n    }\n    this.thumbnailIsLoading = true;\n    this.hidePlaceholder = false;\n  }\n\n  saveThumbnailBgColor(newBgColor: string): void {\n    if (newBgColor !== this.bgColor) {\n      this.updateBgColor.emit(newBgColor);\n    }\n  }\n\n  saveThumbnailImageData(imageURI: string, callback: () => void): void {\n    this.resampledFile = null;\n    this.resampledFile = (\n      this.imageUploadHelperService.convertImageDataToImageFile(\n        imageURI));\n    this.encodedImageURI = imageURI;\n    if (this.resampledFile === null) {\n      this.alertsService.addWarning('Could not get resampled file.');\n      return;\n    }\n    this.postImageToServer(this.resampledFile, callback);\n  }\n\n  postImageToServer(resampledFile: Blob, callback: () => void): void {\n    let entityType = this.contextService.getEntityType();\n    let entityId = this.contextService.getEntityId();\n    const result = this.assetsBackendApiService.postThumbnailFile(\n      resampledFile, this.tempImageName, entityType, entityId).toPromise();\n    result.then((data) => {\n      this.editableThumbnailDataUrl = (\n        this.imageUploadHelperService\n          .getTrustedResourceUrlForThumbnailFilename(\n            data.filename, this.contextService.getEntityType(),\n            this.contextService.getEntityId()));\n      callback();\n    });\n  }\n\n  showEditThumbnailModal(): void {\n    if (this.disabled) {\n      return;\n    }\n    this.openInUploadMode = true;\n    // This refers to the temporary thumbnail background\n    // color used for preview.\n    this.tempBgColor = (\n      this.bgColor ||\n      this.allowedBgColors[0]);\n    this.tempImageName = '';\n    this.uploadedImageMimeType = '';\n    this.dimensions = {\n      height: 0,\n      width: 0\n    };\n    const modalRef = this.ngbModal.open(\n      EditThumbnailModalComponent,\n      {backdrop: 'static'});\n    modalRef.componentInstance.bgColor = this.tempBgColor;\n    modalRef.componentInstance.allowedBgColors = this.allowedBgColors;\n    modalRef.componentInstance.aspectRatio = this.aspectRatio;\n    modalRef.componentInstance.dimensions = this.dimensions;\n    modalRef.componentInstance.previewDescription =\n     this.previewDescription;\n    modalRef.componentInstance.previewDescriptionBgColor =\n       this.previewDescriptionBgColor;\n    modalRef.componentInstance.previewFooter = this.previewFooter;\n    modalRef.componentInstance.previewTitle = this.previewTitle;\n    modalRef.componentInstance.openInUploadMode = this.openInUploadMode;\n    modalRef.componentInstance.uploadedImage = this.uploadedImage;\n    modalRef.componentInstance.uploadedImageMimeType =\n     this.uploadedImageMimeType;\n    modalRef.componentInstance.tempBgColor = this.tempBgColor;\n\n    modalRef.result.then((data) => {\n      this.thumbnailIsLoading = true;\n      let generatedImageFilename =\n       this.imageUploadHelperService.generateImageFilename(\n         data.dimensions.height, data.dimensions.width, 'svg');\n      this.newThumbnailDataUrl = data.newThumbnailDataUrl;\n      this.hidePlaceholder = false;\n      if (!this.useLocalStorage) {\n        if (data.openInUploadMode) {\n          this.tempImageName = (\n            this.imageUploadHelperService.generateImageFilename(\n              data.dimensions.height, data.dimensions.width, 'svg'));\n          this.saveThumbnailImageData(data.newThumbnailDataUrl, () => {\n            this.uploadedImage = data.newThumbnailDataUrl;\n            this.updateFilename.emit(this.tempImageName);\n            this.saveThumbnailBgColor(data.newBgColor);\n          });\n        } else {\n          this.saveThumbnailBgColor(data.newBgColor);\n          this.thumbnailIsLoading = false;\n        }\n      } else {\n        this.thumbnailIsLoading = false;\n        this.imageLocalStorageService.saveImage(\n          generatedImageFilename, data.newThumbnailDataUrl);\n        this.localStorageBgcolor = data.newBgColor;\n        this.imageLocalStorageService.setThumbnailBgColor(data.newBgColor);\n        this.imageSave.emit();\n      }\n    }, () => {\n      // Note to developers:\n      // This callback is triggered when the Cancel button is clicked.\n      // No further action is needed.\n    });\n  }\n}\n\nangular.module('oppia').directive(\n  'oppiaThumbnailUploader', downgradeComponent(\n    {component: ThumbnailUploaderComponent}));\n"
    },
    {
      "filename": "core/templates/components/shared-component.module.ts",
      "content": "// Copyright 2021 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Module for the shared components.\n */\nimport 'core-js/es7/reflect';\nimport 'zone.js';\n\n// Modules.\nimport { CommonModule } from '@angular/common';\nimport { NgModule } from '@angular/core';\nimport { NgbModalModule, NgbPopoverModule, NgbNavModule, NgbTooltipModule } from '@ng-bootstrap/ng-bootstrap';\nimport { AngularFireModule } from '@angular/fire';\nimport { AngularFireAuth, AngularFireAuthModule, USE_EMULATOR } from '@angular/fire/auth';\nimport { BrowserModule, HAMMER_GESTURE_CONFIG } from '@angular/platform-browser';\nimport { CustomFormsComponentsModule } from './forms/custom-forms-directives/custom-form-components.module';\nimport { DirectivesModule } from 'directives/directives.module';\nimport { DynamicContentModule } from './angular-html-bind/dynamic-content.module';\nimport { FormsModule } from '@angular/forms';\nimport { MaterialModule } from './material.module';\nimport { ObjectComponentsModule } from 'objects/object-components.module';\nimport { SharedPipesModule } from 'filters/shared-pipes.module';\nimport { SharedFormsModule } from './forms/shared-forms.module';\nimport { ToastrModule } from 'ngx-toastr';\nimport { TranslateModule, TranslateLoader, TranslateService, TranslateDefaultParser, TranslateParser, MissingTranslationHandler } from '@ngx-translate/core';\nimport { TranslateCacheModule, TranslateCacheService, TranslateCacheSettings } from 'ngx-translate-cache';\nimport { CommonElementsModule } from './common-layout-directives/common-elements/common-elements.module';\nimport { RichTextComponentsModule } from 'rich_text_components/rich-text-components.module';\nimport { CodeMirrorModule } from './code-mirror/codemirror.module';\nimport { OppiaCkEditor4Module } from './ck-editor-helpers/ckeditor4.module';\n\n\n// Components.\nimport { AudioBarComponent } from 'pages/exploration-player-page/layout-directives/audio-bar.component';\nimport { ExplorationEmbedButtonModalComponent } from './button-directives/exploration-embed-button-modal.component';\nimport { BackgroundBannerComponent } from './common-layout-directives/common-elements/background-banner.component';\nimport { AttributionGuideComponent } from './common-layout-directives/common-elements/attribution-guide.component';\nimport { LazyLoadingComponent } from './common-layout-directives/common-elements/lazy-loading.component';\nimport { KeyboardShortcutHelpModalComponent } from 'components/keyboard-shortcut-help/keyboard-shortcut-help-modal.component';\nimport { StateSkillEditorComponent } from 'components/state-editor/state-skill-editor/state-skill-editor.component';\nimport { SelectSkillModalComponent } from './skill-selector/select-skill-modal.component';\nimport { SharingLinksComponent } from './common-layout-directives/common-elements/sharing-links.component';\nimport { SocialButtonsComponent } from 'components/button-directives/social-buttons.component';\nimport { SkillSelectorComponent } from './skill-selector/skill-selector.component';\nimport { ProfileLinkImageComponent } from 'components/profile-link-directives/profile-link-image.component';\nimport { ProfileLinkTextComponent } from 'components/profile-link-directives/profile-link-text.component';\nimport { AudioFileUploaderComponent } from './forms/custom-forms-directives/audio-file-uploader.component';\nimport { ThumbnailDisplayComponent } from './forms/custom-forms-directives/thumbnail-display.component';\nimport { SkillMasteryViewerComponent } from './skill-mastery/skill-mastery.component';\nimport { ExplorationSummaryTileComponent } from './summary-tile/exploration-summary-tile.component';\nimport { CollectionSummaryTileComponent } from './summary-tile/collection-summary-tile.component';\nimport { TakeBreakModalComponent } from 'pages/exploration-player-page/templates/take-break-modal.component';\nimport { TopicsAndSkillsDashboardNavbarBreadcrumbComponent } from 'pages/topics-and-skills-dashboard-page/navbar/topics-and-skills-dashboard-navbar-breadcrumb.component';\nimport { ThreadTableComponent } from 'pages/exploration-editor-page/feedback-tab/thread-table/thread-table.component';\nimport { SummaryListHeaderComponent } from './state-directives/answer-group-editor/summary-list-header.component';\nimport { LearnerDashboardIconsComponent } from 'pages/learner-dashboard-page/learner-dashboard-icons.component';\nimport { OutcomeFeedbackEditorComponent } from './state-directives/outcome-editor/outcome-feedback-editor.component';\nimport { OnScreenKeyboardComponent } from './on-screen-keyboard/on-screen-keyboard.component';\nimport { OppiaFooterComponent } from '../base-components/oppia-footer.component';\nimport { RubricsEditorComponent } from './rubrics-editor/rubrics-editor.component';\nimport { CreateNewSkillModalComponent } from 'pages/topics-and-skills-dashboard-page/create-new-skill-modal.component';\nimport { PromoBarComponent } from './common-layout-directives/common-elements/promo-bar.component';\nimport { SideNavigationBarComponent } from './common-layout-directives/navigation-bars/side-navigation-bar.component';\nimport { AlertMessageComponent } from './common-layout-directives/common-elements/alert-message.component';\nimport { WarningsAndAlertsComponent } from '../base-components/warnings-and-alerts.component';\nimport { LoadingMessageComponent } from '../base-components/loading-message.component';\nimport { CreateActivityButtonComponent } from './button-directives/create-activity-button.component';\nimport { CreateActivityModalComponent } from 'pages/creator-dashboard-page/modal-templates/create-activity-modal.component';\nimport { UploadActivityModalComponent } from 'pages/creator-dashboard-page/modal-templates/upload-activity-modal.component';\nimport { ThumbnailUploaderComponent } from './forms/custom-forms-directives/thumbnail-uploader.component';\nimport { EditThumbnailModalComponent } from './forms/custom-forms-directives/edit-thumbnail-modal.component';\nimport { TopNavigationBarComponent } from './common-layout-directives/navigation-bars/top-navigation-bar.component';\nimport { CorrectnessFooterComponent } from 'pages/exploration-player-page/layout-directives/correctness-footer.component';\nimport { ContinueButtonComponent } from 'pages/exploration-player-page/learner-experience/continue-button.component';\nimport { BaseContentComponent } from '../base-components/base-content.component';\nimport { PreviewThumbnailComponent } from 'pages/topic-editor-page/modal-templates/preview-thumbnail.component';\nimport { InputResponsePairComponent } from 'pages/exploration-player-page/learner-experience/input-response-pair.component';\nimport { I18nLanguageSelectorComponent } from '../base-components/i18n-language-selector.component';\nimport { StorySummaryTileComponent } from './summary-tile/story-summary-tile.component';\nimport { ExplorationFooterComponent } from 'pages/exploration-player-page/layout-directives/exploration-footer.component';\nimport { DisplaySolutionModalComponent } from 'pages/exploration-player-page/modals/display-solution-modal.component';\nimport { DisplaySolutionInterstititalModalComponent } from 'pages/exploration-player-page/modals/display-solution-interstitial-modal.component';\nimport { DisplayHintModalComponent } from 'pages/exploration-player-page/modals/display-hint-modal.component';\nimport { HintAndSolutionButtonsComponent } from './button-directives/hint-and-solution-buttons.component';\n\n\n// Directives.\nimport { SubtopicSummaryTileDirective } from './summary-tile/subtopic-summary-tile.directive';\n\n\n// Pipes.\nimport { TruncatePipe } from 'filters/string-utility-filters/truncate.pipe';\nimport { TruncateAndCapitalizePipe } from 'filters/string-utility-filters/truncate-and-capitalize.pipe';\nimport { SummarizeNonnegativeNumberPipe } from 'filters/summarize-nonnegative-number.pipe';\nimport { SortByPipe } from 'filters/string-utility-filters/sort-by.pipe';\nimport { FilterForMatchingSubstringPipe } from 'filters/string-utility-filters/filter-for-matching-substring.pipe';\nimport { WrapTextWithEllipsisPipe } from 'filters/string-utility-filters/wrap-text-with-ellipsis.pipe';\nimport { LimitToPipe } from 'filters/limit-to.pipe';\n\n\n// Services.\nimport { AuthService } from 'services/auth.service';\nimport { HttpClient } from '@angular/common/http';\nimport { I18nLanguageCodeService } from 'services/i18n-language-code.service';\n\n\n// Miscellaneous.\nimport { TranslateLoaderFactory } from 'pages/translate-loader.factory';\nimport { TranslateCacheFactory } from 'pages/translate-cache.factory';\nimport { TranslateCustomParser } from 'pages/translate-custom-parser';\nimport { MissingTranslationCustomHandler } from 'pages/missing-translation-custom-handler';\nimport constants from 'assets/constants';\n\nimport { HammerGestureConfig } from '@angular/platform-browser';\nimport * as hammer from 'hammerjs';\n\n\nexport class MyHammerConfig extends HammerGestureConfig {\n  overrides = {\n    swipe: { direction: hammer.DIRECTION_HORIZONTAL },\n    pinch: { enable: false },\n    rotate: { enable: false },\n  };\n\n  options = {\n    cssProps: {\n      userSelect: true\n    }\n  };\n}\n\nconst toastrConfig = {\n  allowHtml: false,\n  iconClasses: {\n    error: 'toast-error',\n    info: 'toast-info',\n    success: 'toast-success',\n    warning: 'toast-warning'\n  },\n  positionClass: 'toast-bottom-right',\n  messageClass: 'toast-message',\n  progressBar: false,\n  tapToDismiss: true,\n  titleClass: 'toast-title'\n};\n\n@NgModule({\n  imports: [\n    BrowserModule,\n    CommonModule,\n    CustomFormsComponentsModule,\n    CommonElementsModule,\n    CodeMirrorModule,\n    MaterialModule,\n    DirectivesModule,\n    DynamicContentModule,\n    NgbTooltipModule,\n    NgbNavModule,\n    NgbModalModule,\n    NgbPopoverModule,\n    FormsModule,\n    RichTextComponentsModule,\n    ToastrModule.forRoot(toastrConfig),\n    ObjectComponentsModule,\n    OppiaCkEditor4Module,\n    SharedFormsModule,\n    SharedPipesModule,\n    /**\n     * The Translate Module will look for translations in the following order:\n     * 1. Look for translation in primary language (fetched from backend)\n     * 2. Look for translation in default language (fetched from backend)\n     * 3. Look for translation present in AppConstants.ts (\n     *    used until translations after fetched from backend)\n     * 4. shows the key, if the translation is not found.\n     */\n    TranslateModule.forRoot({\n      defaultLanguage: constants.DEFAULT_LANGUAGE_CODE,\n      missingTranslationHandler: {\n        provide: MissingTranslationHandler,\n        useClass: MissingTranslationCustomHandler\n      },\n      loader: {\n        provide: TranslateLoader,\n        useFactory: TranslateLoaderFactory.createHttpLoader,\n        deps: [HttpClient],\n      },\n      parser: {\n        provide: TranslateParser,\n        useClass: TranslateCustomParser,\n        deps: [TranslateDefaultParser, I18nLanguageCodeService]\n      }\n    }),\n    TranslateCacheModule.forRoot({\n      cacheService: {\n        provide: TranslateCacheService,\n        useFactory: TranslateCacheFactory.createTranslateCacheService,\n        deps: [TranslateService, TranslateCacheSettings]\n      },\n      cacheName: 'NG_TRANSLATE_LANG_KEY',\n      cacheMechanism: 'Cookie',\n      cookieExpiry: 30\n    }),\n    AngularFireModule.initializeApp(AuthService.firebaseConfig),\n    AngularFireAuthModule,\n  ],\n\n  providers: [\n    TranslateDefaultParser,\n    AngularFireAuth,\n    {provide: USE_EMULATOR, useValue: AuthService.firebaseEmulatorConfig},\n    {\n      provide: HAMMER_GESTURE_CONFIG,\n      useClass: MyHammerConfig\n    }\n  ],\n\n  declarations: [\n    AlertMessageComponent,\n    AudioBarComponent,\n    AudioFileUploaderComponent,\n    AlertMessageComponent,\n    AttributionGuideComponent,\n    BackgroundBannerComponent,\n    BaseContentComponent,\n    CorrectnessFooterComponent,\n    ContinueButtonComponent,\n    CreateNewSkillModalComponent,\n    CreateActivityButtonComponent,\n    CreateActivityModalComponent,\n    DisplaySolutionModalComponent,\n    DisplaySolutionInterstititalModalComponent,\n    DisplayHintModalComponent,\n    ExplorationFooterComponent,\n    ExplorationSummaryTileComponent,\n    CollectionSummaryTileComponent,\n    ExplorationEmbedButtonModalComponent,\n    FilterForMatchingSubstringPipe,\n    HintAndSolutionButtonsComponent,\n    I18nLanguageSelectorComponent,\n    InputResponsePairComponent,\n    KeyboardShortcutHelpModalComponent,\n    LazyLoadingComponent,\n    LimitToPipe,\n    LoadingMessageComponent,\n    OnScreenKeyboardComponent,\n    OppiaFooterComponent,\n    OutcomeFeedbackEditorComponent,\n    ProfileLinkImageComponent,\n    ProfileLinkTextComponent,\n    PromoBarComponent,\n    SelectSkillModalComponent,\n    RubricsEditorComponent,\n    SharingLinksComponent,\n    SideNavigationBarComponent,\n    SkillSelectorComponent,\n    SkillMasteryViewerComponent,\n    StateSkillEditorComponent,\n    SocialButtonsComponent,\n    StorySummaryTileComponent,\n    SubtopicSummaryTileDirective,\n    SummaryListHeaderComponent,\n    TakeBreakModalComponent,\n    ThumbnailUploaderComponent,\n    EditThumbnailModalComponent,\n    TopNavigationBarComponent,\n    WrapTextWithEllipsisPipe,\n    WarningsAndAlertsComponent,\n    ThumbnailDisplayComponent,\n    ThreadTableComponent,\n    TopicsAndSkillsDashboardNavbarBreadcrumbComponent,\n    TruncateAndCapitalizePipe,\n    SummarizeNonnegativeNumberPipe,\n    TruncatePipe,\n    UploadActivityModalComponent,\n    PromoBarComponent,\n    SortByPipe,\n    LearnerDashboardIconsComponent,\n    PreviewThumbnailComponent\n  ],\n\n  entryComponents: [\n    AlertMessageComponent,\n    AudioBarComponent,\n    AudioFileUploaderComponent,\n    AlertMessageComponent,\n    BackgroundBannerComponent,\n    CorrectnessFooterComponent,\n    ContinueButtonComponent,\n    CreateNewSkillModalComponent,\n    CreateActivityButtonComponent,\n    CreateActivityModalComponent,\n    ExplorationFooterComponent,\n    ExplorationSummaryTileComponent,\n    CollectionSummaryTileComponent,\n    BaseContentComponent,\n    SharingLinksComponent,\n    SkillMasteryViewerComponent, AttributionGuideComponent,\n    LazyLoadingComponent, LoadingMessageComponent,\n    SocialButtonsComponent,\n    OnScreenKeyboardComponent,\n    ProfileLinkImageComponent, ProfileLinkTextComponent,\n    // These elements will remain here even after migration.\n    DisplaySolutionModalComponent,\n    DisplaySolutionInterstititalModalComponent,\n    DisplayHintModalComponent,\n    SelectSkillModalComponent,\n    SkillSelectorComponent,\n    TakeBreakModalComponent,\n    StateSkillEditorComponent,\n    ExplorationEmbedButtonModalComponent,\n    OutcomeFeedbackEditorComponent,\n    HintAndSolutionButtonsComponent,\n    InputResponsePairComponent,\n    KeyboardShortcutHelpModalComponent,\n    I18nLanguageSelectorComponent,\n    OppiaFooterComponent,\n    PreviewThumbnailComponent,\n    PromoBarComponent,\n    RubricsEditorComponent,\n    SideNavigationBarComponent,\n    StorySummaryTileComponent,\n    SummaryListHeaderComponent,\n    ThumbnailDisplayComponent,\n    ThumbnailUploaderComponent,\n    EditThumbnailModalComponent,\n    UploadActivityModalComponent,\n    ThreadTableComponent,\n    TopNavigationBarComponent,\n    TopicsAndSkillsDashboardNavbarBreadcrumbComponent,\n    WarningsAndAlertsComponent,\n    LearnerDashboardIconsComponent,\n    PreviewThumbnailComponent\n  ],\n\n  exports: [\n    // Modules.\n    CommonElementsModule,\n    CodeMirrorModule,\n    DynamicContentModule,\n    DirectivesModule,\n    FormsModule,\n    MaterialModule,\n    NgbTooltipModule,\n    NgbNavModule,\n    NgbModalModule,\n    RichTextComponentsModule,\n    ObjectComponentsModule,\n    OppiaCkEditor4Module,\n    SharedFormsModule,\n    SharedPipesModule,\n    TranslateModule,\n    // Components, directives, and pipes.\n    AlertMessageComponent,\n    AttributionGuideComponent,\n    AudioBarComponent,\n    AudioFileUploaderComponent,\n    AlertMessageComponent,\n    BackgroundBannerComponent,\n    BaseContentComponent,\n    CorrectnessFooterComponent,\n    ContinueButtonComponent,\n    CreateNewSkillModalComponent,\n    CreateActivityButtonComponent,\n    CreateActivityModalComponent,\n    DisplaySolutionModalComponent,\n    DisplaySolutionInterstititalModalComponent,\n    DisplayHintModalComponent,\n    ExplorationFooterComponent,\n    ExplorationSummaryTileComponent,\n    CollectionSummaryTileComponent,\n    HintAndSolutionButtonsComponent,\n    I18nLanguageSelectorComponent,\n    InputResponsePairComponent,\n    LazyLoadingComponent,\n    LoadingMessageComponent,\n    FilterForMatchingSubstringPipe,\n    LimitToPipe,\n    PreviewThumbnailComponent,\n    PromoBarComponent,\n    RubricsEditorComponent,\n    FilterForMatchingSubstringPipe,\n    OnScreenKeyboardComponent,\n    OppiaFooterComponent,\n    OutcomeFeedbackEditorComponent,\n    StateSkillEditorComponent,\n    SelectSkillModalComponent,\n    SideNavigationBarComponent,\n    SharingLinksComponent,\n    SkillSelectorComponent,\n    SocialButtonsComponent,\n    StorySummaryTileComponent,\n    SubtopicSummaryTileDirective,\n    SummaryListHeaderComponent,\n    TakeBreakModalComponent,\n    ThumbnailDisplayComponent,\n    ThumbnailUploaderComponent,\n    EditThumbnailModalComponent,\n    TopNavigationBarComponent,\n    TopicsAndSkillsDashboardNavbarBreadcrumbComponent,\n    WarningsAndAlertsComponent,\n    UploadActivityModalComponent,\n    WrapTextWithEllipsisPipe,\n    TruncateAndCapitalizePipe,\n    TruncatePipe,\n    SummarizeNonnegativeNumberPipe,\n    SortByPipe,\n    LearnerDashboardIconsComponent,\n  ],\n})\n\nexport class SharedComponentsModule { }\n"
    },
    {
      "filename": "core/templates/domain/topic/TopicObjectFactory.ts",
      "content": "// Copyright 2018 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Factory for creating and mutating instances of frontend\n * topic domain objects.\n */\n\nimport { downgradeInjectable } from '@angular/upgrade/static';\nimport { Injectable } from '@angular/core';\n\nimport cloneDeep from 'lodash/cloneDeep';\n\nimport { ShortSkillSummary } from\n  'domain/skill/short-skill-summary.model';\nimport {\n  StoryReferenceBackendDict,\n  StoryReference,\n  StoryReferenceObjectFactory\n} from 'domain/topic/StoryReferenceObjectFactory';\nimport {\n  SkillIdToDescriptionMap,\n  Subtopic,\n  SubtopicBackendDict,\n} from 'domain/topic/subtopic.model';\n\nexport interface TopicBackendDict {\n  'id': string;\n  'name': string;\n  'abbreviated_name': string;\n  'description': string;\n  'language_code': string;\n  'uncategorized_skill_ids': string[];\n  'next_subtopic_id': number;\n  'version': number;\n  'thumbnail_filename': string;\n  'thumbnail_bg_color': string;\n  'subtopics': SubtopicBackendDict[];\n  'canonical_story_references': StoryReferenceBackendDict[];\n  'additional_story_references': StoryReferenceBackendDict[];\n  'url_fragment': string;\n  'practice_tab_is_displayed': boolean;\n  'meta_tag_content': string;\n  'page_title_fragment_for_web': string;\n}\n\nimport constants from 'assets/constants';\n\nexport class Topic {\n  _id: string;\n  _name: string;\n  _abbreviatedName: string;\n  _description: string;\n  _languageCode: string;\n  _canonicalStoryReferences: StoryReference[];\n  _additionalStoryReferences: StoryReference[];\n  _uncategorizedSkillSummaries: ShortSkillSummary[];\n  _nextSubtopicId: number;\n  _version: number;\n  _subtopics: Subtopic[];\n  _thumbnailFilename: string;\n  _thumbnailBgColor: string;\n  _urlFragment: string;\n  _practiceTabIsDisplayed: boolean;\n  _metaTagContent: string;\n  _pageTitleFragmentForWeb: string;\n  storyReferenceObjectFactory: StoryReferenceObjectFactory;\n  constructor(\n      id: string, name: string, abbreviatedName: string, urlFragment: string,\n      description: string, languageCode: string,\n      canonicalStoryReferences: StoryReference[],\n      additionalStoryReferences: StoryReference[],\n      uncategorizedSkillIds: string[],\n      nextSubtopicId: number, version: number, subtopics: Subtopic[],\n      thumbnailFilename: string,\n      thumbnailBgColor: string,\n      skillIdToDescriptionMap: SkillIdToDescriptionMap,\n      storyReferenceObjectFactory: StoryReferenceObjectFactory,\n      practiceTabIsDisplayed: boolean,\n      metaTagContent: string, pageTitleFragmentForWeb: string) {\n    this._id = id;\n    this._name = name;\n    this._abbreviatedName = abbreviatedName;\n    this._urlFragment = urlFragment;\n    this._description = description;\n    this._languageCode = languageCode;\n    this._canonicalStoryReferences = canonicalStoryReferences;\n    this._additionalStoryReferences = additionalStoryReferences;\n    this._uncategorizedSkillSummaries = uncategorizedSkillIds.map(\n      (skillId: string) => {\n        return ShortSkillSummary.create(\n          skillId, skillIdToDescriptionMap[skillId]);\n      });\n    this._nextSubtopicId = nextSubtopicId;\n    this._version = version;\n    this._subtopics = cloneDeep(subtopics);\n    this._thumbnailFilename = thumbnailFilename;\n    this._thumbnailBgColor = thumbnailBgColor;\n    this.storyReferenceObjectFactory = storyReferenceObjectFactory;\n    this._practiceTabIsDisplayed = practiceTabIsDisplayed;\n    this._metaTagContent = metaTagContent;\n    this._pageTitleFragmentForWeb = pageTitleFragmentForWeb;\n  }\n\n  // ---- Instance methods ----\n  getId(): string {\n    return this._id;\n  }\n\n  getName(): string {\n    return this._name;\n  }\n\n  setName(name: string): void {\n    this._name = name;\n  }\n\n  getAbbreviatedName(): string {\n    return this._abbreviatedName;\n  }\n\n  setAbbreviatedName(abbreviatedName: string): void {\n    this._abbreviatedName = abbreviatedName;\n  }\n\n  getPracticeTabIsDisplayed(): boolean {\n    return this._practiceTabIsDisplayed;\n  }\n\n  setPracticeTabIsDisplayed(practiceTabIsDisplayed: boolean): void {\n    this._practiceTabIsDisplayed = practiceTabIsDisplayed;\n  }\n\n  getMetaTagContent(): string {\n    return this._metaTagContent;\n  }\n\n  setMetaTagContent(metaTagContent: string): void {\n    this._metaTagContent = metaTagContent;\n  }\n\n  getPageTitleFragmentForWeb(): string {\n    return this._pageTitleFragmentForWeb;\n  }\n\n  setPageTitleFragmentForWeb(pageTitleFragmentForWeb: string): void {\n    this._pageTitleFragmentForWeb = pageTitleFragmentForWeb;\n  }\n\n  getUrlFragment(): string {\n    return this._urlFragment;\n  }\n\n  setUrlFragment(urlFragment: string): void {\n    this._urlFragment = urlFragment;\n  }\n\n  setThumbnailFilename(thumbnailFilename: string): void {\n    this._thumbnailFilename = thumbnailFilename;\n  }\n\n  getThumbnailFilename(): string {\n    return this._thumbnailFilename;\n  }\n\n  setThumbnailBgColor(thumbnailBgColor: string): void {\n    this._thumbnailBgColor = thumbnailBgColor;\n  }\n\n  getThumbnailBgColor(): string {\n    return this._thumbnailBgColor;\n  }\n\n  getDescription(): string {\n    return this._description;\n  }\n\n  getNextSubtopicId(): number {\n    return this._nextSubtopicId;\n  }\n\n  setDescription(description: string): void {\n    this._description = description;\n  }\n\n  getLanguageCode(): string {\n    return this._languageCode;\n  }\n\n  setLanguageCode(languageCode: string): void {\n    this._languageCode = languageCode;\n  }\n\n  getVersion(): number {\n    return this._version;\n  }\n\n  validate(): string[] {\n    let validUrlFragmentRegex = new RegExp(constants.VALID_URL_FRAGMENT_REGEX);\n    let topicUrlFragmentCharLimit = constants.MAX_CHARS_IN_TOPIC_URL_FRAGMENT;\n    let issues = [];\n    if (this._name === '') {\n      issues.push('Topic name should not be empty.');\n    }\n    if (!validUrlFragmentRegex.test(this._urlFragment)) {\n      issues.push('Topic url fragment is not valid.');\n    }\n    if (this._urlFragment.length > topicUrlFragmentCharLimit) {\n      issues.push(\n        'Topic url fragment should not be longer than ' +\n        `${topicUrlFragmentCharLimit} characters.`);\n    }\n\n    let subtopics = this._subtopics;\n    let canonicalStoryIds = this.getCanonicalStoryIds();\n    let additionalStoryIds = this.getAdditionalStoryIds();\n\n    for (let i = 0; i < canonicalStoryIds.length; i++) {\n      let storyId = canonicalStoryIds[i];\n      if (canonicalStoryIds.indexOf(storyId) <\n          canonicalStoryIds.lastIndexOf(storyId)) {\n        issues.push(\n          'The canonical story with id ' + storyId + ' is duplicated in' +\n            ' the topic.');\n      }\n    }\n    for (let i = 0; i < additionalStoryIds.length; i++) {\n      let storyId = additionalStoryIds[i];\n      if (additionalStoryIds.indexOf(storyId) <\n          additionalStoryIds.lastIndexOf(storyId)) {\n        issues.push(\n          'The additional story with id ' + storyId + ' is duplicated in' +\n            ' the topic.');\n      }\n    }\n    for (let i = 0; i < canonicalStoryIds.length; i++) {\n      if (additionalStoryIds.indexOf(canonicalStoryIds[i]) !== -1) {\n        issues.push(\n          'The story with id ' + canonicalStoryIds[i] +\n            ' is present in both canonical and additional stories.');\n      }\n    }\n    let topicSkillIds = cloneDeep(\n      this._uncategorizedSkillSummaries.map((\n          skillSummary: ShortSkillSummary) => {\n        return skillSummary.getId();\n      }));\n    for (let i = 0; i < subtopics.length; i++) {\n      issues = issues.concat(subtopics[i].validate());\n      let skillIds = subtopics[i].getSkillSummaries().map(\n        (skillSummary) => {\n          return skillSummary.getId();\n        }\n      );\n      for (let j = 0; j < skillIds.length; j++) {\n        if (topicSkillIds.indexOf(skillIds[j]) === -1) {\n          topicSkillIds.push(skillIds[j]);\n        } else {\n          issues.push(\n            'The skill with id ' + skillIds[j] +\n              ' is duplicated in the topic');\n        }\n      }\n    }\n    return issues;\n  }\n\n  prepublishValidate(): string[] {\n    const metaTagContentCharLimit = constants.MAX_CHARS_IN_META_TAG_CONTENT;\n    const pageTitleFragForWebCharLimit = (\n      constants.MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB);\n    let issues = [];\n    if (!this._thumbnailFilename) {\n      issues.push('Topic should have a thumbnail.');\n    }\n    for (let i = 0; i < this._subtopics.length; i++) {\n      if (this._subtopics[i].getSkillSummaries().length === 0) {\n        issues.push(\n          'Subtopic with title ' + this._subtopics[i].getTitle() +\n          ' does not have any skill IDs linked.');\n      }\n    }\n    let pageTitleFragForWebNumChars = this._pageTitleFragmentForWeb.length;\n    if (!this._pageTitleFragmentForWeb) {\n      issues.push('Topic should have page title fragment.');\n    } else if (pageTitleFragForWebNumChars > pageTitleFragForWebCharLimit) {\n      issues.push(\n        'Topic page title fragment should not be longer than ' +\n        `${constants.MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB} characters.`);\n    }\n    if (!this._metaTagContent) {\n      issues.push('Topic should have meta tag content.');\n    } else if (this._metaTagContent.length > metaTagContentCharLimit) {\n      issues.push(\n        'Topic meta tag content should not be longer than ' +\n        `${metaTagContentCharLimit} characters.`);\n    }\n    if (!this._subtopics.length) {\n      issues.push('Topic should have at least 1 subtopic.');\n    }\n    return issues;\n  }\n\n  getSkillIds(): string[] {\n    let topicSkillIds = cloneDeep(\n      this._uncategorizedSkillSummaries.map((\n          skillSummary: ShortSkillSummary) => {\n        return skillSummary.getId();\n      }));\n\n    let subtopics = this._subtopics;\n    for (let i = 0; i < subtopics.length; i++) {\n      topicSkillIds = topicSkillIds.concat(\n        subtopics[i].getSkillSummaries().map((\n            skillSummary: ShortSkillSummary) => {\n          return skillSummary.getId();\n        })\n      );\n    }\n    return topicSkillIds;\n  }\n\n  getSubtopicById(subtopicId: number): Subtopic | null {\n    for (let i = 0; i < this._subtopics.length; i++) {\n      let id = this._subtopics[i].getId();\n      if (id === subtopicId) {\n        return this._subtopics[i];\n      }\n    }\n    return null;\n  }\n\n  // Adds a new frontend subtopic domain object to this topic.\n  addSubtopic(title: string): void {\n    let newSubtopic = Subtopic.createFromTitle(\n      this._nextSubtopicId, title);\n    this._subtopics.push(newSubtopic);\n    this._nextSubtopicId++;\n  }\n\n  // Attempts to remove a subtopic from this topic given the\n  // subtopic ID.\n  deleteSubtopic(subtopicId: number, isNewlyCreated: boolean): void {\n    let subtopicDeleted = false;\n    for (let i = 0; i < this._subtopics.length; i++) {\n      if (this._subtopics[i].getId() === subtopicId) {\n        // When a subtopic is deleted, all the skills in it are moved to\n        // uncategorized skill ids.\n        let skillSummaries = this._subtopics[i].getSkillSummaries();\n        for (let j = 0; j < skillSummaries.length; j++) {\n          let skillId = skillSummaries[j].getId();\n          let skillDescription = skillSummaries[j].getDescription();\n          if (!this.hasUncategorizedSkill(skillId)) {\n            this._uncategorizedSkillSummaries.push(\n              ShortSkillSummary.create(skillId, skillDescription));\n          }\n        }\n        this._subtopics.splice(i, 1);\n        subtopicDeleted = true;\n        break;\n      }\n    }\n    if (!subtopicDeleted) {\n      throw new Error('Subtopic to delete does not exist');\n    }\n    if (isNewlyCreated) {\n      for (let i = 0; i < this._subtopics.length; i++) {\n        if (this._subtopics[i].getId() > subtopicId) {\n          this._subtopics[i].decrementId();\n        }\n      }\n      this._nextSubtopicId--;\n    }\n  }\n\n  clearSubtopics(): void {\n    this._subtopics.length = 0;\n  }\n\n  getSubtopics(): Subtopic[] {\n    return this._subtopics.slice();\n  }\n\n  getCanonicalStoryReferences(): StoryReference[] {\n    return this._canonicalStoryReferences.slice();\n  }\n\n  getCanonicalStoryIds(): string[] {\n    return this._canonicalStoryReferences.map((reference: StoryReference) => {\n      return reference.getStoryId();\n    });\n  }\n\n  addCanonicalStory(storyId: string): void {\n    let canonicalStoryIds = this.getCanonicalStoryIds();\n    if (canonicalStoryIds.indexOf(storyId) !== -1) {\n      throw new Error(\n        'Given story id already present in canonical story ids.');\n    }\n    this._canonicalStoryReferences.push(\n      this.storyReferenceObjectFactory.createFromStoryId(storyId));\n  }\n\n  removeCanonicalStory(storyId: string): void {\n    let canonicalStoryIds = this.getCanonicalStoryIds();\n    let index = canonicalStoryIds.indexOf(storyId);\n    if (index === -1) {\n      throw new Error(\n        'Given story id not present in canonical story ids.');\n    }\n    this._canonicalStoryReferences.splice(index, 1);\n  }\n\n  rearrangeCanonicalStory(fromIndex: number, toIndex: number): void {\n    const canonicalStoryToMove = cloneDeep(\n      this._canonicalStoryReferences[fromIndex]);\n    this._canonicalStoryReferences.splice(fromIndex, 1);\n    this._canonicalStoryReferences.splice(toIndex, 0, canonicalStoryToMove);\n  }\n\n  rearrangeSkillInSubtopic(\n      subtopicId: number, fromIndex: number, toIndex: number): void {\n    const subtopic = this.getSubtopicById(subtopicId);\n    const skillToMove = cloneDeep(\n      subtopic.getSkillSummaries()[fromIndex]);\n    subtopic._skillSummaries.splice(fromIndex, 1);\n    subtopic._skillSummaries.splice(toIndex, 0, skillToMove);\n  }\n\n  rearrangeSubtopic(fromIndex: number, toIndex: number): void {\n    const subtopicToMove = cloneDeep(this._subtopics[fromIndex]);\n    this._subtopics.splice(fromIndex, 1);\n    this._subtopics.splice(toIndex, 0, subtopicToMove);\n  }\n\n  clearCanonicalStoryReferences(): void {\n    this._canonicalStoryReferences.length = 0;\n  }\n\n  getAdditionalStoryIds(): string[] {\n    return this._additionalStoryReferences.map((reference: StoryReference) => {\n      return reference.getStoryId();\n    });\n  }\n\n  getAdditionalStoryReferences(): StoryReference[] {\n    return this._additionalStoryReferences.slice();\n  }\n\n  addAdditionalStory(storyId: string): void {\n    let additionalStoryIds = this.getAdditionalStoryIds();\n    if (additionalStoryIds.indexOf(storyId) !== -1) {\n      throw new Error(\n        'Given story id already present in additional story ids.');\n    }\n    this._additionalStoryReferences.push(\n      this.storyReferenceObjectFactory.createFromStoryId(storyId));\n  }\n\n  removeAdditionalStory(storyId: string): void {\n    let additionalStoryIds = this.getAdditionalStoryIds();\n    let index = additionalStoryIds.indexOf(storyId);\n    if (index === -1) {\n      throw new Error(\n        'Given story id not present in additional story ids.');\n    }\n    this._additionalStoryReferences.splice(index, 1);\n  }\n\n  clearAdditionalStoryReferences(): void {\n    this._additionalStoryReferences.length = 0;\n  }\n\n  hasUncategorizedSkill(skillId: string): boolean {\n    return this._uncategorizedSkillSummaries.some(\n      (skillSummary: ShortSkillSummary) => {\n        return skillSummary.getId() === skillId;\n      });\n  }\n\n  addUncategorizedSkill(\n      skillId: string, skillDescription: string): void {\n    let skillIsPresentInSomeSubtopic = false;\n    for (let i = 0; i < this._subtopics.length; i++) {\n      if (this._subtopics[i].hasSkill(skillId)) {\n        skillIsPresentInSomeSubtopic = true;\n        break;\n      }\n    }\n    if (skillIsPresentInSomeSubtopic) {\n      throw new Error('Given skillId is already present in a subtopic.');\n    }\n    if (this.hasUncategorizedSkill(skillId)) {\n      throw new Error('Given skillId is already an uncategorized skill.');\n    }\n    this._uncategorizedSkillSummaries.push(\n      ShortSkillSummary.create(skillId, skillDescription));\n  }\n\n  removeUncategorizedSkill(skillId: string): void {\n    let index = this._uncategorizedSkillSummaries.map(\n      (skillSummary: ShortSkillSummary) => {\n        return skillSummary.getId();\n      }).indexOf(skillId);\n    if (index === -1) {\n      throw new Error('Given skillId is not an uncategorized skill.');\n    }\n    this._uncategorizedSkillSummaries.splice(index, 1);\n  }\n\n  clearUncategorizedSkills(): void {\n    this._uncategorizedSkillSummaries.length = 0;\n  }\n\n  getUncategorizedSkillSummaries(): ShortSkillSummary[] {\n    return this._uncategorizedSkillSummaries.slice();\n  }\n\n  // Reassigns all values within this topic to match the existing\n  // topic. This is performed as a deep copy such that none of the\n  // internal, bindable objects are changed within this topic.\n  copyFromTopic(otherTopic: Topic): void {\n    this._id = otherTopic.getId();\n    this.setName(otherTopic.getName());\n    this.setAbbreviatedName(otherTopic.getAbbreviatedName());\n    this.setUrlFragment(otherTopic.getUrlFragment());\n    this.setThumbnailFilename(otherTopic.getThumbnailFilename());\n    this.setThumbnailBgColor(otherTopic.getThumbnailBgColor());\n    this.setDescription(otherTopic.getDescription());\n    this.setLanguageCode(otherTopic.getLanguageCode());\n    this.setPracticeTabIsDisplayed(otherTopic.getPracticeTabIsDisplayed());\n    this.setMetaTagContent(otherTopic.getMetaTagContent());\n    this.setPageTitleFragmentForWeb(otherTopic.getPageTitleFragmentForWeb());\n    this._version = otherTopic.getVersion();\n    this._nextSubtopicId = otherTopic.getNextSubtopicId();\n    this.clearAdditionalStoryReferences();\n    this.clearCanonicalStoryReferences();\n    this.clearUncategorizedSkills();\n    this.clearSubtopics();\n\n    this._canonicalStoryReferences = otherTopic.getCanonicalStoryReferences();\n    this._additionalStoryReferences =\n        otherTopic.getAdditionalStoryReferences();\n\n    let uncategorizedSkillSummaries =\n        otherTopic.getUncategorizedSkillSummaries();\n    for (let i = 0; i < uncategorizedSkillSummaries.length; i++) {\n      this.addUncategorizedSkill(\n        uncategorizedSkillSummaries[i].getId(),\n        uncategorizedSkillSummaries[i].getDescription());\n    }\n\n    this._subtopics = cloneDeep(otherTopic.getSubtopics());\n  }\n}\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class TopicObjectFactory {\n  constructor(\n      private storyReferenceObjectFactory: StoryReferenceObjectFactory) {}\n  create(\n      topicBackendDict: TopicBackendDict,\n      skillIdToDescriptionDict: SkillIdToDescriptionMap): Topic {\n    let subtopics = topicBackendDict.subtopics.map((\n        subtopic: SubtopicBackendDict) => {\n      return Subtopic.create(\n        subtopic, skillIdToDescriptionDict);\n    });\n    let canonicalStoryReferences =\n        topicBackendDict.canonical_story_references.map(\n          (reference: StoryReferenceBackendDict) => {\n            return this.storyReferenceObjectFactory.createFromBackendDict(\n              reference);\n          });\n    let additionalStoryReferences =\n        topicBackendDict.additional_story_references.map(\n          (reference: StoryReferenceBackendDict) => {\n            return this.storyReferenceObjectFactory.createFromBackendDict(\n              reference);\n          });\n    return new Topic(\n      topicBackendDict.id, topicBackendDict.name,\n      topicBackendDict.abbreviated_name,\n      topicBackendDict.url_fragment,\n      topicBackendDict.description, topicBackendDict.language_code,\n      canonicalStoryReferences, additionalStoryReferences,\n      topicBackendDict.uncategorized_skill_ids,\n      topicBackendDict.next_subtopic_id, topicBackendDict.version,\n      subtopics, topicBackendDict.thumbnail_filename,\n      topicBackendDict.thumbnail_bg_color,\n      skillIdToDescriptionDict,\n      this.storyReferenceObjectFactory,\n      topicBackendDict.practice_tab_is_displayed,\n      topicBackendDict.meta_tag_content,\n      topicBackendDict.page_title_fragment_for_web\n    );\n  }\n\n  // Create an interstitial topic that would be displayed in the editor until\n  // the actual topic is fetched from the backend.\n  createInterstitialTopic(): Topic {\n    return new Topic(\n      null, 'Topic name loading', 'Abbrev. name loading',\n      'Url Fragment loading', 'Topic description loading', 'en',\n      [], [], [], 1, 1, [], null, '', {},\n      this.storyReferenceObjectFactory, false, '', ''\n    );\n  }\n}\n\nangular.module('oppia').factory(\n  'TopicObjectFactory',\n  downgradeInjectable(TopicObjectFactory));\n"
    },
    {
      "filename": "core/templates/pages/story-editor-page/chapter-editor/chapter-editor-tab.component.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Component for the chapter editor tab.\n */\nrequire(\n  'components/forms/custom-forms-directives/thumbnail-uploader.component.ts');\n\nrequire('pages/story-editor-page/services/story-editor-state.service.ts');\nrequire('pages/story-editor-page/services/story-editor-navigation.service');\nrequire('pages/story-editor-page/story-editor-page.constants.ajs.ts');\nrequire('pages/story-editor-page/editor-tab/story-node-editor.directive.ts');\n\nimport { Subscription } from 'rxjs';\n\nangular.module('oppia').component('chapterEditorTab', {\n  template: require('./chapter-editor-tab.component.html'),\n  controller: [\n    'StoryEditorNavigationService', 'StoryEditorStateService',\n    function(\n        StoryEditorNavigationService, StoryEditorStateService) {\n      var ctrl = this;\n      ctrl.directiveSubscriptions = new Subscription();\n      ctrl.initEditor = function() {\n        ctrl.story = StoryEditorStateService.getStory();\n        ctrl.storyContents = ctrl.story.getStoryContents();\n        ctrl.chapterIndex = StoryEditorNavigationService.getChapterIndex();\n        ctrl.chapterId = StoryEditorNavigationService.getChapterId();\n        if (ctrl.storyContents &&\n            ctrl.storyContents.getNodes().length > 0) {\n          ctrl.nodes = ctrl.storyContents.getNodes();\n          if (!ctrl.chapterIndex) {\n            ctrl.storyContents.getNodes().map((node, index) => {\n              if (node.getId() === ctrl.chapterId) {\n                ctrl.chapterIndex = index;\n                return;\n              }\n            });\n          }\n          ctrl.node = ctrl.nodes[ctrl.chapterIndex];\n        }\n      };\n\n      ctrl.navigateToStoryEditor = function() {\n        StoryEditorNavigationService.navigateToStoryEditor();\n      };\n\n      ctrl.$onInit = function() {\n        ctrl.directiveSubscriptions.add(\n          StoryEditorStateService.onStoryInitialized.subscribe(\n            () => ctrl.initEditor()\n          )\n        );\n        ctrl.directiveSubscriptions.add(\n          StoryEditorStateService.onStoryReinitialized.subscribe(\n            () => ctrl.initEditor()\n          )\n        );\n        ctrl.initEditor();\n      };\n      ctrl.$onDestroy = function() {\n        ctrl.directiveSubscriptions.unsubscribe();\n      };\n    }\n  ]\n});\n"
    },
    {
      "filename": "core/templates/pages/story-editor-page/editor-tab/story-editor.directive.html",
      "content": "<p class=\"oppia-mobile-back-to-parent\" ng-click=\"returnToTopicEditorPage()\">\n  <i class=\"fa fa-angle-left\"></i>\n  <span>Back to Topic</span>\n</p>\n<div class=\"topic-story-name\">\n  <span class=\"topic-name protractor-test-return-to-topic-button\" ng-click=\"returnToTopicEditorPage()\">\n    <[getTopicName()]> /\n  </span>\n  <span class=\"chapter-name\">\n    <[story.getTitle()]>\n  </span>\n</div>\n<div role=\"form\" class=\"form-horizontal\">\n  <div class=\"parent-container\">\n    <div class=\"content-container\">\n      <md-card class=\"oppia-page-card oppia-long-text content-card story-content-card oppia-mobile-collapsible-card\">\n        <div class=\"chapter-list-card-header oppia-mobile-collapsible-card-header\" ng-click=\"toggleStoryEditorCard()\">\n          <h3 class=\"story-card-header\">Story Card</h3>\n          <i class=\"fa fa-caret-down\"\n             ng-if=\"!mainStoryCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n          <i class=\"fa fa-caret-up\"\n             ng-if=\"mainStoryCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n        </div>\n        <div class=\"oppia-mobile-collapsible-card-content\" ng-if=\"mainStoryCardIsShown\">\n          <div class=\"story-content\">\n            <div class=\"story-title\">\n              <label for=\"storyTitle\" class=\"form-heading\">Title*</label>\n              <input id=\"storyTitle\" type=\"text\" class=\"form-control protractor-test-story-title-field\"\n                     ng-model=\"editableTitle\" ng-blur=\"updateStoryTitle(editableTitle)\"\n                     placeholder=\"Enter a title for the story.\" maxlength=\"<[MAX_CHARS_IN_STORY_TITLE]>\" ng-trim=\"false\">\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  Story title should be at most <[MAX_CHARS_IN_STORY_TITLE]> characters.\n                </em>\n              </span>\n            </div>\n            <div class=\"story-description\" ng-class=\"{'has-error': editableDescriptionIsEmpty && storyDescriptionChanged}\">\n              <label for=\"storyDescription\" class=\"form-heading\">Description*</label>\n              <textarea type=\"text\" class=\"form-control protractor-test-story-description-field\"\n                        maxlength=\"<[MAX_CHARS_IN_STORY_DESCRIPTION]>\"\n                        ng-model=\"editableDescription\"\n                        ng-change=\"updateStoryDescriptionStatus(editableDescription)\"\n                        ng-blur=\"updateStoryDescription(editableDescription)\"\n                        placeholder=\"Enter the description of the story\">\n              </textarea>\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  Story description should be at most\n                  <[MAX_CHARS_IN_STORY_DESCRIPTION]> characters.\n                </em>\n              </span>\n              <span ng-if=\"editableDescriptionIsEmpty && storyDescriptionChanged\" class=\"form-text story-contain-text\">\n                What does this story contain?\n              </span>\n            </div>\n            <div class=\"story-meta-tag-content\" ng-class=\"{'has-error': editableMetaTagContent.length === 0}\">\n              <label for=\"storyMetaTagContent\" class=\"form-heading protractor-test-story-meta-tag-content-label\">Meta Tag Content</label>\n              <textarea type=\"text\" class=\"form-control protractor-test-story-meta-tag-content-field oppia-autofocus\"\n                        ng-model=\"editableMetaTagContent\"\n                        ng-blur=\"updateStoryMetaTagContent(editableMetaTagContent)\"\n                        placeholder=\"Enter the meta tag content for the story\"\n                        maxlength=\"<[MAX_CHARS_IN_META_TAG_CONTENT]>\"\n                        focus-on=\"metaTagInputField\">\n              </textarea>\n            </div>\n            <div class=\"story-url-fragment\">\n              <label for=\"storyUrlFragment\" class=\"form-heading\">Url Fragment*</label>\n              <input id=\"storyUrlFragment\" type=\"text\" class=\"form-control protractor-test-story-url-fragment-field\"\n                     ng-model=\"editableUrlFragment\" ng-blur=\"updateStoryUrlFragment(editableUrlFragment)\"\n                     placeholder=\"Enter url fragment for the story.\" maxlength=\"<[MAX_CHARS_IN_STORY_URL_FRAGMENT]>\" ng-trim=\"true\"\n                     ng-class=\"{'is-invalid': storyUrlFragmentExists}\">\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  The story URL fragment is used to uniquely access the story viewer page. It should consist of one or more hyphen-separated words, all in lowercase, with at most <[MAX_CHARS_IN_STORY_URL_FRAGMENT]> characters in total and must be unique across the topic. Please use meaningful keywords, and avoid using words like \"and\", \"of\", or \"the\".\n                  This story can be accessed at the following URL:<br>\n                  <[hostname]>/learn/<[getClassroomUrlFragment()]>/<[getTopicUrlFragment()]>/story/<[editableUrlFragment]>\n                </em>\n              </span>\n              <div ng-if=\"storyUrlFragmentExists\" class=\"oppia-input-box-subtitle text-danger\">\n                <em>\n                  This story URL fragment already exists.\n                </em>\n              </div>\n            </div>\n            <div class=\"story-thumbnail\">\n              <label class=\"form-heading\">Thumbnail Image*</label>\n              <oppia-thumbnail-uploader [filename]=\"story.getThumbnailFilename()\"\n                                        (update-filename)=\"updateStoryThumbnailFilename($event)\"\n                                        [bg-color]=\"story.getThumbnailBgColor()\"\n                                        (update-bg-color)=\"updateStoryThumbnailBgColor($event)\"\n                                        [allowed-bg-colors]=\"allowedBgColors\"\n                                        [aspect-ratio]=\"'4:3'\"\n                                        [preview-title]=\"editableTitle\"\n                                        [preview-description]=\"editableDescription\">\n              </oppia-thumbnail-uploader>\n            </div>\n            <div class=\"story-notes\">\n              <div class=\"oppia-editor-card-body\">\n                <label class=\"form-heading\">Notes</label>\n                <div ng-if=\"!notesEditorIsShown\">\n                  <div ng-class=\"oppia-editable-section\" ng-click=\"openNotesEditor()\" class=\"protractor-test-open-story-notes-editor-button\">\n                    <i class=\"material-icons oppia-editor-edit-icon float-right\"\n                       title=\"Edit Story Notes\">&#xE254;\n                    </i>\n                    <div class=\"oppia-state-content-display oppia-transition-200\"\n                         ng-class=\"oppia-prevent-selection\"\n                         title=\"Story notes\">\n                      <span class=\"oppia-placeholder\" ng-show=\"editableNotes === ''\">\n                          Add notes about the story to help other contributors.\n                      </span>\n                      <angular-html-bind class=\"story-notes protractor-test-story-notes\" html-data=\"editableNotes\">\n                      </angular-html-bind>\n                    </div>\n                    <!-- This is a dummy div created to mask the contents when the user hovers over the content. -->\n                    <div class=\"oppia-editable-section-mask\">\n                    </div>\n                  </div>\n                </div>\n\n                <div ng-if=\"notesEditorIsShown\" class=\"protractor-test-story-notes-rte\">\n                  <schema-based-editor schema=\"NOTES_SCHEMA\" local-value=\"editableNotes\">\n                  </schema-based-editor>\n                  <div class=\"editor-buttons\">\n                    <button type=\"button\"\n                            class=\"btn btn-success oppia-save-state-item-button float-right protractor-test-save-story-notes-button\"\n                            ng-disabled=\"!editableNotes\"\n                            ng-click=\"updateNotes(editableNotes)\">\n                      Save\n                    </button>\n                    <button type=\"button\" class=\"btn btn-secondary float-right\" ng-click=\"closeNotesEditor()\">Cancel</button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div ng-if=\"story.getThumbnailFilename() && mainStoryCardIsShown\">\n          <div ng-if=\"!storyPreviewCardIsShown\" >\n            <button class=\"btn btn-default show-story-preview-button\" ng-click=\"togglePreview()\">\n              Expand Preview\n              <i class=\"fa fa-angle-down\"></i>\n            </button>\n          </div>\n          <div ng-if=\"storyPreviewCardIsShown\">\n            <button class=\"btn btn-default show-story-preview-button\" ng-click=\"togglePreview()\">\n              Collapse Preview\n              <i class=\"fa fa-angle-up\"></i>\n            </button>\n          </div>\n          <div ng-if=\"storyPreviewCardIsShown\">\n            <oppia-preview-thumbnail [name]=\"editableTitle\"\n                                     [aspect-ratio]=\"'16:9'\"\n                                     [description]=\"editableDescription\"\n                                     [filename]=\"story.getThumbnailFilename()\"\n                                     [thumbnail-bg-color]=\"story.getThumbnailBgColor()\"\n                                     bg-color=\"#2F6687\">\n            </oppia-preview-thumbnail>\n          </div>\n        </div>\n      </md-card>\n    </div>\n\n    <div class=\"chapter-list-container\">\n      <md-card class=\"oppia-page-card oppia-long-text content-card oppia-mobile-collapsible-card\">\n        <div class=\"story-node-editor\">\n          <div class=\"chapter-list-card-header oppia-mobile-collapsible-card-header\" ng-click=\"toggleChapterLists()\">\n            <span>Chapters</span>\n            <i class=\"fa fa-caret-down\"\n               ng-if=\"!chaptersListIsShown\"\n               aria-hidden=\"true\">\n            </i>\n            <i class=\"fa fa-caret-up\"\n               ng-if=\"chaptersListIsShown\"\n               aria-hidden=\"true\">\n            </i>\n          </div>\n        </div>\n        <div ng-if=\"chaptersListIsShown\" class=\"oppia-mobile-collapsible-card-content\">\n          <div>\n            <button ng-click=\"createNode()\" class=\"btn add-chapter-btn protractor-test-add-chapter-button\">\n              + ADD CHAPTER\n            </button>\n            <div ng-if=\"!linearNodesList.length\">\n              <p class=\"no-chapters-message\">\n                This story has no chapters.\n              </p>\n            </div>\n            <div ng-if=\"linearNodesList.length\">\n              <div class=\"chapter-list-card-heading\">\n                <span>Name</span>\n              </div>\n              <div class=\"story-nodes-container\">\n                <div ng-repeat=\"node in linearNodesList track by $index\">\n                  <div class=\"story-editor-node\"\n                       ng-class=\"{'selected-node': (node.getId() === idOfNodeToEdit)}\"\n                       ng-click=\"navigateToChapterWithId(node.getId(), $index)\"\n                       dnd-draggable=\"node\"\n                       dnd-list=\"linearNodesList\"\n                       dnd-effect-allowed=\"move\"\n                       dnd-dragstart=\"onMoveChapterStart($index, node.getId())\"\n                       dnd-drop=\"rearrangeNodeInStory($index)\">\n                    <div class=\"story-editor-node-title\">\n                      <span> <[$index+1]>. </span>\n                      <span class=\"protractor-test-chapter-title\"><[node.getTitle()]></span>\n                    </div>\n                    <div class=\"edit-options-container\">\n                      <i class=\"fa fa-ellipsis-v chapter-edit-toggle-button protractor-test-edit-options\" ng-click=\"toggleChapterEditOptions($index);$event.stopPropagation()\" aria-label=\"Chapter edit\"></i>\n                    </div>\n                    <div class=\"chapter-option-box\" ng-if=\"selectedChapterIndex === $index\" ng-mouseleave=\"toggleChapterEditOptions(-1)\" ng-click=\"toggleChapterEditOptions(-1);$event.stopPropagation()\">\n                      <div class=\"chapter-edit-option protractor-test-delete-chapter-button\" ng-click=\"deleteNode(node.getId())\">\n                        <i class=\"fa fa-trash\"></i>\n                        <span>Delete</span>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </md-card>\n    </div>\n  </div>\n</div>\n\n<style>\n  story-editor .no-chapters-message {\n    font-family: 'Capriola', 'Roboto', Arial, sans-serif;\n    font-size: 18px;\n    padding-top: 6px;\n    text-align: center;\n  }\n\n  story-editor .story-editor-node {\n    align-items: center;\n    border-bottom: 1px solid #dbdbdb;\n    cursor: pointer;\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: space-between;\n    padding: 15px 0;\n    position: relative;\n  }\n\n  story-editor .story-editor-node-title {\n    cursor: pointer;\n    text-align: left;\n    width: 95%;\n  }\n\n  story-editor story-editor-node:hover {\n    cursor: grab;\n  }\n\n  story-editor .topic-story-name {\n    font-size: 15px;\n    margin-bottom: 35px;\n    margin-left: 4%;\n  }\n\n  story-editor .topic-name {\n    color: #666;\n    cursor: pointer;\n  }\n\n  story-editor story-editor-node:active {\n    cursor: move;\n  }\n\n  story-editor .story-nodes-container {\n    background-color: #FFF;\n    text-align: left;\n    white-space: initial;\n  }\n\n  story-editor .node-editor {\n    display: inline-block;\n    min-height: 25vh;\n    padding-left: 5%;\n    width: 65%;\n  }\n\n  story-editor .story-node-editor {\n    margin-top: 20px;\n  }\n\n  story-editor .form-heading {\n    font-size: 15px;\n  }\n\n  story-editor .story-title {\n    margin: 20px 0 15px;\n  }\n\n  story-editor .story-thumbnail {\n    margin: 25px 0;\n  }\n\n  story-editor .story-nodes-title {\n    margin-bottom: 2%;\n  }\n\n  story-editor .story-notes .save-button {\n    margin-top: 1.5vh;\n  }\n\n  story-editor .story-description textarea,\n  story-editor .story-meta-tag-content textarea {\n    height: 10vh;\n  }\n\n  story-editor .story-meta-tag-content {\n    margin-bottom: 25px;\n    margin-top: 32px;\n  }\n\n  story-editor .parent-container {\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: center;\n    margin: 0 auto;\n    width: 85%;\n  }\n  story-editor .content-container {\n    margin-right: 3%;\n    width: 50%;\n  }\n  story-editor .chapter-list-container {\n    width: 35%;\n  }\n  story-editor .content-card {\n    margin: 0;\n  }\n  story-editor .chapter-editor-card {\n    width: 80%;\n  }\n  story-editor .show-story-preview-button {\n    border-top: 1px solid #c1c1c1;\n    color: #00645d;\n    font-size: 15px;\n    padding: 10px 0;\n    width: 100%;\n  }\n  story-editor .story-content-card {\n    padding: 0;\n  }\n  story-editor .story-content {\n    padding: 5px 55px 30px 45px;\n  }\n  story-editor .story-notes p {\n     margin: 0;\n  }\n  story-editor .story-card-header {\n    font-size: 20px;\n    margin: 40px 18px 5px;\n  }\n  story-editor .story-contain-text {\n    font-size: smaller;\n  }\n  story-editor .add-chapter-btn {\n    background-color: #008098;\n    color: #FFF;\n    font-weight: bold;\n    margin: 15px 0 15px;\n    text-align: left;\n  }\n  story-editor .chapter-list-card-header {\n    align-items: center;\n    display: flex;\n    flex-wrap: wrap;\n    font-size: 20px;\n    font-weight: bold;\n    justify-content: space-between;\n  }\n  .chapter-list-card-heading {\n    border-bottom: 2px solid #000;\n    padding-left: 4%;\n  }\n  .chapter-list-card-heading span {\n    font-weight: bold;\n  }\n  story-editor .chapter-option-box {\n    background-color: #e1dcdc;\n    border: 1px solid #000;\n    padding: 0;\n    position: absolute;\n    right: -5px;\n    width: 140px;\n    z-index: 1;\n  }\n  story-editor .chapter-edit-option {\n    cursor: pointer;\n    font-size: 15px;\n    padding: 5px;\n    text-align: left;\n  }\n  story-editor .chapter-edit-option span {\n    margin-left: 5%;\n  }\n  story-editor .chapter-edit-toggle-button {\n    cursor: pointer;\n    position: relative;\n  }\n  .chapter-list-card-header i {\n    display: none;\n  }\n  @media screen and (max-width: 1150px) {\n    story-editor .content-container {\n        width: 55%;\n    }\n    story-editor .chapter-list-container {\n      margin-right: 2%;\n      width: 35%;\n    }\n  }\n  @media screen and (max-width: 1000px) {\n    story-editor .parent-container {\n        width: 100%;\n    }\n    story-editor .chapter-list-container {\n      margin-right: 0;\n      width: 40%;\n    }\n  }\n  @media screen and (max-width: 800px) {\n    story-editor .story-content {\n      padding: 0;\n    }\n  }\n  @media screen and (max-width: 768px) {\n    story-editor .content-container,\n    story-editor .chapter-list-container {\n      margin-right: 0;\n      width: 100%;\n    }\n\n    story-editor .topic-story-name {\n      display: none;\n    }\n\n    story-editor .chapter-list-container {\n      margin-top: 40px;\n    }\n\n    story-editor .story-notes {\n      width: 95%;\n    }\n\n    story-editor .story-node-editor {\n      margin-top: 0;\n    }\n\n    story-editor .story-card-header {\n      margin: 0;\n    }\n\n    story-editor .chapter-option-box {\n      right: 20px;\n    }\n\n    story-editor .chapter-list-card-header i {\n      display: block;\n    }\n    story-editor .chapter-list-card-header div {\n      margin-top: 16px;\n      width: 100%;\n    }\n    story-editor .chapter-list-card-header {\n      margin-bottom: 0;\n      padding-bottom: 18px;\n    }\n    story-editor .chapter-list-card-heading {\n      padding-top: 15px;\n    }\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/pages/story-editor-page/editor-tab/story-editor.directive.ts",
      "content": "// Copyright 2018 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Controller for the main story editor.\n */\n\nrequire(\n  'components/common-layout-directives/common-elements/' +\n  'confirm-or-cancel-modal.controller.ts');\nrequire(\n  'components/forms/custom-forms-directives/thumbnail-uploader.component.ts');\nrequire(\n  'components/forms/schema-based-editors/schema-based-editor.directive.ts');\nrequire('pages/story-editor-page/editor-tab/story-node-editor.directive.ts');\nrequire(\n  'pages/story-editor-page/modal-templates/' +\n  'new-chapter-title-modal.controller.ts');\n\nrequire('domain/editor/undo_redo/undo-redo.service.ts');\nrequire('domain/story/story-update.service.ts');\nrequire('pages/story-editor-page/services/story-editor-state.service.ts');\nrequire('services/alerts.service.ts');\nrequire('services/contextual/window-dimensions.service.ts');\n\nrequire('pages/story-editor-page/story-editor-page.constants.ajs.ts');\nrequire(\n  'pages/topic-editor-page/modal-templates/preview-thumbnail.component.ts');\nrequire('services/stateful/focus-manager.service.ts');\nimport { Subscription } from 'rxjs';\n\n// TODO(#9186): Change variable name to 'constants' once this file\n// is migrated to Angular.\nimport storyConstants from 'assets/constants';\n\nangular.module('oppia').directive('storyEditor', [\n  'UrlInterpolationService', function(UrlInterpolationService) {\n    return {\n      restrict: 'E',\n      scope: {},\n      templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n        '/pages/story-editor-page/editor-tab/story-editor.directive.html'),\n      controller: [\n        '$rootScope', '$scope', '$uibModal', 'AlertsService',\n        'FocusManagerService',\n        'StoryEditorNavigationService', 'StoryEditorStateService',\n        'StoryUpdateService', 'UndoRedoService', 'WindowDimensionsService',\n        'WindowRef', 'MAX_CHARS_IN_META_TAG_CONTENT',\n        'MAX_CHARS_IN_STORY_DESCRIPTION',\n        'MAX_CHARS_IN_STORY_TITLE', 'MAX_CHARS_IN_STORY_URL_FRAGMENT',\n        function(\n            $rootScope, $scope, $uibModal, AlertsService,\n            FocusManagerService,\n            StoryEditorNavigationService, StoryEditorStateService,\n            StoryUpdateService, UndoRedoService, WindowDimensionsService,\n            WindowRef, MAX_CHARS_IN_META_TAG_CONTENT,\n            MAX_CHARS_IN_STORY_DESCRIPTION,\n            MAX_CHARS_IN_STORY_TITLE, MAX_CHARS_IN_STORY_URL_FRAGMENT) {\n          var ctrl = this;\n          ctrl.directiveSubscriptions = new Subscription();\n          $scope.MAX_CHARS_IN_STORY_DESCRIPTION = (\n            MAX_CHARS_IN_STORY_DESCRIPTION);\n          $scope.MAX_CHARS_IN_STORY_TITLE = MAX_CHARS_IN_STORY_TITLE;\n          $scope.MAX_CHARS_IN_STORY_URL_FRAGMENT = (\n            MAX_CHARS_IN_STORY_URL_FRAGMENT);\n          $scope.MAX_CHARS_IN_META_TAG_CONTENT = MAX_CHARS_IN_META_TAG_CONTENT;\n          $scope.hostname = WindowRef.nativeWindow.location.hostname;\n          var TOPIC_EDITOR_URL_TEMPLATE = '/topic_editor/<topic_id>';\n          var _init = function() {\n            $scope.story = StoryEditorStateService.getStory();\n            $scope.storyContents = $scope.story.getStoryContents();\n            if ($scope.storyContents) {\n              $scope.setNodeToEdit($scope.storyContents.getInitialNodeId());\n            }\n            _initEditor();\n          };\n\n          var _initEditor = function() {\n            $scope.story = StoryEditorStateService.getStory();\n            $scope.storyContents = $scope.story.getStoryContents();\n            $scope.disconnectedNodes = [];\n            $scope.linearNodesList = [];\n            $scope.nodes = [];\n            $scope.allowedBgColors = (\n              storyConstants.ALLOWED_THUMBNAIL_BG_COLORS.story);\n            if ($scope.storyContents &&\n                $scope.storyContents.getNodes().length > 0) {\n              $scope.nodes = $scope.storyContents.getNodes();\n              $scope.initialNodeId = $scope.storyContents.getInitialNodeId();\n              $scope.linearNodesList =\n                $scope.storyContents.getLinearNodesList();\n            }\n            $scope.notesEditorIsShown = false;\n            $scope.storyTitleEditorIsShown = false;\n            $scope.editableTitle = $scope.story.getTitle();\n            $scope.editableUrlFragment = $scope.story.getUrlFragment();\n            $scope.editableMetaTagContent = $scope.story.getMetaTagContent();\n            $scope.initialStoryUrlFragment = $scope.story.getUrlFragment();\n            $scope.editableNotes = $scope.story.getNotes();\n            $scope.editableDescription = $scope.story.getDescription();\n            $scope.editableDescriptionIsEmpty = (\n              $scope.editableDescription === '');\n            $scope.storyDescriptionChanged = false;\n            $scope.storyUrlFragmentExists = false;\n            $scope.$applyAsync();\n          };\n\n          $scope.setNodeToEdit = function(nodeId) {\n            $scope.idOfNodeToEdit = nodeId;\n          };\n\n          $scope.openNotesEditor = function() {\n            $scope.notesEditorIsShown = true;\n          };\n\n          $scope.closeNotesEditor = function() {\n            $scope.notesEditorIsShown = false;\n          };\n\n          $scope.isInitialNode = function(nodeId) {\n            return (\n              $scope.story.getStoryContents().getInitialNodeId() === nodeId);\n          };\n\n          $scope.onMoveChapterStart = function(index, node) {\n            $scope.dragStartIndex = index;\n            $scope.nodeBeingDragged = node;\n          };\n\n          $scope.rearrangeNodeInStory = function(toIndex) {\n            if ($scope.dragStartIndex === toIndex) {\n              return;\n            }\n            if ($scope.dragStartIndex === 0) {\n              StoryUpdateService.setInitialNodeId(\n                $scope.story, $scope.story.getStoryContents().getNodes()[\n                  toIndex].getId());\n            }\n            if (toIndex === 0) {\n              StoryUpdateService.setInitialNodeId(\n                $scope.story, $scope.story.getStoryContents().getNodes()[\n                  $scope.dragStartIndex].getId());\n            }\n            StoryUpdateService.rearrangeNodeInStory(\n              $scope.story, $scope.dragStartIndex, toIndex);\n            _initEditor();\n          };\n\n          $scope.deleteNode = function(nodeId) {\n            if ($scope.isInitialNode(nodeId)) {\n              AlertsService.addInfoMessage(\n                'Cannot delete the first chapter of a story.', 3000);\n              return;\n            }\n            $uibModal.open({\n              templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n                '/pages/story-editor-page/modal-templates/' +\n                'delete-chapter-modal.template.html'),\n              backdrop: true,\n              controller: 'ConfirmOrCancelModalController'\n            }).result.then(function() {\n              StoryUpdateService.deleteStoryNode($scope.story, nodeId);\n              _initEditor();\n              StoryEditorStateService.onRecalculateAvailableNodes.emit();\n            }, function() {\n              // Note to developers:\n              // This callback is triggered when the Cancel button is clicked.\n              // No further action is needed.\n            });\n          };\n\n          $scope.createNode = function() {\n            var nodeTitles = $scope.linearNodesList.map(function(node) {\n              return node.getTitle();\n            });\n            $uibModal.open({\n              templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n                '/pages/story-editor-page/modal-templates/' +\n                'new-chapter-title-modal.template.html'),\n              backdrop: 'static',\n              resolve: {\n                nodeTitles: () => nodeTitles\n              },\n              windowClass: 'create-new-chapter',\n              controller: 'CreateNewChapterModalController'\n            }).result.then(function() {\n              _initEditor();\n              // If the first node is added, open it just after creation.\n              if ($scope.story.getStoryContents().getNodes().length === 1) {\n                $scope.setNodeToEdit(\n                  $scope.story.getStoryContents().getInitialNodeId());\n              } else {\n                var nodesArray = $scope.story.getStoryContents().getNodes();\n                var nodesLength = nodesArray.length;\n                var secondLastNodeId = nodesArray[nodesLength - 2].getId();\n                var lastNodeId = nodesArray[nodesLength - 1].getId();\n                StoryUpdateService.addDestinationNodeIdToNode(\n                  $scope.story, secondLastNodeId, lastNodeId);\n              }\n              StoryEditorStateService.onRecalculateAvailableNodes.emit();\n            }, function() {\n              // Note to developers:\n              // This callback is triggered when the Cancel button is clicked.\n              // No further action is needed.\n            });\n          };\n\n          $scope.updateNotes = function(newNotes) {\n            if (newNotes !== $scope.story.getNotes()) {\n              StoryUpdateService.setStoryNotes($scope.story, newNotes);\n              _initEditor();\n            }\n          };\n\n          $scope.navigateToChapterWithId = function(id, index) {\n            StoryEditorNavigationService.navigateToChapterEditorWithId(\n              id, index);\n          };\n\n          $scope.updateStoryDescriptionStatus = function(description) {\n            $scope.editableDescriptionIsEmpty = (description === '');\n            $scope.storyDescriptionChanged = true;\n          };\n\n          $scope.updateStoryMetaTagContent = function(newMetaTagContent) {\n            if (newMetaTagContent !== $scope.story.getMetaTagContent()) {\n              StoryUpdateService.setStoryMetaTagContent(\n                $scope.story, newMetaTagContent);\n            }\n          };\n\n          $scope.returnToTopicEditorPage = function() {\n            if (UndoRedoService.getChangeCount() > 0) {\n              $uibModal.open({\n                templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n                  '/pages/story-editor-page/modal-templates/' +\n                    'story-save-pending-changes-modal.template.html'),\n                backdrop: true,\n                controller: 'ConfirmOrCancelModalController'\n              }).result.then(function() {}, function() {\n                // Note to developers:\n                // This callback is triggered when the Cancel button is clicked.\n                // No further action is needed.\n              });\n            } else {\n              const topicId = (\n                StoryEditorStateService.getStory().getCorrespondingTopicId());\n              WindowRef.nativeWindow.open(\n                UrlInterpolationService.interpolateUrl(\n                  TOPIC_EDITOR_URL_TEMPLATE, {\n                    topic_id: topicId\n                  }\n                ), '_self');\n            }\n          };\n\n          $scope.getClassroomUrlFragment = function() {\n            return StoryEditorStateService.getClassroomUrlFragment();\n          };\n\n          $scope.getTopicUrlFragment = function() {\n            return StoryEditorStateService.getTopicUrlFragment();\n          };\n\n          $scope.getTopicName = function() {\n            return StoryEditorStateService.getTopicName();\n          };\n\n          $scope.updateStoryTitle = function(newTitle) {\n            if (newTitle !== $scope.story.getTitle()) {\n              StoryUpdateService.setStoryTitle($scope.story, newTitle);\n            }\n          };\n\n          $scope.updateStoryUrlFragment = function(newUrlFragment) {\n            if (newUrlFragment === $scope.initialStoryUrlFragment) {\n              $scope.storyUrlFragmentExists = false;\n              return;\n            }\n            if (newUrlFragment) {\n              StoryEditorStateService.updateExistenceOfStoryUrlFragment(\n                newUrlFragment, function() {\n                  $scope.storyUrlFragmentExists = (\n                    StoryEditorStateService.getStoryWithUrlFragmentExists());\n                  StoryUpdateService.setStoryUrlFragment(\n                    $scope.story, newUrlFragment);\n                  $rootScope.$apply();\n                });\n            } else {\n              StoryUpdateService.setStoryUrlFragment(\n                $scope.story, newUrlFragment);\n            }\n          };\n\n          $scope.updateStoryThumbnailFilename = function(\n              newThumbnailFilename) {\n            if (newThumbnailFilename !== $scope.story.getThumbnailFilename()) {\n              StoryUpdateService.setThumbnailFilename(\n                $scope.story, newThumbnailFilename);\n            }\n            $scope.$applyAsync();\n          };\n\n          $scope.updateStoryThumbnailBgColor = function(\n              newThumbnailBgColor) {\n            if (newThumbnailBgColor !== $scope.story.getThumbnailBgColor()) {\n              StoryUpdateService.setThumbnailBgColor(\n                $scope.story, newThumbnailBgColor);\n            }\n          };\n\n          $scope.updateStoryDescription = function(newDescription) {\n            if (newDescription !== $scope.story.getDescription()) {\n              StoryUpdateService.setStoryDescription(\n                $scope.story, newDescription);\n            }\n          };\n\n          $scope.togglePreview = function() {\n            $scope.storyPreviewCardIsShown = !($scope.storyPreviewCardIsShown);\n          };\n\n          $scope.toggleChapterEditOptions = function(chapterIndex) {\n            $scope.selectedChapterIndex = (\n              $scope.selectedChapterIndex === chapterIndex) ? -1 : chapterIndex;\n          };\n\n          $scope.toggleChapterLists = function() {\n            if (WindowDimensionsService.isWindowNarrow()) {\n              $scope.chaptersListIsShown = !$scope.chaptersListIsShown;\n            }\n          };\n\n          $scope.toggleStoryEditorCard = function() {\n            if (WindowDimensionsService.isWindowNarrow()) {\n              $scope.mainStoryCardIsShown = !$scope.mainStoryCardIsShown;\n            }\n          };\n\n          ctrl.$onInit = function() {\n            $scope.storyPreviewCardIsShown = false;\n            $scope.mainStoryCardIsShown = true;\n            $scope.chaptersListIsShown = (\n              !WindowDimensionsService.isWindowNarrow());\n            $scope.NOTES_SCHEMA = {\n              type: 'html',\n              ui_config: {\n                startupFocusEnabled: false\n              }\n            };\n            ctrl.directiveSubscriptions.add(\n              StoryEditorStateService.onViewStoryNodeEditor.subscribe(\n                (nodeId) => $scope.setNodeToEdit(nodeId)\n              )\n            );\n\n            ctrl.directiveSubscriptions.add(\n              StoryEditorStateService.onStoryInitialized.subscribe(\n                () =>{\n                  _init();\n                  FocusManagerService.setFocus('metaTagInputField');\n                }\n              ));\n            ctrl.directiveSubscriptions.add(\n              StoryEditorStateService.onStoryReinitialized.subscribe(\n                () => _initEditor()\n              ));\n\n            _init();\n            _initEditor();\n          };\n\n          ctrl.$onDestroy = function() {\n            ctrl.directiveSubscriptions.unsubscribe();\n          };\n        }\n      ]\n    };\n  }]);\n"
    },
    {
      "filename": "core/templates/pages/story-editor-page/editor-tab/story-node-editor.directive.html",
      "content": "<div class=\"story-node\">\n  <div class=\"story-node-content-container\">\n    <div class=\"story-node-content\">\n      <md-card class=\"oppia-page-card oppia-long-text story-node-card story-node-input-card oppia-mobile-collapsible-card\">\n        <div class=\"story-node-header oppia-mobile-collapsible-card-header\" ng-click=\"toggleChapterCard()\">\n          <span>Chapter Card</span>\n          <i class=\"fa fa-caret-down\"\n             ng-if=\"!mainChapterCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n          <i class=\"fa fa-caret-up\"\n             ng-if=\"mainChapterCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n        </div>\n        <div class=\"chapter-card-inputs oppia-mobile-collapsible-card-content\" ng-if=\"mainChapterCardIsShown\">\n          <div class=\"story-node-title\">\n            <label for=\"storyNodeTitle\" class=\"form-heading\">Title*</label>\n            <div>\n              <span class=\"oppia-input-box-subtitle\">\n                <i>\n                  This will be shown to the learner. It overrides the title of the linked exploration.\n                </i>\n              </span>\n            </div>\n            <input id=\"storyNodeTitle\" type=\"text\" class=\"form-control\"\n                   ng-model=\"editableTitle\" ng-blur=\"updateTitle(editableTitle)\"\n                   placeholder=\"Enter a title for the chapter.\" maxlength=\"<[MAX_CHARS_IN_CHAPTER_TITLE]>\" ng-trim=\"false\">\n            <span class=\"oppia-input-box-subtitle\">\n              <i>\n                Chapter title should be at most <[MAX_CHARS_IN_CHAPTER_TITLE]> characters.\n              </i>\n            </span>\n          </div>\n          <div class=\"story-node-description\">\n            <label for=\"storyNodeDescription\" class=\"form-heading\">Chapter description*</label>\n            <textarea id=\"storyNodeDescription\" type=\"text\" class=\"form-control protractor-test-add-chapter-description\"\n                      ng-model=\"editableDescription\" ng-blur=\"updateDescription(editableDescription)\" focus-on=\"storyNodeDesc\"\n                      placeholder=\"Enter the description for the chapter.\" maxlength=\"<[MAX_CHARS_IN_CHAPTER_DESCRIPTION]>\" ng-trim=\"false\">\n            </textarea>\n            <span class=\"oppia-input-box-subtitle\">\n              <i>\n                Chapter description should be at most <[MAX_CHARS_IN_CHAPTER_DESCRIPTION]> characters.\n              </i>\n            </span>\n          </div>\n          <div class=\"story-node-exploration\">\n            <label class=\"form-heading\"> Exploration ID*</label>\n            <form class=\"form-horizontal\">\n              <input class=\"form-control protractor-test-exploration-id-input\" type=\"text\" ng-model=\"explorationId\" ng-change=\"checkCanSaveExpId()\"\n                     ng-focus=\"toggleExplorationInputButtons()\">\n              <div class=\"save-button-container\" ng-if=\"explorationInputButtonsAreShown\">\n                <span ng-if=\"!isStoryPublished()\" ng-click=\"updateExplorationId(null)\" class=\"fas fa-trash-alt list-summary\"></span>\n                <button class=\"btn btn-default\" ng-click=\"toggleExplorationInputButtons()\">Cancel</button>\n                <button type=\"submit\"\n                        class=\"protractor-test-exploration-id-save-button btn btn-success btn-sm\"\n                        ng-click=\"updateExplorationId(explorationId)\"\n                        ng-disabled=\"!expIdCanBeSaved || (explorationId === currentExplorationId)\">\n                  Save\n                </button>\n              </div>\n              <span class=\"form-text error-message\" ng-if=\"invalidExpErrorIsShown\">\n                <em>Please enter a valid exploration id.</em>\n              </span>\n            </form>\n          </div>\n          <div class=\"story-node-thumbnail\">\n            <label class=\"form-heading\">Thumbnail Image*</label>\n            <oppia-thumbnail-uploader [filename]=\"getThumbnailFilename()\"\n                                      (update-filename)=\"updateThumbnailFilename($event)\"\n                                      [bg-color]=\"getThumbnailBgColor()\"\n                                      (update-bg-color)=\"updateThumbnailBgColor($event)\"\n                                      [allowed-bg-colors]=\"allowedBgColors\"\n                                      [aspect-ratio]=\"'4:3'\"\n                                      [preview-title]=\"editableTitle\"\n                                      [preview-description]=\"editableDescription\">\n            </oppia-thumbnail-uploader>\n          </div>\n        </div>\n        <div ng-if=\"mainChapterCardIsShown\">\n          <div ng-if=\"!chapterPreviewCardIsShown\">\n            <button class=\"btn btn-default show-chapter-preview-button\" ng-click=\"togglePreview()\">\n              Preview Chapter Card\n              <i class=\"fa fa-angle-down\"></i>\n            </button>\n          </div>\n          <div ng-if=\"chapterPreviewCardIsShown\">\n            <button class=\"btn btn-default show-chapter-preview-button\" ng-click=\"togglePreview()\">\n              Collapse Chapter Card\n              <i class=\"fa fa-angle-up\"></i>\n            </button>\n          </div>\n          <div ng-if=\"chapterPreviewCardIsShown\">\n            <oppia-preview-thumbnail [name]=\"editableTitle\"\n                                     [aspect-ratio]=\"'16:9'\"\n                                     [filename]=\"getThumbnailFilename()\"\n                                     [description]=\"editableDescription\"\n                                     [thumbnail-bg-color]=\"getThumbnailBgColor()\"\n                                     [bg-color]=\"getThumbnailBgColor()\">\n            </oppia-preview-thumbnail>\n          </div>\n        </div>\n      </md-card>\n      <md-card class=\"oppia-page-card oppia-long-text story-node-card story-node-input-card oppia-mobile-collapsible-card\">\n        <div class=\"protractor-test-add-chapter-outline\">\n          <div class=\"story-node-header oppia-mobile-collapsible-card-header\" ng-click=\"toggleChapterOutline()\">\n            <span>Chapter Outline</span>\n            <i class=\"fa fa-caret-down\"\n               ng-if=\"!chapterOutlineIsShown\"\n               aria-hidden=\"true\">\n            </i>\n            <i class=\"fa fa-caret-up\"\n               ng-if=\"chapterOutlineIsShown\"\n               aria-hidden=\"true\">\n            </i>\n          </div>\n          <div class=\"chapter-card-inputs oppia-mobile-collapsible-card-content\" ng-if=\"chapterOutlineIsShown\">\n            Outline Finalized\n            <i ng-if=\"!isOutlineFinalized()\" ng-click=\"finalizeOutline()\" class=\"material-icons md-18 protractor-test-finalize-outline\" aria-label=\"Finalize outline\">check_box_outline_blank</i>\n            <i ng-if=\"isOutlineFinalized()\" ng-click=\"unfinalizeOutline()\" class=\"material-icons md-18\" aria-label=\"Unfinalize outline\">check_box</i>\n            <div tabindex=\"-1\" ng-blur=\"toggleChapterOutlineButtons()\" ng-click=\"toggleChapterOutlineButtons()\">\n              <schema-based-editor id=\"storyNodeOutline\"\n                                   schema=\"OUTLINE_SCHEMA\"\n                                   local-value=\"editableOutline\">\n              </schema-based-editor>\n              <div class=\"save-button-container\" ng-if=\"chapterOutlineButtonsAreShown\">\n                <button class=\"btn btn-default\">Cancel</button>\n                <button type=\"button\"\n                        class=\"btn btn-success save-button protractor-test-node-outline-save-button\"\n                        ng-disabled=\"!isOutlineModified(editableOutline)\"\n                        ng-click=\"updateOutline(editableOutline)\">\n                  Save\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </md-card>\n      <md-card class=\"oppia-page-card oppia-long-text story-node-card skill-requirements-card story-skill-desktop\">\n        <div class=\"story-node-header skill-requirements-header\">\n          <span>Skill Requirements and Achievements</span>\n        </div>\n        <div>\n          <span class=\"oppia-input-box-subtitle\">\n            <i>\n              The skill should be one of the skills that are linked to this topic.\n            </i>\n          </span>\n        </div>\n        <div class=\"story-skill-requirements\">\n          <div class=\"prerequisite-skills\">\n            <div class=\"skill-header\">\n              <span>Prerequisite</span>\n            </div>\n            <div>\n              <div class=\"skills-card-item\" ng-repeat=\"skillId in getPrerequisiteSkillIds()\">\n                <div class=\"skill-description-card protractor-test-prerequisite-skill-description-card\">\n                  <a ng-href=\"<[getSkillEditorUrl(skillId)]>\" target=\"_blank\" rel=\"noopener\"><[skillIdToSummaryMap[skillId]]></a>\n                  <span class=\"protractor-test-remove-prerequisite-skill\" ng-click=\"removePrerequisiteSkillId(skillId)\" aria-hidden=\"true\">\n                    <i class=\"material-icons md-18\">&#xE14C;</i>\n                  </span>\n                </div>\n              </div>\n              <button class=\"btn add-skill-btn protractor-test-add-prerequisite-skill\" ng-click=\"addPrerequisiteSkillId()\" ng-disabled=\"!skillInfoHasLoaded\">+ ADD PREREQUISITE SKILL</button>\n            </div>\n          </div>\n          <div class=\"acquired-skills\">\n            <div class=\"skill-header\">\n              <span>Acquired</span>\n            </div>\n            <div>\n              <div class=\"skills-card-item\" ng-repeat=\"skillId in getAcquiredSkillIds()\">\n                <div class=\"skill-description-card protractor-test-acquired-skill-description-card\">\n                  <a ng-href=\"<[getSkillEditorUrl(skillId)]>\" target=\"_blank\" rel=\"noopener\"><[skillIdToSummaryMap[skillId]]></a>\n                  <span class=\"protractor-test-remove-acquired-skill\" ng-click=\"removeAcquiredSkillId(skillId)\" aria-hidden=\"true\">\n                    <i class=\"material-icons md-18\">&#xE14C;</i>\n                  </span>\n                </div>\n              </div>\n              <button class=\"btn add-skill-btn protractor-test-add-acquired-skill\" ng-click=\"addAcquiredSkillId()\" ng-disabled=\"!skillInfoHasLoaded\">+ ADD ACQUIRED SKILL</button>\n            </div>\n          </div>\n        </div>\n      </md-card>\n\n      <div class=\"story-skill-mobile\">\n        <md-card class=\"oppia-page-card oppia-long-text story-node-card skill-requirements-card oppia-mobile-collapsible-card\">\n          <div class=\"story-node-header skill-requirements-header oppia-mobile-collapsible-card-header\" ng-click=\"togglePrerequisiteSkillsList()\">\n            <span>Prerequisite Skills</span>\n            <i class=\"fa fa-caret-down\"\n               ng-if=\"!prerequisiteSkillIsShown\"\n               aria-hidden=\"true\">\n            </i>\n            <i class=\"fa fa-caret-up\"\n               ng-if=\"prerequisiteSkillIsShown\"\n               aria-hidden=\"true\">\n            </i>\n          </div>\n          <div class=\"story-skill-requirements oppia-mobile-collapsible-card-content\" ng-if=\"prerequisiteSkillIsShown\">\n            <div>\n              <span class=\"oppia-input-box-subtitle\">\n                <i>\n                  The skill should be one of the skills that are linked to this topic.\n                </i>\n              </span>\n            </div>\n            <div class=\"prerequisite-skills\">\n              <div>\n                <div class=\"skills-card-item\" ng-repeat=\"skillId in getPrerequisiteSkillIds()\">\n                  <div class=\"skill-description-card\">\n                    <a ng-href=\"<[getSkillEditorUrl(skillId)]>\" target=\"_blank\" rel=\"noopener\"><[skillIdToSummaryMap[skillId]]></a>\n                    <span class=\"protractor-test-remove-prerequisite-skill\" ng-click=\"removePrerequisiteSkillId(skillId)\" aria-hidden=\"true\">\n                      <i class=\"material-icons md-18\">&#xE14C;</i>\n                    </span>\n                  </div>\n                </div>\n                <button class=\"btn add-skill-btn protractor-test-add-prerequisite-skill\" ng-click=\"addPrerequisiteSkillId()\" ng-disabled=\"!skillInfoHasLoaded\">+ ADD PREREQUISITE SKILL</button>\n              </div>\n            </div>\n          </div>\n        </md-card>\n\n        <md-card class=\"oppia-page-card oppia-long-text story-node-card skill-requirements-card oppia-mobile-collapsible-card\">\n          <div class=\"story-node-header skill-requirements-header oppia-mobile-collapsible-card-header\" ng-click=\"toggleAcquiredSkillsList()\">\n            <span>Acquired Skills</span>\n            <i class=\"fa fa-caret-down\"\n               ng-if=\"!acquiredSkillIsShown\"\n               aria-hidden=\"true\">\n            </i>\n            <i class=\"fa fa-caret-up\"\n               ng-if=\"acquiredSkillIsShown\"\n               aria-hidden=\"true\">\n            </i>\n          </div>\n          <div class=\"story-skill-requirements oppia-mobile-collapsible-card-content\" ng-if=\"acquiredSkillIsShown\">\n            <div>\n              <span class=\"oppia-input-box-subtitle\">\n                <i>\n                  The skill should be one of the skills that are linked to this topic.\n                </i>\n              </span>\n            </div>\n            <div class=\"acquired-skills\">\n              <div>\n                <div class=\"skills-card-item\" ng-repeat=\"skillId in getAcquiredSkillIds()\">\n                  <div class=\"skill-description-card\">\n                    <a ng-href=\"<[getSkillEditorUrl(skillId)]>\" target=\"_blank\" rel=\"noopener\"><[skillIdToSummaryMap[skillId]]></a>\n                    <span class=\"protractor-test-remove-acquired-skill\" ng-click=\"removeAcquiredSkillId(skillId)\" aria-hidden=\"true\">\n                      <i class=\"material-icons md-18\">&#xE14C;</i>\n                    </span>\n                  </div>\n                </div>\n                <button class=\"btn add-skill-btn protractor-test-add-acquired-skill\" ng-click=\"addAcquiredSkillId()\" ng-disabled=\"!skillInfoHasLoaded\">+ ADD ACQUIRED SKILL</button>\n              </div>\n            </div>\n          </div>\n        </md-card>\n      </div>\n    </div>\n    <div class=\"story-node-content-info\">\n      <md-card class=\"oppia-page-card oppia-long-text story-node-card story-node-input-card oppia-mobile-collapsible-card\">\n        <div class=\"story-node-header oppia-mobile-collapsible-card-header\" ng-click=\"toggleChapterTodoCard()\">\n          <span>To-Do List</span>\n          <i class=\"fa fa-caret-down\"\n             ng-if=\"!chapterTodoCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n          <i class=\"fa fa-caret-up\"\n             ng-if=\"chapterTodoCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n        </div>\n        <div class=\"chapter-card-inputs oppia-mobile-collapsible-card-content\" ng-if=\"chapterTodoCardIsShown\">\n          <div class=\"todo-item-container\">\n            <i class=\"fa fa-minus\" ng-if=\"!isOutlineFinalized()\"></i>\n            <i class=\"fa fa-check todo-completed\" ng-if=\"isOutlineFinalized()\"></i>\n            <span>Complete Chapter Outline</span>\n          </div>\n          <div class=\"todo-item-container\">\n            <i class=\"fa fa-minus\" ng-if=\"!explorationId\"></i>\n            <i class=\"fa fa-check todo-completed\" ng-if=\"explorationId\"></i>\n            <span>Link Exploration ID</span>\n          </div>\n          <div class=\"todo-item-container\">\n            <i class=\"fa fa-minus\" ng-if=\"!currentDescription\"></i>\n            <i class=\"fa fa-check todo-completed\" ng-if=\"currentDescription\"></i>\n            <span>Create a chapter description</span>\n          </div>\n        </div>\n      </md-card>\n    </div>\n  </div>\n</div>\n\n<style>\n  story-node-editor .story-node-content-container {\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: center;\n    margin: 0 auto;\n    width: 85%;\n  }\n  story-node-editor .story-node-content {\n    margin-right: 3%;\n    width: 50%;\n  }\n  story-node-editor .story-node-content-info {\n    margin-right: 5%;\n    width: 30%;\n  }\n  story-node-editor .story-node-card {\n    margin-bottom: 25px;\n    margin-top: 0;\n  }\n  story-node-editor .story-node-input-card {\n    margin-bottom: 20px;\n    margin-top: 0;\n    padding: 0;\n  }\n  story-node-editor .chapter-card-inputs {\n    padding: 30px 55px 30px 45px;\n  }\n  story-node-editor .story-node-header {\n    margin-bottom: 0;\n    margin-left: 25px;\n    margin-top: 35px;\n  }\n  story-node-editor .story-node-header span {\n    font-size: 17px;\n    font-weight: bold;\n  }\n  story-node-editor .story-node-header i {\n    display: none;\n  }\n  story-node-editor .show-chapter-preview-button {\n    border-top: 1px solid #c1c1c1;\n    color: #419889;\n    font-size: 15px;\n    padding: 10px 0;\n    width: 100%;\n  }\n  story-node-editor .skill-requirements-card {\n    padding: 35px 25px;\n  }\n  story-node-editor .story-skill-requirements {\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: space-between;\n    margin-top: 10px;\n  }\n  story-node-editor .skill-requirements-header {\n    margin-left: 0;\n    margin-top: 0;\n  }\n  story-node-editor .prerequisite-skills,\n  story-node-editor .acquired-skills {\n    display: inline-block;\n    width: 48%;\n  }\n  story-node-editor .add-skill-btn {\n    background-color: #008098;\n    color: #FFF;\n    font-weight: bold;\n    margin-top: 12px;\n    text-align: left;\n  }\n  story-node-editor .skill-header {\n    border-bottom: 2px solid #000;\n    margin: 8px 0;\n  }\n  story-node-editor .skill-description-card {\n    border-bottom: 1px solid #e6e6e6;\n    display: flex;\n    justify-content: space-between;\n    padding: 10px 0;\n  }\n  story-node-editor .skill-description-card a {\n    color: inherit;\n    text-decoration: none;\n  }\n  story-node-editor .skill-description-card a:hover {\n    font-weight: bold;\n  }\n  story-node-editor .todo-completed {\n    color: #00FF7F;\n  }\n  story-node-editor .story-node-title,\n  story-node-editor .story-node-description,\n  story-node-editor .story-node-exploration {\n    margin-bottom: 25px;\n  }\n  story-node-editor .todo-item-container {\n    margin-bottom: 5px;\n  }\n  story-node-editor .save-button-container {\n    text-align: right;\n  }\n  story-node-editor .save-button-container button {\n    margin-top: 2px;\n  }\n  story-node-editor .story-skill-mobile {\n    display: none;\n  }\n  @media screen and (max-width: 768px) {\n    story-node-editor .story-node-content-container {\n      width: 100%;\n    }\n    story-node-editor .story-node-content {\n      margin-right: 0;\n      order: 10;\n      width: 100%;\n    }\n    story-node-editor .story-node-header i {\n      display: block;\n    }\n    story-node-editor .chapter-card-inputs {\n      padding: 20px 26px 15px;\n    }\n    story-node-editor .story-node-content-info {\n      margin-right: 0;\n      order: 1;\n      width: 100%;\n    }\n    story-node-editor .story-skill-desktop {\n      display: none;\n    }\n    story-node-editor .story-skill-mobile {\n      display: block;\n    }\n    story-node-editor .prerequisite-skills,\n    story-node-editor .acquired-skills {\n      width: 100%;\n    }\n    story-node-editor .skill-requirements-header {\n      margin-left: 0;\n      margin-top: 0;\n    }\n    story-node-editor .story-node-header {\n      align-items: center;\n      display: flex;\n      justify-content: space-between;\n      margin-left: 0;\n      margin-top: 0;\n    }\n    story-node-editor .skill-requirements-card {\n      padding: 0;\n    }\n    story-node-editor .story-skill-requirements {\n      margin-top: 0;\n    }\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/pages/story-editor-page/editor-tab/story-node-editor.directive.ts",
      "content": "// Copyright 2018 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Controller for the story node editor.\n */\n\nrequire(\n  'components/forms/custom-forms-directives/thumbnail-uploader.component.ts');\nimport { SelectSkillModalComponent } from 'components/skill-selector/select-skill-modal.component';\nimport { NgbModalRef } from '@ng-bootstrap/ng-bootstrap';\nrequire(\n  'components/skill-selector/skill-selector.component.ts');\nrequire(\n  'pages/story-editor-page/modal-templates/' +\n  'new-chapter-title-modal.controller.ts');\nrequire(\n  'pages/topic-editor-page/modal-templates/preview-thumbnail.component.ts');\nrequire('domain/story/story-update.service.ts');\nrequire('domain/exploration/exploration-id-validation.service.ts');\nrequire('pages/story-editor-page/services/story-editor-state.service.ts');\nrequire('services/alerts.service.ts');\nrequire(\n  'domain/topics_and_skills_dashboard/' +\n  'topics-and-skills-dashboard-backend-api.service.ts');\n\nrequire('pages/story-editor-page/story-editor-page.constants.ajs.ts');\nrequire('services/contextual/window-dimensions.service.ts');\nrequire('services/ngb-modal.service.ts');\nrequire('services/page-title.service.ts');\nrequire('services/stateful/focus-manager.service.ts');\nimport { Subscription } from 'rxjs';\n\n// TODO(#9186): Change variable name to 'constants' once this file\n// is migrated to Angular.\nimport storyNodeConstants from 'assets/constants';\n\nangular.module('oppia').directive('storyNodeEditor', [\n  'UrlInterpolationService', function(UrlInterpolationService) {\n    return {\n      restrict: 'E',\n      scope: {\n        getId: '&nodeId',\n        getOutline: '&outline',\n        getDescription: '&description',\n        getExplorationId: '&explorationId',\n        getThumbnailFilename: '&thumbnailFilename',\n        getThumbnailBgColor: '&thumbnailBgColor',\n        isOutlineFinalized: '&outlineFinalized',\n        getDestinationNodeIds: '&destinationNodeIds',\n        getPrerequisiteSkillIds: '&prerequisiteSkillIds',\n        getAcquiredSkillIds: '&acquiredSkillIds'\n      },\n      templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n        '/pages/story-editor-page/editor-tab/story-node-editor.directive.html'),\n      controller: [\n        '$rootScope', '$scope', '$timeout',\n        'AlertsService',\n        'ExplorationIdValidationService', 'FocusManagerService', 'NgbModal',\n        'PageTitleService',\n        'StoryEditorStateService', 'StoryUpdateService',\n        'TopicsAndSkillsDashboardBackendApiService',\n        'WindowDimensionsService', 'MAX_CHARS_IN_CHAPTER_DESCRIPTION',\n        'MAX_CHARS_IN_CHAPTER_TITLE', function(\n            $rootScope, $scope, $timeout,\n            AlertsService,\n            ExplorationIdValidationService, FocusManagerService, NgbModal,\n            PageTitleService,\n            StoryEditorStateService, StoryUpdateService,\n            TopicsAndSkillsDashboardBackendApiService,\n            WindowDimensionsService, MAX_CHARS_IN_CHAPTER_DESCRIPTION,\n            MAX_CHARS_IN_CHAPTER_TITLE) {\n          var ctrl = this;\n          ctrl.directiveSubscriptions = new Subscription();\n          $scope.MAX_CHARS_IN_CHAPTER_TITLE = MAX_CHARS_IN_CHAPTER_TITLE;\n          $scope.MAX_CHARS_IN_CHAPTER_DESCRIPTION = (\n            MAX_CHARS_IN_CHAPTER_DESCRIPTION);\n          var _recalculateAvailableNodes = function() {\n            $scope.newNodeId = null;\n            $scope.availableNodes = [];\n            var linearNodesList =\n              $scope.story.getStoryContents().getLinearNodesList();\n            var linearNodeIds = linearNodesList.map(function(node) {\n              return node.getId();\n            });\n            for (var i = 0; i < $scope.storyNodeIds.length; i++) {\n              if ($scope.storyNodeIds[i] === $scope.getId()) {\n                continue;\n              }\n              if (\n                $scope.getDestinationNodeIds().indexOf(\n                  $scope.storyNodeIds[i]) !== -1) {\n                continue;\n              }\n              if (linearNodeIds.indexOf($scope.storyNodeIds[i]) === -1) {\n                $scope.availableNodes.push({\n                  id: $scope.storyNodeIds[i],\n                  text: $scope.nodeIdToTitleMap[$scope.storyNodeIds[i]]\n                });\n              }\n            }\n          };\n          var categorizedSkills = null;\n          var untriagedSkillSummaries = null;\n          var _init = function() {\n            $scope.story = StoryEditorStateService.getStory();\n            $scope.storyNodeIds = $scope.story.getStoryContents().getNodeIds();\n            $scope.nodeIdToTitleMap =\n              $scope.story.getStoryContents().getNodeIdsToTitleMap(\n                $scope.storyNodeIds);\n            $scope.skillInfoHasLoaded = false;\n            _recalculateAvailableNodes();\n            $scope.allowedBgColors = (\n              storyNodeConstants.ALLOWED_THUMBNAIL_BG_COLORS.chapter);\n            var skillSummaries = StoryEditorStateService.getSkillSummaries();\n            TopicsAndSkillsDashboardBackendApiService.fetchDashboardDataAsync()\n              .then(function(response) {\n                categorizedSkills = response.categorizedSkillsDict;\n                untriagedSkillSummaries = response.untriagedSkillSummaries;\n                $scope.skillInfoHasLoaded = true;\n                $rootScope.$applyAsync();\n              });\n            for (var idx in skillSummaries) {\n              $scope.skillIdToSummaryMap[skillSummaries[idx].id] =\n                skillSummaries[idx].description;\n            }\n            $scope.isStoryPublished = StoryEditorStateService.isStoryPublished;\n            $scope.currentTitle = $scope.nodeIdToTitleMap[$scope.getId()];\n            PageTitleService.setPageSubtitleForMobileView($scope.currentTitle);\n            $scope.editableTitle = $scope.currentTitle;\n            $scope.currentDescription = $scope.getDescription();\n            $scope.editableDescription = $scope.currentDescription;\n            $scope.editableThumbnailFilename = $scope.getThumbnailFilename();\n            $scope.editableThumbnailBgColor = $scope.getThumbnailBgColor();\n            $scope.oldOutline = $scope.getOutline();\n            $scope.editableOutline = $scope.getOutline();\n            $scope.explorationId = $scope.getExplorationId();\n            $scope.currentExplorationId = $scope.explorationId;\n            $scope.expIdIsValid = true;\n            $scope.invalidExpErrorIsShown = false;\n            $scope.nodeTitleEditorIsShown = false;\n            $scope.OUTLINE_SCHEMA = {\n              type: 'html',\n              ui_config: {\n                startupFocusEnabled: false,\n                rows: 100\n              }\n            };\n          };\n\n          $scope.getSkillEditorUrl = function(skillId) {\n            return '/skill_editor/' + skillId;\n          };\n\n          $scope.checkCanSaveExpId = function() {\n            $scope.expIdCanBeSaved = $scope.explorationIdPattern.test(\n              $scope.explorationId) || !$scope.explorationId;\n            $scope.invalidExpErrorIsShown = false;\n          };\n          $scope.updateTitle = function(newTitle) {\n            if (newTitle !== $scope.currentTitle) {\n              var titleIsValid = true;\n              for (var idx in $scope.story.getStoryContents().getNodes()) {\n                var node = $scope.story.getStoryContents().getNodes()[idx];\n                if (node.getTitle() === newTitle) {\n                  titleIsValid = false;\n                  AlertsService.addInfoMessage(\n                    'A chapter already exists with given title.', 5000);\n                }\n              }\n              if (titleIsValid) {\n                StoryUpdateService.setStoryNodeTitle(\n                  $scope.story, $scope.getId(), newTitle);\n                $scope.currentTitle = newTitle;\n              }\n            }\n          };\n\n          $scope.updateDescription = function(newDescription) {\n            if (newDescription !== $scope.currentDescription) {\n              StoryUpdateService.setStoryNodeDescription(\n                $scope.story, $scope.getId(), newDescription);\n              $scope.currentDescription = newDescription;\n            }\n          };\n\n          $scope.updateThumbnailFilename = function(newThumbnailFilename) {\n            if (newThumbnailFilename !== $scope.editableThumbnailFilename) {\n              StoryUpdateService.setStoryNodeThumbnailFilename(\n                $scope.story, $scope.getId(), newThumbnailFilename);\n              $scope.editableThumbnailFilename = newThumbnailFilename;\n            }\n            $scope.$applyAsync();\n          };\n\n          $scope.updateThumbnailBgColor = function(newThumbnailBgColor) {\n            if (newThumbnailBgColor !== $scope.editableThumbnailBgColor) {\n              StoryUpdateService.setStoryNodeThumbnailBgColor(\n                $scope.story, $scope.getId(), newThumbnailBgColor);\n              $scope.editableThumbnailBgColor = newThumbnailBgColor;\n            }\n          };\n\n          $scope.viewNodeEditor = function(nodeId) {\n            StoryEditorStateService.onViewStoryNodeEditor.emit(nodeId);\n          };\n\n          $scope.finalizeOutline = function() {\n            StoryUpdateService.finalizeStoryNodeOutline(\n              $scope.story, $scope.getId());\n          };\n\n          $scope.updateExplorationId = function(explorationId) {\n            $scope.toggleExplorationInputButtons();\n            if (StoryEditorStateService.isStoryPublished()) {\n              if (explorationId === '' || explorationId === null) {\n                AlertsService.addInfoMessage(\n                  'You cannot remove an exploration from a published story.',\n                  5000);\n                return;\n              }\n              ExplorationIdValidationService.isExpPublishedAsync(\n                explorationId).then(function(expIdIsValid) {\n                $scope.expIdIsValid = expIdIsValid;\n                if ($scope.expIdIsValid) {\n                  StoryUpdateService.setStoryNodeExplorationId(\n                    $scope.story, $scope.getId(), explorationId);\n                  $scope.currentExplorationId = explorationId;\n                } else {\n                  $scope.invalidExpErrorIsShown = true;\n                }\n              });\n            } else {\n              if (explorationId === '') {\n                AlertsService.addInfoMessage(\n                  'Please click the delete icon to remove an exploration ' +\n                  'from the story.', 5000);\n                return;\n              }\n              StoryUpdateService.setStoryNodeExplorationId(\n                $scope.story, $scope.getId(), explorationId);\n              $scope.currentExplorationId = explorationId;\n              if (explorationId === null) {\n                $scope.explorationId = null;\n              }\n            }\n          };\n\n          $scope.removePrerequisiteSkillId = function(skillId) {\n            StoryUpdateService.removePrerequisiteSkillIdFromNode(\n              $scope.story, $scope.getId(), skillId);\n            $scope.$applyAsync();\n          };\n\n          $scope.addPrerequisiteSkillId = function() {\n            var sortedSkillSummaries = (\n              StoryEditorStateService.getSkillSummaries());\n            var allowSkillsFromOtherTopics = true;\n            var skillsInSameTopicCount = 0;\n            let modalRef: NgbModalRef = NgbModal.open(\n              SelectSkillModalComponent, {\n                backdrop: 'static',\n                windowClass: 'skill-select-modal',\n                size: 'xl'\n              });\n            modalRef.componentInstance.skillSummaries = sortedSkillSummaries;\n            modalRef.componentInstance.skillsInSameTopicCount = (\n              skillsInSameTopicCount);\n            modalRef.componentInstance.categorizedSkills = categorizedSkills;\n            modalRef.componentInstance.allowSkillsFromOtherTopics = (\n              allowSkillsFromOtherTopics);\n            modalRef.componentInstance.untriagedSkillSummaries = (\n              untriagedSkillSummaries);\n            modalRef.result.then(function(summary) {\n              try {\n                $scope.skillIdToSummaryMap[summary.id] = summary.description;\n                StoryUpdateService.addPrerequisiteSkillIdToNode(\n                  $scope.story, $scope.getId(), summary.id);\n              } catch (err) {\n                AlertsService.addInfoMessage(\n                  'Given skill is already a prerequisite skill', 5000);\n              }\n              // TODO(#8521): Remove the use of $rootScope.$apply()\n              // once the controller is migrated to angular.\n              $rootScope.$applyAsync();\n            }, function() {\n              // Note to developers:\n              // This callback is triggered when the Cancel button is clicked.\n              // No further action is needed.\n            });\n          };\n\n          $scope.addAcquiredSkillId = function() {\n            var sortedSkillSummaries = (\n              StoryEditorStateService.getSkillSummaries());\n            var allowSkillsFromOtherTopics = false;\n            var skillsInSameTopicCount = 0;\n            var topicName = StoryEditorStateService.getTopicName();\n            var categorizedSkillsInTopic = {};\n            categorizedSkillsInTopic[topicName] = categorizedSkills[topicName];\n            let modalRef: NgbModalRef = NgbModal.open(\n              SelectSkillModalComponent, {\n                backdrop: 'static',\n                windowClass: 'skill-select-modal',\n                size: 'xl'\n              });\n            modalRef.componentInstance.skillSummaries = sortedSkillSummaries;\n            modalRef.componentInstance.skillsInSameTopicCount = (\n              skillsInSameTopicCount);\n            modalRef.componentInstance.categorizedSkills = categorizedSkills;\n            modalRef.componentInstance.allowSkillsFromOtherTopics = (\n              allowSkillsFromOtherTopics);\n            modalRef.componentInstance.untriagedSkillSummaries = (\n              untriagedSkillSummaries);\n            modalRef.result.then(function(summary) {\n              try {\n                StoryUpdateService.addAcquiredSkillIdToNode(\n                  $scope.story, $scope.getId(), summary.id);\n              } catch (err) {\n                AlertsService.addInfoMessage(\n                  'Given skill is already an acquired skill', 5000);\n              }\n              // TODO(#8521): Remove the use of $rootScope.$apply()\n              // once the controller is migrated to angular.\n              $rootScope.$applyAsync();\n            }, function() {\n              // Note to developers:\n              // This callback is triggered when the Cancel button is clicked.\n              // No further action is needed.\n            });\n          };\n\n          $scope.removeAcquiredSkillId = function(skillId) {\n            StoryUpdateService.removeAcquiredSkillIdFromNode(\n              $scope.story, $scope.getId(), skillId);\n            $scope.$applyAsync();\n          };\n\n          $scope.unfinalizeOutline = function() {\n            StoryUpdateService.unfinalizeStoryNodeOutline(\n              $scope.story, $scope.getId());\n          };\n\n          $scope.openNodeTitleEditor = function() {\n            $scope.nodeTitleEditorIsShown = true;\n          };\n\n          $scope.closeNodeTitleEditor = function() {\n            $scope.nodeTitleEditorIsShown = false;\n          };\n\n          $scope.isOutlineModified = function(outline) {\n            return ($scope.oldOutline !== outline);\n          };\n\n          $scope.updateOutline = function(newOutline) {\n            if ($scope.isOutlineModified(newOutline)) {\n              StoryUpdateService.setStoryNodeOutline(\n                $scope.story, $scope.getId(), newOutline);\n              $scope.oldOutline = newOutline;\n            }\n          };\n\n          $scope.togglePreview = function() {\n            $scope.chapterPreviewCardIsShown = (\n              !$scope.chapterPreviewCardIsShown);\n          };\n\n          $scope.togglePrerequisiteSkillsList = function() {\n            if (WindowDimensionsService.isWindowNarrow()) {\n              $scope.prerequisiteSkillIsShown =\n                  !$scope.prerequisiteSkillIsShown;\n            }\n          };\n          $scope.toggleChapterOutline = function() {\n            if (WindowDimensionsService.isWindowNarrow()) {\n              $scope.chapterOutlineIsShown = !$scope.chapterOutlineIsShown;\n            }\n          };\n          $scope.toggleAcquiredSkillsList = function() {\n            if (WindowDimensionsService.isWindowNarrow()) {\n              $scope.acquiredSkillIsShown = !$scope.acquiredSkillIsShown;\n            }\n          };\n          $scope.toggleChapterCard = function() {\n            if (WindowDimensionsService.isWindowNarrow()) {\n              $scope.mainChapterCardIsShown = !$scope.mainChapterCardIsShown;\n            }\n          };\n          $scope.toggleChapterTodoCard = function() {\n            if (WindowDimensionsService.isWindowNarrow()) {\n              $scope.chapterTodoCardIsShown = !$scope.chapterTodoCardIsShown;\n            }\n          };\n          $scope.toggleExplorationInputButtons = function() {\n            $scope.explorationInputButtonsAreShown = (\n              !$scope.explorationInputButtonsAreShown);\n          };\n          $scope.toggleChapterOutlineButtons = function() {\n            $scope.chapterOutlineButtonsAreShown = (\n              !$scope.chapterOutlineButtonsAreShown);\n          };\n          ctrl.$onInit = function() {\n            // Regex pattern for exploration id,\n            // EXPLORATION_AND_SKILL_ID_PATTERN\n            // is not being used here, as the chapter of the story can be saved\n            // with empty exploration id.\n            $scope.chapterPreviewCardIsShown = false;\n            $scope.mainChapterCardIsShown = true;\n            $scope.explorationInputButtonsAreShown = false;\n            $scope.chapterOutlineButtonsAreShown = false;\n            $scope.skillIdToSummaryMap = {};\n            PageTitleService.setPageTitleForMobileView('Chapter Editor');\n            $scope.chapterOutlineIsShown = (\n              !WindowDimensionsService.isWindowNarrow());\n            $scope.chapterTodoCardIsShown = (\n              !WindowDimensionsService.isWindowNarrow());\n            $scope.prerequisiteSkillIsShown = (\n              !WindowDimensionsService.isWindowNarrow());\n            $scope.acquiredSkillIsShown = (\n              !WindowDimensionsService.isWindowNarrow());\n            $scope.explorationIdPattern = /^[a-zA-Z0-9_-]+$/;\n            $scope.expIdCanBeSaved = true;\n            ctrl.directiveSubscriptions.add(\n              StoryEditorStateService.onStoryInitialized.subscribe(\n                () => _init()\n              ));\n            ctrl.directiveSubscriptions.add(\n              StoryEditorStateService.onStoryReinitialized.subscribe(\n                () => _init()\n              ));\n            ctrl.directiveSubscriptions.add(\n              StoryEditorStateService.onRecalculateAvailableNodes.subscribe(\n                () => _recalculateAvailableNodes()\n              )\n            );\n            _init();\n            // The $timeout is required because at execution time,\n            // the element may not be present in the DOM yet.Thus it ensure\n            // that the element is visible before focussing.\n            $timeout(() => {\n              FocusManagerService.setFocusWithoutScroll('storyNodeDesc');\n            }, 0);\n          };\n\n          ctrl.$onDestroy = function() {\n            ctrl.directiveSubscriptions.unsubscribe();\n          };\n        }\n      ]\n    };\n  }]);\n"
    },
    {
      "filename": "core/templates/pages/story-editor-page/modal-templates/new-chapter-title-modal.controller.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Controller for new chapter title modal.\n */\n\nrequire(\n  'components/common-layout-directives/common-elements/' +\n  'confirm-or-cancel-modal.controller.ts');\n\nrequire('domain/story/story-update.service.ts');\nrequire('pages/story-editor-page/services/story-editor-state.service.ts');\nrequire('domain/exploration/exploration-id-validation.service.ts');\n\nimport newChapterConstants from 'assets/constants';\n\nangular.module('oppia').controller('CreateNewChapterModalController', [\n  '$controller', '$scope', '$uibModalInstance',\n  'ExplorationIdValidationService', 'StoryEditorStateService',\n  'StoryUpdateService', 'nodeTitles', 'MAX_CHARS_IN_CHAPTER_TITLE',\n  function(\n      $controller, $scope, $uibModalInstance,\n      ExplorationIdValidationService, StoryEditorStateService,\n      StoryUpdateService, nodeTitles, MAX_CHARS_IN_CHAPTER_TITLE) {\n    $controller('ConfirmOrCancelModalController', {\n      $scope: $scope,\n      $uibModalInstance: $uibModalInstance\n    });\n\n    $scope.init = function() {\n      $scope.title = '';\n      $scope.explorationId = '';\n      $scope.invalidExpId = '';\n      $scope.nodeTitles = nodeTitles;\n      $scope.errorMsg = null;\n      $scope.invalidExpErrorString = 'Please enter a valid exploration id.';\n      $scope.MAX_CHARS_IN_CHAPTER_TITLE = MAX_CHARS_IN_CHAPTER_TITLE;\n      $scope.story = StoryEditorStateService.getStory();\n      $scope.nodeId = $scope.story.getStoryContents().getNextNodeId();\n      $scope.editableThumbnailFilename = '';\n      $scope.editableThumbnailBgColor = '';\n      $scope.allowedBgColors = (\n        newChapterConstants.ALLOWED_THUMBNAIL_BG_COLORS.chapter);\n      StoryUpdateService.addStoryNode($scope.story, $scope.title);\n    };\n\n    $scope.init();\n\n    $scope.updateThumbnailFilename = function(\n        newThumbnailFilename) {\n      StoryUpdateService.setStoryNodeThumbnailFilename(\n        $scope.story, $scope.nodeId, newThumbnailFilename);\n      $scope.editableThumbnailFilename = newThumbnailFilename;\n      $scope.$applyAsync();\n    };\n\n    $scope.updateThumbnailBgColor = function(newThumbnailBgColor) {\n      StoryUpdateService.setStoryNodeThumbnailBgColor(\n        $scope.story, $scope.nodeId, newThumbnailBgColor);\n      $scope.editableThumbnailBgColor = newThumbnailBgColor;\n    };\n\n    $scope.updateTitle = function() {\n      StoryUpdateService.setStoryNodeTitle(\n        $scope.story, $scope.nodeId, $scope.title);\n    };\n\n    $scope.cancel = function() {\n      StoryUpdateService.deleteStoryNode($scope.story, $scope.nodeId);\n      $uibModalInstance.dismiss();\n    };\n\n    $scope.updateExplorationId = function() {\n      var nodes = $scope.story.getStoryContents().getNodes();\n      for (var i = 0; i < nodes.length; i++) {\n        if (nodes[i].getExplorationId() === $scope.explorationId) {\n          $scope.invalidExpErrorString = (\n            'The given exploration already exists in the story.');\n          $scope.invalidExpId = true;\n          return;\n        }\n      }\n      if (StoryEditorStateService.isStoryPublished()) {\n        ExplorationIdValidationService.isExpPublishedAsync(\n          $scope.explorationId).then(function(expIdIsValid) {\n          $scope.expIdIsValid = expIdIsValid;\n          if ($scope.expIdIsValid) {\n            StoryUpdateService.setStoryNodeExplorationId(\n              $scope.story, $scope.nodeId, $scope.explorationId);\n            $uibModalInstance.close();\n          } else {\n            $scope.invalidExpId = true;\n          }\n        });\n      } else {\n        StoryUpdateService.setStoryNodeExplorationId(\n          $scope.story, $scope.nodeId, $scope.explorationId);\n        $uibModalInstance.close();\n      }\n    };\n\n    $scope.resetErrorMsg = function() {\n      $scope.errorMsg = null;\n      $scope.invalidExpId = false;\n      $scope.invalidExpErrorString = 'Please enter a valid exploration id.';\n    };\n\n    $scope.isValid = function() {\n      return Boolean(\n        $scope.title && $scope.explorationId &&\n          $scope.editableThumbnailFilename);\n    };\n\n    $scope.save = function() {\n      if ($scope.nodeTitles.indexOf($scope.title) !== -1) {\n        $scope.errorMsg = 'A chapter with this title already exists';\n        return;\n      }\n      $scope.updateTitle();\n      $scope.updateExplorationId();\n    };\n  }\n]);\n"
    },
    {
      "filename": "core/templates/pages/story-editor-page/modal-templates/new-chapter-title-modal.template.html",
      "content": "<div class=\"modal-header create-new-chapter-modal-header\">\n  <h3>\n    New Chapter\n  </h3>\n  <i class=\"fa fa-times modal-close-button\" ng-click=\"cancel()\"></i>\n</div>\n<form ng-submit=\"save(nodeTitle)\">\n  <div class=\"modal-body create-new-chapter\">\n    <div class=\"chapter-input\">\n      <div class=\"chapter-input-header\">\n        <span>Title*</span>\n        <div class=\"oppia-input-box-subtitle\">\n          <i>\n            This will be shown to the learner. It overrides the title of the exploration.\n          </i>\n        </div>\n      </div>\n      <input class=\"form-control protractor-test-new-chapter-title-field oppia-new-chapter-title-field\"\n             placeholder=\"Enter the title for this chapter to be displayed to learners in the story viewer page (can be edited later)\"\n             ng-model=\"title\" ng-change=\"resetErrorMsg()\" maxlength=\"<[MAX_CHARS_IN_CHAPTER_TITLE]>\" autofocus>\n      <span class=\"oppia-input-box-subtitle\">\n        <i>\n          Chapter title should be at most <[MAX_CHARS_IN_CHAPTER_TITLE]> characters.\n        </i>\n      </span>\n      <span class=\"new-chapter-error-msg\" ng-if=\"errorMsg\">\n        <span><[errorMsg]></span>\n      </span>\n    </div>\n\n    <div class=\"chapter-input story-input-description\">\n      <div class=\"chapter-input-header\">\n        <span>Exploration ID*</span>\n      </div>\n      <input ng-change=\"resetErrorMsg()\" ng-model=\"explorationId\" class=\"form-control protractor-test-chapter-exploration-input\">\n      <span class=\"new-chapter-error-msg protractor-test-invalid-exp-id\" ng-if=\"invalidExpId\">\n        <span><[invalidExpErrorString]></span>\n      </span>\n    </div>\n    <div class=\"chapter-input chapter-input-thumbnail\">\n      <div class=\"chapter-input-header\">\n        <span>Thumbnail Image*</span>\n      </div>\n      <oppia-thumbnail-uploader [filename]=\"editableThumbnailFilename\"\n                                (update-filename)=\"updateThumbnailFilename($event)\"\n                                [bg-color]=\"editableThumbnailBgColor\"\n                                (update-bg-color)=\"updateThumbnailBgColor($event)\"\n                                [allowed-bg-colors]=\"allowedBgColors\"\n                                [aspect-ratio]=\"'4:3'\"\n                                [preview-title]=\"title\"\n                                preview-description-bg-color=\"#BE563C\">\n      </oppia-thumbnail-uploader>\n    </div>\n  </div>\n  <div class=\"modal-footer\">\n    <button class=\"btn btn-secondary protractor-test-cancel-chapter-creation-button\" ng-click=\"cancel()\" type=\"button\">Cancel</button>\n    <button class=\"btn btn-success protractor-test-confirm-chapter-creation-button\" type=\"submit\" ng-disabled=\"!isValid()\">\n      <span>Create Chapter</span>\n    </button>\n  </div>\n</form>\n\n<style>\n  .create-new-chapter .chapter-input-header span {\n    font-weight: bold;\n  }\n  .create-new-chapter .chapter-input {\n    padding-bottom: 15px;\n  }\n  .create-new-chapter .chapter-input-thumbnail {\n    padding-bottom: 0;\n    padding-top: 10px;\n  }\n  .create-new-chapter .new-chapter-error-msg {\n    color: #F00;\n    font-size: small;\n  }\n  .create-new-chapter .modal-close-button {\n    display: none;\n  }\n  .create-new-chapter .oppia-new-chapter-title-field {\n    font-size: 12px;\n  }\n  @media screen and (max-width: 768px) {\n    .create-new-chapter .modal-dialog {\n      border: 0;\n      border-radius: 0;\n      margin: 0;\n      padding: 0;\n      width: 100vw;\n    }\n    .create-new-chapter .modal-content {\n      border: 0;\n      border-radius: 0;\n      height: 100vh;\n    }\n    .create-new-chapter .modal-header {\n      align-items: center;\n      background-color: #00609C;\n      display: flex;\n    }\n    .create-new-chapter .modal-header h3 {\n      color: #FFF;\n    }\n    .create-new-chapter .chapter-input {\n      margin: 30px 10px;\n    }\n    .create-new-chapter .create-new-chapter-input-field {\n      margin: 25px 0;\n    }\n    .create-new-chapter .modal-close-button {\n      color: #FFF;\n      display: block;\n      font-size: 20px;\n    }\n  }\n\n</style>\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/editor-tab/topic-editor-tab.directive.html",
      "content": "<p class=\"topic-dashboard-link\">\n  <a href=\"/topics-and-skills-dashboard\">\n    Back to Topics Dashboard <i class=\"fa fa-angle-left\"></i>\n  </a>\n  <span><[editableName]></span>\n</p>\n<a class=\"oppia-mobile-back-to-parent\" href=\"/topics-and-skills-dashboard\">\n  <i class=\"fa fa-angle-left\"></i>\n  <span>Back to Topics Dashboard</span>\n</a>\n<div role=\"form\" class=\"form-horizontal topic-editor\">\n  <div class=\"topic-content-container\">\n    <md-card class=\"oppia-long-text topic-item-card oppia-mobile-collapsible-card\">\n      <div class=\"topic-editor-main-container\">\n        <div class=\"item-list-card-header oppia-mobile-collapsible-card-header\" ng-click=\"togglePreviewListCards()\">\n          <h3 class=\"topic-card-header\">Details</h3>\n          <i class=\"fa fa-caret-down\"\n             ng-if=\"!mainTopicCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n          <i class=\"fa fa-caret-up\"\n             ng-if=\"mainTopicCardIsShown\"\n             aria-hidden=\"true\">\n          </i>\n        </div>\n        <div ng-if=\"mainTopicCardIsShown\">\n          <div class=\"oppia-mobile-collapsible-card-content\">\n            <div class=\"topic-name\">\n              <label for=\"topicName\" class=\"form-heading protractor-test-topic-name-heading\">Name</label>\n              <input id=\"topicName\" type=\"text\" class=\"form-control protractor-test-topic-name-field\"\n                     ng-disabled=\"!topicRights.canEditTopic()\"\n                     ng-model=\"editableName\" ng-blur=\"updateTopicName(editableName)\"\n                     placeholder=\"Enter a name for the topic.\"\n                     maxlength=\"<[MAX_CHARS_IN_TOPIC_NAME]>\"\n                     ng-trim=\"false\"\n                     ng-class=\"{'is-invalid': topicNameExists}\">\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  Topic name should be at most <[MAX_CHARS_IN_TOPIC_NAME]> characters.\n                </em>\n              </span>\n              <div ng-if=\"topicNameExists\" class=\"oppia-input-box-subtitle text-danger\">\n                <em>\n                  A topic with this name already exists.\n                </em>\n              </div>\n            </div>\n            <div class=\"topic-url-fragment\">\n              <label for=\"topicUrlFragment\" class=\"form-heading protractor-test-topic-url-fragment-heading\">Topic URL Fragment</label>\n              <input id=\"topicUrlFragment\" type=\"text\" class=\"form-control protractor-test-topic-url-fragment-field\"\n                     ng-disabled=\"!topicRights.canEditTopic()\"\n                     ng-model=\"editableTopicUrlFragment\" ng-blur=\"updateTopicUrlFragment(editableTopicUrlFragment)\"\n                     maxlength=\"<[MAX_CHARS_IN_TOPIC_URL_FRAGMENT]>\" ng-trim=\"true\"\n                     ng-class=\"{'is-invalid': topicUrlFragmentExists}\">\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  The topic URL fragment is used to uniquely access the topic viewer page. It should consist of one or more hyphen-separated words, all in lowercase, with at most <[MAX_CHARS_IN_TOPIC_URL_FRAGMENT]> characters in total. Please use meaningful keywords, and avoid using words like \"and\", \"of\", or \"the\".\n                  This topic can be accessed at the following URL:<br>\n                  <[hostname]>/learn/<[getClassroomUrlFragment()]>/<[editableTopicUrlFragment]>\n                </em>\n              </span>\n              <div ng-if=\"topicUrlFragmentExists\" class=\"oppia-input-box-subtitle text-danger\">\n                <em>\n                  This topic URL fragment already exists.\n                </em>\n              </div>\n            </div>\n            <div class=\"topic-description\" ng-class=\"{'has-error': editableDescriptionIsEmpty && topicDescriptionChanged}\">\n              <label for=\"topicDescription\" class=\"form-heading protractor-test-topic-description-heading\">Description</label>\n              <textarea type=\"text\" class=\"form-control topic-description protractor-test-topic-description-field\"\n                        ng-model=\"editableDescription\" maxlength=\"<[MAX_CHARS_IN_TOPIC_DESCRIPTION]>\"\n                        ng-change=\"updateTopicDescriptionStatus(editableDescription)\"\n                        ng-blur=\"updateTopicDescription(editableDescription)\"\n                        aria-label=\"Topic Description\"\n                        placeholder=\"Enter the description of the topic\">\n              </textarea>\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  Topic description should be at most <[MAX_CHARS_IN_TOPIC_DESCRIPTION]> characters.\n                </em>\n              </span>\n              <span ng-if=\"editableDescriptionIsEmpty && topicDescriptionChanged\" class=\"form-text\">\n                What does this topic contain?\n              </span>\n            </div>\n            <div class=\"topic-page-title\" ng-class=\"{'has-error': editablePageTitleFragmentForWeb.length === 0}\">\n              <label for=\"topicPageTitleFragmentForWeb\" class=\"form-heading protractor-test-topic-page-title-fragment-label\">Page Title Fragment For Web</label>\n              <textarea type=\"text\" class=\"form-control topic-description protractor-test-topic-page-title-fragment-field\"\n                        ng-model=\"editablePageTitleFragmentForWeb\" maxlength=\"<[MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB]>\"\n                        ng-blur=\"updateTopicPageTitleFragmentForWeb(editablePageTitleFragmentForWeb)\"\n                        aria-label=\"Page Title Fragment\"\n                        placeholder=\"Enter the page title for the topic\">\n              </textarea>\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  Enter the middle component of the page title. For example, if you enter \"Add, Subtract, Multiply and Divide\" it will show up in the browser tab as \"Learn <[editableName]> | Add, Subtract, Multiply and Divide | Oppia\".\n                  It should be at most <[MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB]> characters.\n                </em>\n              </span>\n            </div>\n            <div class=\"topic-meta-tag-content\" ng-class=\"{'has-error': editableMetaTagContent.length === 0}\">\n              <label for=\"topicMetaTagContent\" class=\"form-heading protractor-test-topic-meta-tag-content-label\">Meta Tag Content</label>\n              <textarea type=\"text\" class=\"form-control topic-description protractor-test-topic-meta-tag-content-field\"\n                        ng-model=\"editableMetaTagContent\" maxlength=\"<[MAX_CHARS_IN_META_TAG_CONTENT]>\"\n                        ng-blur=\"updateTopicMetaTagContent(editableMetaTagContent)\"\n                        placeholder=\"Enter the meta tag content for the topic\"\n                        aria-label=\"Meta Tag Content\">\n              </textarea>\n              <span class=\"oppia-input-box-subtitle\">\n                <em>\n                  Meta tags provide information about the webpage. This information will not displayed on the page but it can be read by search engines and web crawlers. This text will be shown to users in seach engine results.\n                  Topic meta tag content should be at most <[MAX_CHARS_IN_META_TAG_CONTENT]> characters.\n                </em>\n              </span>\n            </div>\n            <label class=\"form-heading\">Thumbnail</label>\n            <oppia-thumbnail-uploader [disabled]=\"!topicRights.canEditTopic()\"\n                                      [filename]=\"topic.getThumbnailFilename()\"\n                                      (update-filename)=\"updateTopicThumbnailFilename($event)\"\n                                      [bg-color]=\"topic.getThumbnailBgColor()\"\n                                      (update-bg-color)=\"updateTopicThumbnailBgColor($event)\"\n                                      [allowed-bg-colors]=\"allowedBgColors\"\n                                      [aspect-ratio]=\"'4:3'\"\n                                      [preview-title]=\"editableName\"\n                                      preview-description-bg-color=\"#2F6687\"\n                                      [preview-footer]=\"topic.getCanonicalStoryIds().length + ' Lessons'\">\n            </oppia-thumbnail-uploader>\n          </div>\n        </div>\n      </div>\n      <div ng-if=\"topic.getThumbnailFilename() && mainTopicCardIsShown\">\n        <div ng-if=\"!topicPreviewCardIsShown\" >\n          <button class=\"btn btn-default show-topic-preview-button\" ng-click=\"togglePreview()\">\n            Expand Preview\n            <i class=\"fa fa-angle-down\"></i>\n          </button>\n        </div>\n        <div ng-if=\"topicPreviewCardIsShown\">\n          <button class=\"btn btn-default show-topic-preview-button\" ng-click=\"togglePreview()\">\n            Collapse Preview\n            <i class=\"fa fa-angle-up\"></i>\n          </button>\n        </div>\n        <div ng-if=\"topic.getId() && topicPreviewCardIsShown\">\n          <oppia-preview-thumbnail [name]=\"editableName\"\n                                   [aspect-ratio]=\"'4:3'\"\n                                   [preview-footer]=\"getPreviewFooter()\"\n                                   [filename]=\"topic.getThumbnailFilename()\"\n                                   [thumbnail-bg-color]=\"topic.getThumbnailBgColor()\"\n                                   [bg-color]=\"'#2F6687'\">\n          </oppia-preview-thumbnail>\n        </div>\n      </div>\n    </md-card>\n    <md-card class=\"item-list-card subtopic-skill-card-container topic-bottom-card oppia-mobile-collapsible-card\">\n      <div class=\"item-list-card-header oppia-mobile-collapsible-card-header\" ng-click=\"togglePreviewListCards(SUBTOPIC_LIST)\">\n        <div class=\"subtopic-reassign-header\">\n          <h3>Subtopics</h3>\n          <span class=\"reassign-button protractor-test-reassign-skill-button\" ng-click=\"reassignSkillsInSubtopics()\">REASSIGN</span>\n          <i class=\"fa fa-caret-down\"\n             ng-if=\"!subtopicsListIsShown\"\n             aria-hidden=\"true\">\n          </i>\n          <i class=\"fa fa-caret-up\"\n             ng-if=\"subtopicsListIsShown\"\n             aria-hidden=\"true\">\n          </i>\n        </div>\n      </div>\n      <div ng-if=\"subtopicsListIsShown\" class=\"oppia-mobile-collapsible-card-content\">\n        <div>\n          <label>\n            <input class=\"practice-tab-checkbox protractor-test-toggle-practice-tab\" type=\"checkbox\" ng-model=\"editablePracticeIsDisplayed\" ng-change=\"updatePracticeTabIsDisplayed(editablePracticeIsDisplayed)\">\n            <span class=\"practice-tab-text\"> Show Practice Tab to learners.</span>\n          </label>\n          <i class=\"fas fa-info-circle practice-tab-info-circle\" title=\"This setting show/hides the practice tab in the topic viewer page. It is recommended that this option be enabled only if there are at least 5 questions attached to the topic\"></i>\n        </div>\n        <button class=\"btn add-subtopic-btn protractor-test-add-subtopic-button puppeteer-test-add-subtopic-button\" ng-click=\"createSubtopic()\">\n          + ADD SUBTOPIC\n        </button>\n        <button ng-if=\"skillCreationIsAllowed\" class=\"btn add-skill-btn protractor-test-add-skill-button puppeteer-test-add-skill-button\" ng-click=\"createSkill()\">\n          + ADD SKILL\n        </button>\n        <div ng-if=\"(subtopics.length || uncategorizedSkillSummaries.length) && subtopicsListIsShown\">\n          <div class=\"list-header\">\n            <span>Name</span>\n            <span class=\"number-skills-header\"># of Questions</span>\n          </div>\n          <div class=\"subtopic-name-header skills-invalid\" ng-if=\"uncategorizedSkillSummaries.length\">\n            <span>Uncategorized Skills</span>\n          </div>\n          <div ng-repeat=\"skillSummary in uncategorizedSkillSummaries track by $index\" class=\"subtopic-skill skills-list-item protractor-test-skill-item\">\n            <a ng-href=\"<[getSkillEditorUrl(skillSummary.getId())]>\" target=\"_blank\" rel=\"noopener\">\n              <span class=\"clickable-item\"><[skillSummary.getDescription()]></span>\n            </a>\n            <div class=\"edit-options-container\">\n              <i class=\"fa fa-ellipsis-v\" ng-click=\"toggleUncategorizedSkillOptions($index)\"></i>\n            </div>\n            <div class=\"uncategorized-skill-option-box\"\n                 ng-if=\"uncategorizedEditOptionsIndex === $index\"\n                 ng-mouseleave=\"toggleUncategorizedSkillOptions(null)\"\n                 ng-click=\"toggleUncategorizedSkillOptions(null)\">\n              <div class=\"uncategorized-skill-edit-option\" ng-click=\"deleteUncategorizedSkillFromTopic(skillSummary)\">\n                <i class=\"fa fa-trash\"></i>\n                <span>Remove from topic</span>\n              </div>\n              <div class=\"uncategorized-skill-edit-option edit-option-assign\" ng-click=\"changeSubtopicAssignment(null, skillSummary)\">\n                <i class=\"fa fa-plus\"></i>\n                <span>Assign to Subtopic</span>\n              </div>\n            </div>\n          </div>\n          <div ng-repeat=\"subtopic in subtopics track by $index\"\n               ng-init=\"subtopicIndex = $index\"\n               dnd-list=\"subtopics\"\n               dnd-dragstart=\"onRearrangeSubtopicStart($index)\"\n               dnd-drop=\"onRearrangeSubtopicEnd($index)\"\n               dnd-draggable=\"subtopic\">\n            <div class=\"subtopics-list-item\">\n              <div class=\"subtopic-name-header subtopic-name-card-header\" ng-click=\"toggleSubtopicCard(subtopicIndex)\">\n                <span class=\"clickable-item\" ng-click=\"navigateToSubtopic(subtopic.getId(), subtopic.getTitle())\">\n                  <span class=\"material-icons draggable-icon-indicator\">drag_indicator</span>\n                  <span class=\"protractor-test-subtopic\"><[subtopic.getTitle()]></span>\n                </span>\n                <div class=\"subtopic-edit-options-container edit-options-container\">\n                  <span><[subtopicQuestionCountDict[subtopic.getId()] ]></span>\n                  <i class=\"fa fa-ellipsis-v protractor-test-show-subtopic-options\" ng-click=\"showSubtopicEditOptions($index);$event.stopPropagation()\"></i>\n                  <div ng-if=\"subtopicEditOptionsAreShown === subtopicIndex\" class=\"subtopic-edit-options\" ng-click=\"deleteSubtopic(subtopic.getId())\" ng-mouseleave=\"showSubtopicEditOptions(null)\">\n                    <i class=\"fa fa-trash protractor-test-delete-subtopic-button\"></i>\n                    <span>Delete</span>\n                  </div>\n                </div>\n              </div>\n              <div ng-if=\"subtopicCardSelectedIndexes[subtopicIndex]\">\n                <div ng-if=\"subtopic.getSkillSummaries().length\">\n                  <div ng-repeat=\"skillSummary in subtopic.getSkillSummaries() track by $index\" ng-init=\"skillIndex = $index\" class=\"subtopic-skill skills-list-item skill-description-container\">\n                    <a ng-href=\"<[getSkillEditorUrl(skillSummary.getId())]>\" target=\"_blank\" rel=\"noopener\">\n                      <span class=\"clickable-item\"><[skillSummary.getDescription()]></span>\n                    </a>\n                    <div class=\"edit-options-container\">\n                      <span><[skillQuestionCountDict[skillSummary.getId()] ]></span>\n                      <i class=\"fa fa-ellipsis-v\" ng-click=\"showSkillEditOptions(subtopicIndex, skillIndex);$event.stopPropagation()\"></i>\n                    </div>\n                    <div class=\"skill-option-box\" ng-if=\"selectedSkillEditOptionsIndex[subtopicIndex][skillIndex]\" ng-mouseleave=\"showSkillEditOptions(null)\" ng-click=\"showSkillEditOptions(null)\">\n                      <div class=\"skill-edit-option\" ng-click=\"removeSkillFromSubtopic(subtopic.getId(), skillSummary)\">\n                        <i class=\"fa fa-trash\"></i>\n                        <span>Remove from subtopic</span>\n                      </div>\n                      <div class=\"skill-edit-option\" ng-click=\"changeSubtopicAssignment(subtopic.getId(), skillSummary)\">\n                        <i class=\"fa fa-plus\"></i>\n                        <span>Change Subtopic</span>\n                      </div>\n                      <div class=\"skill-edit-option remove-from-topic-option\" ng-click=\"removeSkillFromTopic(subtopic.getId(), skillSummary)\">\n                        <i class=\"fa fa-trash\"></i>\n                        <span>Remove from topic</span>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n                <div ng-if=\"!subtopic.getSkillSummaries().length\">\n                  <span class=\"subtopic-skill\">There are no skills associated to this subtopic.</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </md-card>\n  </div>\n  <div class=\"topic-info-container\">\n    <md-card class=\"item-list-card topic-item-card topic-bottom-card oppia-mobile-collapsible-card\">\n      <div class=\"item-list-card-header oppia-mobile-collapsible-card-header\" ng-click=\"togglePreviewListCards(STORY_LIST)\">\n        <h3>Canonical Stories</h3>\n        <i class=\"fa fa-caret-down\"\n           ng-if=\"!storiesListIsShown\"\n           aria-hidden=\"true\">\n        </i>\n        <i class=\"fa fa-caret-up\"\n           ng-if=\"storiesListIsShown\"\n           aria-hidden=\"true\">\n        </i>\n      </div>\n      <div ng-if=\"storiesListIsShown\" class=\"oppia-mobile-collapsible-card-content\">\n        <button class=\"btn add-story-btn protractor-test-create-story-button oppia-autofocus\"\n                ng-click=\"createCanonicalStory()\" focus-on=\"addStoryBtn\">\n          + ADD STORY\n        </button>\n        <div class=\"canonical-stories\">\n          <topic-editor-stories-list ng-if=\"topic.getCanonicalStoryIds().length > 0\"\n                                     story-summaries=\"canonicalStorySummaries\"\n                                     topic=\"topic\">\n          </topic-editor-stories-list>\n        </div>\n      </div>\n    </md-card>\n    <md-card class=\"entity-count\">\n      <div class=\"subtopic-count\">\n        <span class=\"subtopic-count-value\" ng-if=\"!topicDataHasLoaded\"><loading-dots></loading-dots></span>\n        <span class=\"subtopic-count-value\" ng-if=\"topicDataHasLoaded\"><[topic.getSubtopics().length]></span>\n        <span class=\"subtopic-count-text\">Subtopics</span>\n      </div>\n      <div class=\"skill-count\">\n        <span class=\"skill-count-value\" ng-if=\"!topicDataHasLoaded\"><loading-dots></loading-dots></span>\n        <span class=\"skill-count-value\" ng-if=\"topicDataHasLoaded\"><[topic.getSkillIds().length]></span>\n        <span class=\"skill-count-text\">Skills</span>\n      </div>\n      <div class=\"story-count\">\n        <span class=\"story-count-value\" ng-if=\"!topicDataHasLoaded\"><loading-dots></loading-dots></span>\n        <span class=\"story-count-value\" ng-if=\"topicDataHasLoaded\"><[topic.getCanonicalStoryIds().length]></span>\n        <span class=\"story-count-text\">Stories</span>\n      </div>\n    </md-card>\n  </div>\n  <div>\n  </div>\n</div>\n<style>\n  topic-editor-tab .topic-editor thumbnail-uploader {\n    margin-bottom: 15px;\n  }\n\n  topic-editor-tab .topic-editor textarea {\n    resize: vertical;\n  }\n\n  topic-editor-tab .topic-editor {\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: center;\n    margin: 0 auto;\n    width: 85%;\n  }\n\n  .topic-editor .topic-content-container {\n    margin-right: 3%;\n    width: 50%;\n  }\n\n  .topic-editor .topic-info-container {\n    width: 35%;\n  }\n\n  .topic-editor .topic-item-card {\n    margin: 0;\n  }\n\n  .topic-editor .add-entity-text {\n    color: #808080;\n    margin-top: 20px;\n  }\n\n  topic-editor-tab .topic-dashboard-link {\n    font-size: 15px;\n    margin-bottom: 35px;\n    margin-left: 4%;\n  }\n\n  topic-editor-tab .topic-dashboard-link a {\n    color: #015F9C;\n    text-decoration: none;\n  }\n\n  .topic-editor .topic-preview-container {\n    text-align: center;\n  }\n\n  .topic-editor .topic-preview-container button {\n    margin: 15px 0;\n  }\n\n  .topic-editor .entity-count {\n    align-items: center;\n    background-color: #FFF;\n    border: 1px solid #aaaac1;\n    border-radius: 6px;\n    box-shadow: none;\n    display: flex;\n    flex-wrap: wrap;\n    height: 110px;\n    justify-content: center;\n    margin: 30px auto 0;\n    width: 97%;\n  }\n\n  .topic-editor .subtopic-count,\n  .topic-editor .skill-count,\n  .topic-editor .story-count {\n    border-right: 2px solid #aaaac1;\n    display: inline-block;\n    text-align: center;\n    width: 33%;\n  }\n\n  .topic-editor .story-count {\n    border-right: none;\n  }\n  .topic-editor .topic-card-header {\n    margin-bottom: 30px;\n    margin-left: -20px;\n  }\n\n  .topic-editor .skills-list-item {\n    align-items: center;\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: space-between;\n    position: relative;\n  }\n\n  .topic-editor .skills-list-item a {\n    color: inherit;\n    text-decoration: none;\n    width: 75%;\n  }\n\n  .topic-editor .edit-options-container {\n    margin-right: 14px;\n  }\n\n  .topic-editor .edit-options-container span {\n    margin-right: 38px;\n  }\n\n  .topic-editor .number-skills-header {\n    margin-right: 30px;\n  }\n\n  .topic-editor .subtopic-count-value,\n  .topic-editor .skill-count-value,\n  .topic-editor .story-count-value {\n    display: block;\n    font-size: 26px;\n    height: 40px;\n  }\n\n  .topic-editor .topic-editor-main-container {\n    font-family: Roboto, Arial, sans-serif;\n    padding: 30px 55px 30px 45px;\n  }\n\n  .topic-editor .show-topic-preview-button {\n    border-top: 1px solid #c1c1c1;\n    color: #419889;\n    font-size: 15px;\n    padding: 10px 0;\n    width: 100%;\n  }\n\n  .topic-editor .form-heading {\n    font-size: 15px;\n  }\n\n  .topic-editor .topic-name,\n  .topic-editor .topic-url-fragment,\n  .topic-editor .topic-meta-tag-content,\n  .topic-editor .topic-page-title {\n    margin-bottom: 25px;\n    margin-top: 32px;\n  }\n\n  .topic-editor .canonical-stories {\n    margin-top: 20px;\n  }\n\n  .topic-editor .topic-description textarea,\n  .topic-editor .topic-meta-tag-content textarea {\n    height: 10vh;\n  }\n\n  .topic-editor .add-subtopic-btn,\n  .topic-editor .add-skill-btn,\n  .topic-editor .add-story-btn {\n    background-color: #008098;\n    color: #FFF;\n    font-weight: bold;\n    text-align: left;\n  }\n\n  .topic-editor .add-subtopic-btn {\n    width: 140px;\n  }\n\n  .topic-editor .add-skill-btn {\n    width: 108px;\n  }\n\n  .topic-editor .add-story-btn {\n    width: 120px;\n  }\n\n  .topic-editor .item-list-card {\n    font-family: Roboto, Arial, sans-serif;\n    padding: 30px 55px 30px 45px;\n  }\n\n  .topic-editor .list-header {\n    border-bottom: 2px solid #000;\n    display: flex;\n    justify-content: space-between;\n    margin: 25px 0;\n  }\n\n  .topic-editor .list-header span {\n    font-weight: bold;\n  }\n\n  .topic-editor .subtopics-list-item {\n    margin: 7px 0;\n  }\n\n  .topic-editor .subtopic-name-header {\n    align-items: center;\n    background-color: #e3e3e3;\n    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2), 0 1px 1px 0 rgba(0, 0, 0, 0.14), 0 2px 1px -1px rgba(0, 0, 0, 0.12);\n    cursor: pointer;\n    display: flex;\n    justify-content: space-between;\n    padding: 10px;\n  }\n\n  .topic-editor .skill-option-box {\n    background-color: #e1dcdc;\n    border: 1px solid #000;\n    padding: 0;\n    position: absolute;\n    right: -6px;\n    width: 210px;\n    z-index: 1;\n  }\n\n  .topic-editor .uncategorized-skill-option-box {\n    background-color: #e1dcdc;\n    border: 1px solid #000;\n    padding: 0;\n    position: absolute;\n    right: 7px;\n    width: 210px;\n    z-index: 1;\n  }\n\n  .topic-editor .skill-edit-option {\n    border-bottom: 1px solid #000;\n    cursor: pointer;\n    font-size: 15px;\n    padding: 5px;\n  }\n\n  .topic-editor .uncategorized-skill-edit-option {\n    border-bottom: 1px solid #000;\n    cursor: pointer;\n    font-size: 15px;\n    padding: 5px;\n  }\n\n  .topic-editor .edit-option-assign {\n    border-bottom: none;\n  }\n\n  .topic-editor .remove-from-topic-option {\n    border-bottom: none;\n  }\n\n  .topic-editor .reassign-button {\n    color: #0b6c63;\n    cursor: pointer;\n  }\n\n  .topic-editor .subtopic-reassign-header {\n    align-items: center;\n    display: flex;\n    justify-content: space-between;\n  }\n\n  .topic-editor .subtopic-edit-options-container {\n    position: relative;\n  }\n\n  .topic-editor .subtopic-edit-options {\n    background-color: #e1dcdc;\n    border: 1px solid #2e2626;\n    padding: 2px;\n    position: absolute;\n    right: -7px;\n    top: 0;\n    width: 120px;\n  }\n\n  .topic-editor .skill-description-container {\n    align-items: center;\n    display: flex;\n    justify-content: space-between;\n    position: relative;\n  }\n\n  .topic-editor .skills-invalid {\n    background-color: #C55F4533;\n    border: 2px solid #C55F45;\n  }\n\n  .topic-editor .clickable-item:hover {\n    cursor: pointer;\n    font-weight: bold;\n  }\n\n  .topic-editor .subtopic-skill {\n    border-bottom: 1px solid #e3e3e3;\n    padding: 8px 10px 8px 32px;\n  }\n\n  .topic-editor .item-list-card-header i {\n    display: none;\n  }\n\n  .topic-editor .subtopic-skill-card-container {\n    margin-top: 64px;\n  }\n\n  .topic-editor .practice-tab-info-circle {\n    background: #000;\n    border-radius: 10px;\n    color: #FFF;\n    margin-left: 3px;\n    padding: 1px;\n  }\n\n  .topic-editor .practice-tab-checkbox {\n    box-shadow: rgb(102, 102, 102) 0 0 0 2px inset;\n  }\n\n  .topic-editor .practice-tab-text {\n    font-weight: normal;\n    padding-left: 5px;\n  }\n\n  @media screen and (max-width: 1200px) {\n    .topic-editor .topic-content-container {\n      width: 50%;\n    }\n\n    .topic-editor .topic-info-container {\n      margin-top: 34px;\n      width: 40%;\n    }\n  }\n\n  @media screen and (max-width: 1000px) {\n    .topic-editor .topic-content-container {\n      width: 55%;\n    }\n\n    .topic-editor .topic-info-container {\n      margin-top: 34px;\n      width: 45%;\n    }\n  }\n\n  @media screen and (max-width: 768px) {\n    topic-editor-tab .topic-editor {\n      margin-bottom: 15px;\n      width: 100%;\n    }\n\n    topic-editor-tab .topic-dashboard-link {\n      display: none;\n    }\n\n    .topic-editor .topic-bottom-card {\n      margin-top: 40px;\n    }\n\n    .topic-editor .item-list-card {\n      padding: 0;\n    }\n\n    .topic-editor .entity-count,\n    .topic-editor .draggable-icon-indicator {\n      display: none;\n    }\n\n    .topic-editor .subtopic-skill-card-container {\n      margin-top: inherit;\n    }\n\n    .topic-editor .item-list-card-header {\n      align-items: center;\n      display: flex;\n      justify-content: space-between;\n    }\n\n    .topic-editor .topic-editor-main-container {\n      padding: 0;\n    }\n\n    .topic-editor .skills-list-item a {\n      color: inherit;\n      text-decoration: none;\n      width: 65%;\n    }\n\n    .topic-editor .topic-card-header,\n    .topic-editor .subtopic-reassign-header,\n    .topic-editor .item-list-card-header h3 {\n      font-size: 19px;\n      margin: 0;\n    }\n\n    .topic-editor .subtopic-skill {\n      border-bottom: 1px solid #e3e3e3;\n      padding: 8px 10px 8px 20px;\n    }\n\n    .topic-editor .item-list-card-header i {\n      display: inline-block;\n      font-size: 18px;\n    }\n\n    .topic-editor .topic-content-container {\n      margin-right: 0;\n      margin-top: 30px;\n      width: 100%;\n    }\n\n    .topic-editor .subtopic-reassign-header {\n      width: 100%;\n    }\n\n    .topic-editor .reassign-button {\n      display: none;\n    }\n\n    .topic-editor .topic-info-container {\n      margin-top: 0;\n      width: 100%;\n    }\n\n    .topic-editor .add-subtopic-btn {\n      width: 44%;\n    }\n\n    .topic-editor .add-skill-btn {\n      margin-left: 3%;\n    }\n\n    .topic-editor .skill-option-box {\n      right: 40px;\n    }\n\n    .topic-editor .subtopic-edit-options {\n      right: 13px;\n    }\n\n    .topic-editor .uncategorized-skill-option-box {\n      right: 43px;\n    }\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/editor-tab/topic-editor-tab.directive.ts",
      "content": "// Copyright 2018 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Controller for the main topic editor.\n */\n\nrequire(\n  'components/common-layout-directives/common-elements/' +\n  'confirm-or-cancel-modal.controller.ts');\nrequire(\n  'components/forms/custom-forms-directives/thumbnail-uploader.component.ts');\nrequire(\n  'components/forms/custom-forms-directives/' +\n    'edit-thumbnail-modal.component.ts');\nrequire('components/entity-creation-services/story-creation.service.ts');\nrequire('domain/editor/undo_redo/undo-redo.service.ts');\nrequire('domain/topic/topic-update.service.ts');\nrequire('domain/utilities/url-interpolation.service.ts');\nrequire(\n  'pages/topic-editor-page/rearrange-skills-in-subtopics-modal.controller.ts');\nrequire(\n  'pages/topic-editor-page/modal-templates/' +\n    'change-subtopic-assignment-modal.template.controller.ts');\nrequire('pages/topic-editor-page/services/topic-editor-state.service.ts');\nrequire('pages/topic-editor-page/services/topic-editor-routing.service.ts');\nrequire('pages/topic-editor-page/services/entity-creation.service.ts');\nrequire(\n  'pages/topic-editor-page/editor-tab/topic-editor-stories-list.directive.ts');\nrequire(\n  'pages/topic-editor-page/modal-templates/preview-thumbnail.component.ts');\n\nrequire('services/context.service.ts');\nrequire('services/contextual/window-dimensions.service.ts');\nrequire('services/image-upload-helper.service.ts');\nrequire('services/page-title.service.ts');\nrequire('services/stateful/focus-manager.service.ts');\nrequire('domain/question/question-backend-api.service.ts');\nrequire(\n  'domain/topics_and_skills_dashboard/' +\n  'topics-and-skills-dashboard-backend-api.service.ts');\nrequire('base-components/loading-message.component.ts');\n\nimport { Subscription } from 'rxjs';\n\n// TODO(#9186): Change variable name to 'constants' once this file\n// is migrated to Angular.\nimport topicConstants from 'assets/constants';\n\nangular.module('oppia').directive('topicEditorTab', [\n  'UrlInterpolationService', function(UrlInterpolationService) {\n    return {\n      restrict: 'E',\n      scope: {},\n      templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n        '/pages/topic-editor-page/editor-tab/topic-editor-tab.directive.html'),\n      controller: [\n        '$rootScope', '$scope', '$uibModal', 'ContextService',\n        'EntityCreationService', 'FocusManagerService',\n        'ImageUploadHelperService',\n        'PageTitleService', 'StoryCreationService',\n        'TopicEditorRoutingService', 'TopicEditorStateService',\n        'TopicUpdateService', 'TopicsAndSkillsDashboardBackendApiService',\n        'UndoRedoService', 'UrlInterpolationService',\n        'WindowDimensionsService', 'WindowRef',\n        'MAX_CHARS_IN_META_TAG_CONTENT',\n        'MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB',\n        'MAX_CHARS_IN_TOPIC_DESCRIPTION', 'MAX_CHARS_IN_TOPIC_NAME',\n        function(\n            $rootScope, $scope, $uibModal, ContextService,\n            EntityCreationService, FocusManagerService,\n            ImageUploadHelperService,\n            PageTitleService, StoryCreationService,\n            TopicEditorRoutingService, TopicEditorStateService,\n            TopicUpdateService, TopicsAndSkillsDashboardBackendApiService,\n            UndoRedoService, UrlInterpolationService,\n            WindowDimensionsService, WindowRef,\n            MAX_CHARS_IN_META_TAG_CONTENT,\n            MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB,\n            MAX_CHARS_IN_TOPIC_DESCRIPTION, MAX_CHARS_IN_TOPIC_NAME) {\n          var ctrl = this;\n          ctrl.directiveSubscriptions = new Subscription();\n          $scope.MAX_CHARS_IN_TOPIC_URL_FRAGMENT = (\n            topicConstants.MAX_CHARS_IN_TOPIC_URL_FRAGMENT);\n          $scope.MAX_CHARS_IN_TOPIC_NAME = MAX_CHARS_IN_TOPIC_NAME;\n          $scope.MAX_CHARS_IN_TOPIC_DESCRIPTION = (\n            MAX_CHARS_IN_TOPIC_DESCRIPTION);\n          $scope.MAX_CHARS_IN_META_TAG_CONTENT = MAX_CHARS_IN_META_TAG_CONTENT;\n          $scope.MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB = (\n            MAX_CHARS_IN_PAGE_TITLE_FRAGMENT_FOR_WEB);\n          ctrl.initEditor = function() {\n            $scope.skillCreationIsAllowed = (\n              TopicEditorStateService.isSkillCreationAllowed());\n            $scope.topic = TopicEditorStateService.getTopic();\n            $scope.skillQuestionCountDict = (\n              TopicEditorStateService.getSkillQuestionCountDict());\n            $scope.topicRights = TopicEditorStateService.getTopicRights();\n            $scope.topicNameEditorIsShown = false;\n            if (TopicEditorStateService.hasLoadedTopic()) {\n              $scope.topicDataHasLoaded = true;\n              $scope.$applyAsync();\n              FocusManagerService.setFocus('addStoryBtn');\n            }\n            $scope.editableName = $scope.topic.getName();\n            $scope.editableMetaTagContent = $scope.topic.getMetaTagContent();\n            $scope.editablePageTitleFragmentForWeb = (\n              $scope.topic.getPageTitleFragmentForWeb());\n            $scope.editablePracticeIsDisplayed = (\n              $scope.topic.getPracticeTabIsDisplayed());\n            $scope.initialTopicName = $scope.topic.getName();\n            $scope.initialTopicUrlFragment = $scope.topic.getUrlFragment();\n            $scope.editableTopicUrlFragment = $scope.topic.getUrlFragment();\n            $scope.editableDescription = $scope.topic.getDescription();\n            $scope.allowedBgColors = (\n              topicConstants.ALLOWED_THUMBNAIL_BG_COLORS.topic);\n            $scope.topicNameExists = false;\n            $scope.topicUrlFragmentExists = false;\n            $scope.hostname = WindowRef.nativeWindow.location.hostname;\n\n            $scope.editableDescriptionIsEmpty = (\n              $scope.editableDescription === '');\n            $scope.topicDescriptionChanged = false;\n            $scope.subtopics = $scope.topic.getSubtopics();\n            $scope.subtopicQuestionCountDict = {};\n            $scope.subtopics.map((subtopic) => {\n              const subtopicId = subtopic.getId();\n              $scope.subtopicQuestionCountDict[subtopicId] = 0;\n              subtopic.getSkillSummaries().map((skill) => {\n                $scope.subtopicQuestionCountDict[subtopicId] += (\n                  $scope.skillQuestionCountDict[skill.id]);\n              });\n            });\n            $scope.uncategorizedSkillSummaries = (\n              $scope.topic.getUncategorizedSkillSummaries());\n            $scope.editableThumbnailDataUrl = (\n              ImageUploadHelperService\n                .getTrustedResourceUrlForThumbnailFilename(\n                  $scope.topic.getThumbnailFilename(),\n                  ContextService.getEntityType(),\n                  ContextService.getEntityId()));\n          };\n\n          $scope.getClassroomUrlFragment = function() {\n            return TopicEditorStateService.getClassroomUrlFragment();\n          };\n\n          var _initStorySummaries = function() {\n            $scope.canonicalStorySummaries =\n              TopicEditorStateService.getCanonicalStorySummaries();\n          };\n          // This is added because when we create a skill from the topic\n          // editor, it gets assigned to that topic, and to reflect that\n          // change, we need to fetch the topic again from the backend.\n          $scope.refreshTopic = function() {\n            TopicEditorStateService.loadTopic($scope.topic.getId());\n          };\n\n          $scope.getStaticImageUrl = function(imagePath) {\n            return UrlInterpolationService.getStaticImageUrl(imagePath);\n          };\n\n          $scope.toggleSubtopicCard = function(index) {\n            if ($scope.subtopicCardSelectedIndexes[index]) {\n              $scope.subtopicCardSelectedIndexes[index] = false;\n              return;\n            }\n            $scope.subtopicCardSelectedIndexes[index] = true;\n          };\n\n          $scope.reassignSkillsInSubtopics = function() {\n            $uibModal.open({\n              templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n                '/pages/topic-editor-page/modal-templates/' +\n                  'rearrange-skills-in-subtopics-modal.template.html'),\n              backdrop: 'static',\n              windowClass: 'rearrange-skills-modal',\n              controller: 'RearrangeSkillsInSubtopicsModalController',\n              controllerAs: '$ctrl',\n              size: 'xl'\n            }).result.then(function() {\n              ctrl.initEditor();\n            }, function() {\n              // Note to developers:\n              // This callback is triggered when the Cancel button is clicked.\n              // No further action is needed.\n            });\n          };\n\n          $scope.createCanonicalStory = function() {\n            if (UndoRedoService.getChangeCount() > 0) {\n              $uibModal.open({\n                templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n                  '/pages/topic-editor-page/modal-templates/' +\n                  'topic-save-pending-changes-modal.template.html'),\n                backdrop: true,\n                controller: 'ConfirmOrCancelModalController'\n              }).result.then(function() {}, function() {\n                // Note to developers:\n                // This callback is triggered when the Cancel button is clicked.\n                // No further action is needed.\n              });\n            } else {\n              StoryCreationService.createNewCanonicalStory();\n            }\n          };\n\n          $scope.createSkill = function() {\n            if (UndoRedoService.getChangeCount() > 0) {\n              $uibModal.open({\n                templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n                  '/pages/topic-editor-page/modal-templates/' +\n                    'topic-save-pending-changes-modal.template.html'),\n                backdrop: true,\n                controller: 'ConfirmOrCancelModalController'\n              }).result.then(function() {}, function() {\n                // Note to developers:\n                // This callback is triggered when the Cancel button is clicked.\n                // No further action is needed.\n              });\n            } else {\n              EntityCreationService.createSkill();\n            }\n          };\n\n          $scope.createSubtopic = function() {\n            EntityCreationService.createSubtopic($scope.topic);\n          };\n\n          $scope.updateTopicDescriptionStatus = function(description) {\n            $scope.editableDescriptionIsEmpty = (description === '');\n            $scope.topicDescriptionChanged = true;\n          };\n\n          $scope.updateTopicName = function(newName) {\n            if (newName === $scope.initialTopicName) {\n              $scope.topicNameExists = false;\n              return;\n            }\n            if (newName) {\n              TopicEditorStateService.updateExistenceOfTopicName(\n                newName, function() {\n                  $scope.topicNameExists = (\n                    TopicEditorStateService.getTopicWithNameExists());\n                  TopicUpdateService.setTopicName($scope.topic, newName);\n                  $scope.topicNameEditorIsShown = false;\n                  $rootScope.$applyAsync();\n                });\n            } else {\n              TopicUpdateService.setTopicName($scope.topic, newName);\n              $scope.topicNameEditorIsShown = false;\n            }\n          };\n\n          $scope.updateTopicUrlFragment = function(newTopicUrlFragment) {\n            if (newTopicUrlFragment === $scope.initialTopicUrlFragment) {\n              $scope.topicUrlFragmentExists = false;\n              return;\n            }\n            if (newTopicUrlFragment) {\n              TopicEditorStateService.updateExistenceOfTopicUrlFragment(\n                newTopicUrlFragment, function() {\n                  $scope.topicUrlFragmentExists = (\n                    TopicEditorStateService.getTopicWithUrlFragmentExists());\n                  TopicUpdateService.setTopicUrlFragment(\n                    $scope.topic, newTopicUrlFragment);\n                  $rootScope.$applyAsync();\n                });\n            } else {\n              TopicUpdateService.setTopicUrlFragment(\n                $scope.topic, newTopicUrlFragment);\n            }\n          };\n\n          $scope.updateTopicThumbnailFilename = function(newThumbnailFilename) {\n            if (newThumbnailFilename === $scope.topic.getThumbnailFilename()) {\n              return;\n            }\n            TopicUpdateService.setTopicThumbnailFilename(\n              $scope.topic, newThumbnailFilename);\n          };\n\n          $scope.updateTopicThumbnailBgColor = function(newThumbnailBgColor) {\n            if (newThumbnailBgColor === $scope.topic.getThumbnailBgColor()) {\n              return;\n            }\n            TopicUpdateService.setTopicThumbnailBgColor(\n              $scope.topic, newThumbnailBgColor);\n            $scope.$applyAsync();\n          };\n\n          $scope.updateTopicDescription = function(newDescription) {\n            if (newDescription !== $scope.topic.getDescription()) {\n              TopicUpdateService.setTopicDescription(\n                $scope.topic, newDescription);\n            }\n          };\n\n          $scope.updateTopicMetaTagContent = function(newMetaTagContent) {\n            if (newMetaTagContent !== $scope.topic.getMetaTagContent()) {\n              TopicUpdateService.setMetaTagContent(\n                $scope.topic, newMetaTagContent);\n            }\n          };\n\n          $scope.updateTopicPageTitleFragmentForWeb = function(\n              newTopicPageTitleFragmentForWeb) {\n            let currentValue = $scope.topic.getPageTitleFragmentForWeb();\n            if (newTopicPageTitleFragmentForWeb !== currentValue) {\n              TopicUpdateService.setPageTitleFragmentForWeb(\n                $scope.topic, newTopicPageTitleFragmentForWeb);\n            }\n          };\n\n          $scope.updatePracticeTabIsDisplayed = function(\n              newPracticeTabIsDisplayed) {\n            if (\n              newPracticeTabIsDisplayed !==\n              $scope.topic.getPracticeTabIsDisplayed()) {\n              TopicUpdateService.setPracticeTabIsDisplayed(\n                $scope.topic, newPracticeTabIsDisplayed);\n            }\n          };\n\n          $scope.deleteUncategorizedSkillFromTopic = function(skillSummary) {\n            TopicUpdateService.removeUncategorizedSkill(\n              $scope.topic, skillSummary);\n            ctrl.initEditor();\n          };\n\n          $scope.removeSkillFromSubtopic = function(subtopicId, skillSummary) {\n            $scope.selectedSkillEditOptionsIndex = {};\n            TopicUpdateService.removeSkillFromSubtopic(\n              $scope.topic, subtopicId, skillSummary);\n            ctrl.initEditor();\n          };\n\n          $scope.removeSkillFromTopic = function(subtopicId, skillSummary) {\n            $scope.selectedSkillEditOptionsIndex = {};\n            TopicUpdateService.removeSkillFromSubtopic(\n              $scope.topic, subtopicId, skillSummary);\n            $scope.deleteUncategorizedSkillFromTopic(skillSummary);\n          };\n\n          $scope.togglePreview = function() {\n            $scope.topicPreviewCardIsShown = !($scope.topicPreviewCardIsShown);\n          };\n\n          $scope.deleteSubtopic = function(subtopicId) {\n            TopicEditorStateService.deleteSubtopicPage(\n              $scope.topic.getId(), subtopicId);\n            TopicUpdateService.deleteSubtopic($scope.topic, subtopicId);\n            ctrl.initEditor();\n          };\n\n          $scope.navigateToSubtopic = function(subtopicId, subtopicName) {\n            PageTitleService.setPageTitleForMobileView('Subtopic Editor');\n            PageTitleService.setPageSubtitleForMobileView(subtopicName);\n            TopicEditorRoutingService.navigateToSubtopicEditorWithId(\n              subtopicId);\n          };\n\n          $scope.getSkillEditorUrl = function(skillId) {\n            var SKILL_EDITOR_URL_TEMPLATE = '/skill_editor/<skillId>';\n            return UrlInterpolationService.interpolateUrl(\n              SKILL_EDITOR_URL_TEMPLATE, {\n                skillId: skillId\n              }\n            );\n          };\n\n          $scope.navigateToSkill = function(skillId) {\n            TopicEditorRoutingService.navigateToSkillEditorWithId(skillId);\n          };\n\n          $scope.getPreviewFooter = function() {\n            var canonicalStoriesLength = (\n              $scope.topic.getCanonicalStoryIds().length);\n            if (canonicalStoriesLength === 0 || canonicalStoriesLength > 1) {\n              return canonicalStoriesLength + ' Stories';\n            }\n            return '1 Story';\n          };\n\n          $scope.togglePreviewListCards = function(listType) {\n            if (!WindowDimensionsService.isWindowNarrow()) {\n              return;\n            }\n            if (listType === $scope.SUBTOPIC_LIST) {\n              $scope.subtopicsListIsShown = !$scope.subtopicsListIsShown;\n            } else if (listType === $scope.STORY_LIST) {\n              $scope.storiesListIsShown = !$scope.storiesListIsShown;\n            } else {\n              $scope.mainTopicCardIsShown = !$scope.mainTopicCardIsShown;\n            }\n          };\n\n          $scope.showSubtopicEditOptions = function(index) {\n            $scope.subtopicEditOptionsAreShown = (\n                ($scope.subtopicEditOptionsAreShown === index) ? null : index);\n          };\n\n          $scope.toggleUncategorizedSkillOptions = function(index) {\n            $scope.uncategorizedEditOptionsIndex = (\n                ($scope.uncategorizedEditOptionsIndex === index) ?\n                    null : index);\n          };\n\n          $scope.changeSubtopicAssignment = function(\n              oldSubtopicId, skillSummary) {\n            $uibModal.open({\n              templateUrl: UrlInterpolationService.getDirectiveTemplateUrl(\n                '/pages/topic-editor-page/modal-templates/' +\n                      'change-subtopic-assignment-modal.template.html'),\n              backdrop: 'static',\n              resolve: {\n                subtopics: () => $scope.subtopics\n              },\n              controller: 'ChangeSubtopicAssignmentModalController'\n            }).result.then(function(newSubtopicId) {\n              if (oldSubtopicId === newSubtopicId) {\n                return;\n              }\n              TopicUpdateService.moveSkillToSubtopic(\n                $scope.topic, oldSubtopicId, newSubtopicId,\n                skillSummary);\n              ctrl.initEditor();\n            }, function() {\n              // Note to developers:\n              // This callback is triggered when the Cancel button is clicked.\n              // No further action is needed.\n            });\n          };\n\n          $scope.onRearrangeSubtopicStart = function(fromIndex) {\n            $scope.fromIndex = fromIndex;\n          };\n\n          $scope.onRearrangeSubtopicEnd = function(toIndex) {\n            if ($scope.fromIndex === toIndex) {\n              return;\n            }\n            TopicUpdateService.rearrangeSubtopic(\n              $scope.topic, $scope.fromIndex, toIndex);\n            ctrl.initEditor();\n          };\n\n          $scope.showSkillEditOptions = function(subtopicIndex, skillIndex) {\n            if (Object.keys($scope.selectedSkillEditOptionsIndex).length) {\n              $scope.selectedSkillEditOptionsIndex = {};\n              return;\n            }\n            $scope.selectedSkillEditOptionsIndex[subtopicIndex] = {};\n            $scope.selectedSkillEditOptionsIndex[subtopicIndex] = {\n              [skillIndex]: true\n            };\n          };\n\n          ctrl.$onInit = function() {\n            FocusManagerService.setFocus('addStoryBtn');\n            $scope.topicPreviewCardIsShown = false;\n            $scope.SUBTOPIC_LIST = 'subtopic';\n            $scope.SKILL_LIST = 'skill';\n            $scope.STORY_LIST = 'story';\n            $scope.topicDataHasLoaded = false;\n            $scope.subtopicCardSelectedIndexes = {};\n            $scope.selectedSkillEditOptionsIndex = {};\n            $scope.subtopicsListIsShown = (\n              !WindowDimensionsService.isWindowNarrow());\n            $scope.storiesListIsShown = (\n              !WindowDimensionsService.isWindowNarrow());\n            ctrl.directiveSubscriptions.add(\n              TopicEditorStateService.onTopicInitialized.subscribe(\n                () => ctrl.initEditor()\n              ));\n            ctrl.directiveSubscriptions.add(\n              TopicEditorStateService.onTopicReinitialized.subscribe(\n                () => ctrl.initEditor()\n              ));\n            $scope.mainTopicCardIsShown = true;\n\n            ctrl.directiveSubscriptions.add(\n              TopicEditorStateService.onStorySummariesInitialized.subscribe(\n                () => _initStorySummaries()\n              )\n            );\n            ctrl.directiveSubscriptions.add(\n              TopicsAndSkillsDashboardBackendApiService.\n                onTopicsAndSkillsDashboardReinitialized.subscribe(\n                  () => {\n                    $scope.refreshTopic();\n                  }\n                )\n            );\n            ctrl.initEditor();\n            _initStorySummaries();\n          };\n          ctrl.$onDestroy = function() {\n            ctrl.directiveSubscriptions.unsubscribe();\n          };\n        }\n      ]\n    };\n  }]);\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/modal-templates/create-new-story-modal.controller.spec.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Unit tests for CreateNewStoryModalController.\n */\n\nimport { HttpClientTestingModule } from '@angular/common/http/testing';\nimport { TestBed } from '@angular/core/testing';\n\nimport { EditableStoryBackendApiService } from\n  'domain/story/editable-story-backend-api.service';\nimport { importAllAngularServices } from 'tests/unit-test-utils';\n\nimport CONSTANTS from 'assets/constants';\n\ndescribe('Create New Story Modal Controller', function() {\n  var $scope = null;\n  var $uibModalInstance = null;\n  var ImageLocalStorageService = null;\n  var StoryEditorStateService = null;\n\n  importAllAngularServices();\n\n  beforeEach(angular.mock.module('oppia'));\n\n  importAllAngularServices();\n\n  beforeEach(() => {\n    TestBed.configureTestingModule({\n      imports: [HttpClientTestingModule],\n      providers: [EditableStoryBackendApiService]\n    });\n  });\n  beforeEach(angular.mock.module('oppia', function($provide) {\n    $provide.value(\n      'EditableStoryBackendApiService',\n      TestBed.get(EditableStoryBackendApiService));\n  }));\n\n  beforeEach(angular.mock.inject(function($injector, $controller) {\n    var $rootScope = $injector.get('$rootScope');\n\n    $uibModalInstance = jasmine.createSpyObj(\n      '$uibModalInstance', ['close', 'dismiss']);\n    ImageLocalStorageService = $injector.get('ImageLocalStorageService');\n    StoryEditorStateService = $injector.get('StoryEditorStateService');\n\n    spyOn(ImageLocalStorageService, 'getStoredImagesData').and.returnValue(\n      [{filename: 'a.png', image: 'faf'}]);\n\n    $scope = $rootScope.$new();\n    $controller('CreateNewStoryModalController', {\n      $scope: $scope,\n      $uibModalInstance: $uibModalInstance,\n      ImageLocalStorageService: ImageLocalStorageService\n    });\n  }));\n\n  it('should check if properties was initialized correctly', function() {\n    expect($scope.story.title).toBe('');\n    expect($scope.story.description).toBe('');\n    expect($scope.MAX_CHARS_IN_STORY_TITLE).toBe(\n      CONSTANTS.MAX_CHARS_IN_STORY_TITLE);\n  });\n\n  it('should check if url fragment already exists', function() {\n    spyOn(\n      StoryEditorStateService,\n      'updateExistenceOfStoryUrlFragment').and.callFake(\n      (urlFragment, callback) => callback());\n    spyOn(\n      StoryEditorStateService,\n      'getStoryWithUrlFragmentExists').and.returnValue(true);\n    expect($scope.storyUrlFragmentExists).toBeFalse();\n    $scope.story.urlFragment = 'test-url';\n    $scope.onStoryUrlFragmentChange();\n    expect($scope.storyUrlFragmentExists).toBeTrue();\n  });\n\n  it('should not update story url fragment existence for empty url fragment',\n    function() {\n      spyOn(StoryEditorStateService, 'updateExistenceOfStoryUrlFragment');\n      $scope.story.urlFragment = '';\n      $scope.onStoryUrlFragmentChange();\n      expect(\n        StoryEditorStateService.updateExistenceOfStoryUrlFragment\n      ).not.toHaveBeenCalled();\n    });\n\n  it('should check if the story is valid', function() {\n    expect($scope.isValid()).toBe(false);\n\n    $scope.story.title = 'title';\n    expect($scope.isValid()).toBe(false);\n\n    $scope.story.description = 'description';\n    expect($scope.isValid()).toBe(false);\n\n    $scope.story.urlFragment = '';\n    expect($scope.isValid()).toBe(false);\n\n    $scope.story.urlFragment = 'ABC 123';\n    expect($scope.isValid()).toBe(false);\n\n    $scope.story.urlFragment = 'valid-url';\n    expect($scope.isValid()).toBe(true);\n\n    $scope.story.title = '';\n    expect($scope.isValid()).toBe(false);\n  });\n\n  it ('should update View when thumbnail has been uploaded', function() {\n    $scope.updateView();\n  });\n});\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/modal-templates/create-new-story-modal.controller.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Controller for create new story modal.\n */\nimport { NewlyCreatedStory } from 'domain/topic/newly-created-story.model';\n\nrequire(\n  'components/common-layout-directives/common-elements/' +\n  'confirm-or-cancel-modal.controller.ts');\n\nrequire('pages/story-editor-page/services/story-editor-state.service.ts');\nrequire('pages/topic-editor-page/services/topic-editor-state.service.ts');\nrequire('services/context.service.ts');\nrequire('services/image-local-storage.service.ts');\n\nimport newStoryConstants from 'assets/constants';\n\nangular.module('oppia').controller('CreateNewStoryModalController', [\n  '$controller', '$rootScope', '$scope', '$uibModalInstance',\n  'ImageLocalStorageService', 'StoryEditorStateService',\n  'TopicEditorStateService', 'WindowRef', 'MAX_CHARS_IN_STORY_DESCRIPTION',\n  'MAX_CHARS_IN_STORY_TITLE', 'MAX_CHARS_IN_STORY_URL_FRAGMENT',\n  function(\n      $controller, $rootScope, $scope, $uibModalInstance,\n      ImageLocalStorageService, StoryEditorStateService,\n      TopicEditorStateService, WindowRef, MAX_CHARS_IN_STORY_DESCRIPTION,\n      MAX_CHARS_IN_STORY_TITLE, MAX_CHARS_IN_STORY_URL_FRAGMENT) {\n    $controller('ConfirmOrCancelModalController', {\n      $scope: $scope,\n      $uibModalInstance: $uibModalInstance\n    });\n    $scope.validUrlFragmentRegex = new RegExp(\n      newStoryConstants.VALID_URL_FRAGMENT_REGEX);\n    $scope.story = NewlyCreatedStory.createDefault();\n    $scope.MAX_CHARS_IN_STORY_TITLE = MAX_CHARS_IN_STORY_TITLE;\n    $scope.MAX_CHARS_IN_STORY_URL_FRAGMENT = MAX_CHARS_IN_STORY_URL_FRAGMENT;\n    $scope.MAX_CHARS_IN_STORY_DESCRIPTION = MAX_CHARS_IN_STORY_DESCRIPTION;\n    $scope.allowedBgColors = (\n      newStoryConstants.ALLOWED_THUMBNAIL_BG_COLORS.story);\n    $scope.storyUrlFragmentExists = false;\n    $scope.hostname = WindowRef.nativeWindow.location.hostname;\n    $scope.classroomUrlFragment = (\n      TopicEditorStateService.getClassroomUrlFragment());\n    $scope.topicUrlFragment = (\n      TopicEditorStateService.getTopic().getUrlFragment());\n    $scope.onStoryUrlFragmentChange = function() {\n      if (!$scope.story.urlFragment) {\n        return;\n      }\n      StoryEditorStateService.updateExistenceOfStoryUrlFragment(\n        $scope.story.urlFragment, function() {\n          $scope.storyUrlFragmentExists = (\n            StoryEditorStateService.getStoryWithUrlFragmentExists());\n          $rootScope.$applyAsync();\n        });\n    };\n\n    $scope.updateView = function() {\n      $scope.$applyAsync();\n    };\n\n    $scope.isValid = function() {\n      return Boolean(\n        $scope.story.isValid() &&\n        ImageLocalStorageService.getStoredImagesData().length > 0 &&\n        !$scope.storyUrlFragmentExists);\n    };\n  }\n]);\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/modal-templates/create-new-story-modal.template.html",
      "content": "<div class=\"modal-header create-new-story-header\">\n  <h3>\n    New Story\n  </h3>\n</div>\n<form ng-submit=\"confirm(story)\">\n  <div class=\"modal-body create-new-story\">\n    <div class=\"story-input\">\n      <div class=\"story-input-header\">\n        <span>Title*</span>\n      </div>\n      <input class=\"form-control protractor-test-new-story-title-field required\" ng-model=\"story.title\" maxlength=\"<[MAX_CHARS_IN_STORY_TITLE]>\" aria-label=\"Title\" autofocus>\n      <div>\n        <span class=\"oppia-input-box-subtitle\">\n          <em>\n            Story title should be at most <[MAX_CHARS_IN_STORY_TITLE]> characters.\n          </em>\n        </span>\n      </div>\n    </div>\n    <div class=\"story-input story-input-description\">\n      <div class=\"story-input-header\">\n        <span>Description*</span>\n      </div>\n      <textarea rows=\"3\" cols=\"50\" maxlength=\"<[MAX_CHARS_IN_STORY_DESCRIPTION]>\" ng-model=\"story.description\" class=\"form-control protractor-test-new-story-description-field required\" aria-label=\"Description\"></textarea>\n      <span class=\"oppia-input-box-subtitle\">\n        <em>\n          Story description should be at most\n          <[MAX_CHARS_IN_STORY_DESCRIPTION]> characters.\n        </em>\n      </span>\n    </div>\n    <div class=\"story-input\">\n      <div class=\"story-input-header\">\n        <span>Url Fragment*</span>\n      </div>\n      <input class=\"form-control protractor-test-new-story-url-fragment-field\" ng-model=\"story.urlFragment\" maxlength=\"<[MAX_CHARS_IN_STORY_URL_FRAGMENT]>\"\n             ng-class=\"{'is-invalid': storyUrlFragmentExists || !validUrlFragmentRegex.test(story.urlFragment)}\"\n             ng-change=\"onStoryUrlFragmentChange()\"\n             aria-label=\"Url fragment\">\n      <div>\n        <span class=\"oppia-input-box-subtitle\">\n          <em>\n            The story URL fragment is used to uniquely access the story viewer page. It should consist of one or more hyphen-separated words, all in lowercase, with at most <[MAX_CHARS_IN_STORY_URL_FRAGMENT]> characters in total and must be unique across the topic. Please use meaningful keywords, and avoid using words like \"and\", \"of\", or \"the\".\n            This story can be accessed at the following URL:<br>\n            <[hostname]>/learn/<[classroomUrlFragment]>/<[topicUrlFragment]>/story/<[story.urlFragment]>\n          </em>\n        </span>\n        <div ng-if=\"storyUrlFragmentExists\" class=\"oppia-input-box-subtitle text-danger\">\n          <em>\n            This story URL fragment already exists.\n          </em>\n        </div>\n      </div>\n    </div>\n    <div class=\"story-input story-input-thumbnail\">\n      <div class=\"story-input-header\">\n        <span>Thumbnail Image*</span>\n      </div>\n      <oppia-thumbnail-uploader [preview-title]=\"story.title\"\n                                [aspect-ratio]=\"'4:3'\"\n                                [disabled]=\"false\"\n                                [use-local-storage]=\"true\"\n                                [allowed-bg-colors]=\"allowedBgColors\"\n                                [thumbnail-bg-color]=\"story.getThumbnailBgColor()\"\n                                preview-description-bg-color=\"#2F6687\"\n                                (image-save)=\"updateView()\">\n      </oppia-thumbnail-uploader>\n    </div>\n  </div>\n  <div class=\"modal-footer\">\n    <button class=\"btn btn-secondary\" ng-click=\"cancel()\" type=\"button\">Cancel</button>\n    <button class=\"btn btn-success protractor-test-confirm-story-creation-button\" type=\"submit\" ng-disabled=\"!isValid()\">\n      <span>Create Story</span>\n    </button>\n  </div>\n</form>\n<style>\n  .create-new-story-header h3 {\n    font-size: 28px;\n  }\n  .create-new-story .story-input {\n    padding: 10px 10px 16px;\n  }\n  .create-new-story input {\n    width: 70%;\n  }\n  .story-input-description input {\n    width: 95%;\n  }\n  .create-new-story .story-input-header span {\n    font-weight: bold;\n  }\n  .create-new-story .story-input-thumbnail {\n    padding-top: 15px;\n  }\n  .create-new-story .ng-touched.ng-empty.required {\n     outline: 1px solid #F00;\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/modal-templates/create-new-subtopic-modal.controller.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Controller for create new subtopic modal controller.\n */\n\nrequire(\n  'components/common-layout-directives/common-elements/' +\n  'confirm-or-cancel-modal.controller.ts');\nrequire('domain/topic/topic-update.service.ts');\nrequire('pages/topic-editor-page/services/topic-editor-state.service.ts');\nrequire('pages/topic-editor-page/services/subtopic-validation-service.ts');\n\nimport createSubtopicConstants from 'assets/constants';\nimport { SubtopicPage } from 'domain/topic/subtopic-page.model';\n\nangular.module('oppia').controller('CreateNewSubtopicModalController', [\n  '$controller', '$scope', '$uibModalInstance',\n  'SubtopicValidationService',\n  'TopicEditorStateService', 'TopicUpdateService', 'WindowRef',\n  'topic', 'MAX_CHARS_IN_SUBTOPIC_TITLE',\n  'MAX_CHARS_IN_SUBTOPIC_URL_FRAGMENT',\n  function(\n      $controller, $scope, $uibModalInstance,\n      SubtopicValidationService,\n      TopicEditorStateService, TopicUpdateService, WindowRef,\n      topic, MAX_CHARS_IN_SUBTOPIC_TITLE,\n      MAX_CHARS_IN_SUBTOPIC_URL_FRAGMENT) {\n    $controller('ConfirmOrCancelModalController', {\n      $scope: $scope,\n      $uibModalInstance: $uibModalInstance\n    });\n    var ctrl = this;\n\n    ctrl.$onInit = function() {\n      ctrl.hostname = WindowRef.nativeWindow.location.hostname;\n      ctrl.classroomUrlFragment = (\n        TopicEditorStateService.getClassroomUrlFragment());\n      ctrl.topic = topic;\n      ctrl.SUBTOPIC_PAGE_SCHEMA = {\n        type: 'html',\n        ui_config: {\n          rows: 100\n        }\n      };\n      ctrl.htmlData = '';\n      ctrl.schemaEditorIsShown = false;\n      ctrl.editableThumbnailFilename = '';\n      ctrl.editableThumbnailBgColor = '';\n      ctrl.editableUrlFragment = '';\n      ctrl.allowedBgColors = (\n        createSubtopicConstants.ALLOWED_THUMBNAIL_BG_COLORS.subtopic);\n      ctrl.subtopicId = ctrl.topic.getNextSubtopicId();\n      ctrl.MAX_CHARS_IN_SUBTOPIC_TITLE = MAX_CHARS_IN_SUBTOPIC_TITLE;\n      ctrl.MAX_CHARS_IN_SUBTOPIC_URL_FRAGMENT = (\n        MAX_CHARS_IN_SUBTOPIC_URL_FRAGMENT);\n      ctrl.subtopicTitle = '';\n      ctrl.errorMsg = null;\n      ctrl.subtopicUrlFragmentExists = false;\n      TopicUpdateService.addSubtopic(ctrl.topic, ctrl.subtopicTitle);\n    };\n\n    ctrl.showSchemaEditor = function() {\n      ctrl.schemaEditorIsShown = true;\n    };\n\n    ctrl.updateSubtopicThumbnailFilename = function(\n        newThumbnailFilename) {\n      ctrl.editableThumbnailFilename = newThumbnailFilename;\n      TopicUpdateService.setSubtopicThumbnailFilename(\n        ctrl.topic, ctrl.subtopicId, newThumbnailFilename);\n    };\n\n    ctrl.updateSubtopicThumbnailBgColor = function(\n        newThumbnailBgColor) {\n      ctrl.editableThumbnailBgColor = newThumbnailBgColor;\n      TopicUpdateService.setSubtopicThumbnailBgColor(\n        ctrl.topic, ctrl.subtopicId, newThumbnailBgColor);\n      $scope.$applyAsync();\n    };\n\n    ctrl.resetErrorMsg = function() {\n      ctrl.errorMsg = null;\n    };\n    ctrl.isSubtopicValid = function() {\n      return Boolean(\n        ctrl.editableThumbnailFilename &&\n        ctrl.subtopicTitle &&\n        ctrl.htmlData &&\n        ctrl.editableUrlFragment &&\n        ctrl.isUrlFragmentValid());\n    };\n\n    ctrl.cancel = function() {\n      TopicEditorStateService.deleteSubtopicPage(\n        ctrl.topic.getId(), ctrl.subtopicId);\n      TopicUpdateService.deleteSubtopic(ctrl.topic, ctrl.subtopicId);\n      TopicEditorStateService.onTopicReinitialized.emit();\n      $uibModalInstance.dismiss('cancel');\n    };\n\n    ctrl.isUrlFragmentValid = function() {\n      return SubtopicValidationService.isUrlFragmentValid(\n        ctrl.editableUrlFragment);\n    };\n\n    ctrl.checkSubtopicExistence = function() {\n      ctrl.subtopicUrlFragmentExists = (\n        SubtopicValidationService.doesSubtopicWithUrlFragmentExist(\n          ctrl.editableUrlFragment));\n    };\n\n    ctrl.save = function() {\n      if (!SubtopicValidationService.checkValidSubtopicName(\n        ctrl.subtopicTitle)) {\n        ctrl.errorMsg = 'A subtopic with this title already exists';\n        return;\n      }\n\n      TopicUpdateService.setSubtopicTitle(\n        ctrl.topic, ctrl.subtopicId, ctrl.subtopicTitle);\n      TopicUpdateService.setSubtopicUrlFragment(\n        ctrl.topic, ctrl.subtopicId, ctrl.editableUrlFragment);\n\n      ctrl.subtopicPage = SubtopicPage.createDefault(\n        ctrl.topic.getId(), ctrl.subtopicId);\n\n      var subtitledHtml = angular.copy(\n        ctrl.subtopicPage.getPageContents().getSubtitledHtml());\n      subtitledHtml.html = ctrl.htmlData;\n      TopicUpdateService.setSubtopicPageContentsHtml(\n        ctrl.subtopicPage, ctrl.subtopicId, subtitledHtml);\n      ctrl.subtopicPage.getPageContents().setHtml(ctrl.htmlData);\n      TopicEditorStateService.setSubtopicPage(ctrl.subtopicPage);\n      TopicUpdateService.setSubtopicTitle(\n        ctrl.topic, ctrl.subtopicId, ctrl.subtopicTitle);\n      $uibModalInstance.close(ctrl.subtopicId);\n    };\n  }\n]);\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/modal-templates/create-new-subtopic-modal.template.html",
      "content": "<div class=\"oppia-create-new-subtopic-container\">\n  <div class=\"modal-header\">\n    <h3>\n      Create New Subtopic\n    </h3>\n  </div>\n  <div ng-if=\"$ctrl.topic.getSubtopicById($ctrl.subtopicId)\">\n    <div class=\"modal-body new-subtopic-editor protractor-test-new-subtopic-editor\">\n      <div class=\"create-new-subtopic-input-field\">\n        <div>\n          <strong>Title*</strong>\n        </div>\n        <input class=\"form-control oppia-new-subtopic-editable-field protractor-test-new-subtopic-title-field required\"\n               placeholder=\"Enter a brief description for the subtopic that students can easily understand, e.g. 'Adding Fractions'\"\n               ng-model=\"$ctrl.subtopicTitle\" ng-change=\"$ctrl.resetErrorMsg()\" maxlength=\"<[$ctrl.MAX_CHARS_IN_SUBTOPIC_TITLE]>\" autofocus>\n        <span class=\"oppia-input-box-subtitle\">\n          <em>\n            Subtopic title should be at most <[$ctrl.MAX_CHARS_IN_SUBTOPIC_TITLE]> characters.\n          </em>\n        </span>\n        <span class=\"form-text error-msg\" ng-if=\"$ctrl.errorMsg\">\n          <em><[$ctrl.errorMsg]></em>\n        </span>\n      </div>\n      <div>\n        <strong>Enter the url fragment for the subtopic*</strong>\n      </div>\n      <input class=\"form-control oppia-new-subtopic-editable-field protractor-test-new-subtopic-url-fragment-field\"\n             ng-class=\"{'is-invalid': $ctrl.editableUrlFragment && (!$ctrl.isUrlFragmentValid() || $ctrl.subtopicUrlFragmentExists)}\"\n             placeholder=\"Enter a url fragment for the subtopic.\"\n             ng-model=\"$ctrl.editableUrlFragment\" ng-change=\"$ctrl.checkSubtopicExistence()\" maxlength=\"<[$ctrl.MAX_CHARS_IN_SUBTOPIC_URL_FRAGMENT]>\">\n      <span class=\"oppia-input-box-subtitle\">\n        <em>\n          The subtopic URL fragment is used to uniquely access the subtopic viewer page. It should consist of one or more hyphen-separated words, all in lowercase, with at most <[$ctrl.MAX_CHARS_IN_SUBTOPIC_URL_FRAGMENT]> characters in total and must be unique across the topic. Please use meaningful keywords, and avoid using words like \"and\", \"of\", or \"the\".\n          This subtopic can be accessed at the following URL:<br>\n          <[$ctrl.hostname]>/learn/<[$ctrl.classroomUrlFragment]>/<[$ctrl.topic.getUrlFragment()]>/revision/<[$ctrl.editableUrlFragment]>\n        </em>\n      </span>\n      <div class=\"oppia-input-box-subtitle text-danger\" ng-if=\"$ctrl.editableUrlFragment && $ctrl.subtopicUrlFragmentExists\">\n        <em>The subtopic url fragment is not unique.</em>\n      </div>\n\n      <div class=\"create-new-subtopic-input-field create-new-subtopic-content\">\n        <div>\n          <strong>Explanation of the subtopic*</strong>\n        </div>\n        <div class=\"description-editor protractor-test-subtopic-description-editor\" ng-if=\"$ctrl.schemaEditorIsShown\">\n          <div class=\"oppia-editor-card-body\" >\n            <schema-based-editor schema=\"$ctrl.SUBTOPIC_PAGE_SCHEMA\"\n                                 class=\"protractor-test-create-subtopic-page-content\"\n                                 local-value=\"$ctrl.htmlData\">\n            </schema-based-editor>\n          </div>\n        </div>\n\n        <div ng-if=\"!$ctrl.schemaEditorIsShown\" ng-click=\"$ctrl.showSchemaEditor()\" class=\"protractor-test-show-schema-editor\">\n          <span class=\"oppia-placeholder\">\n              Give a description or explanation of the subtopic.\n            <i class=\"fa fa-pen\"></i>\n          </span>\n        </div>\n      </div>\n\n      <div class=\"thumbnail-editor create-new-subtopic-input-field\">\n        <strong>Thubmnail Image*</strong>\n        <oppia-thumbnail-uploader [filename]=\"$ctrl.editableThumbnailFilename\"\n                                  (update-filename)=\"$ctrl.updateSubtopicThumbnailFilename($event)\"\n                                  [bg-color]=\"$ctrl.editableThumbnailBgColor\"\n                                  (update-bg-color)=\"$ctrl.updateSubtopicThumbnailBgColor($event)\"\n                                  [allowed-bg-colors]=\"$ctrl.allowedBgColors\"\n                                  [aspect-ratio]=\"'4:3'\"\n                                  [preview-title]=\"$ctrl.subtopicTitle\"\n                                  preview-description-bg-color=\"#BE563C\">\n        </oppia-thumbnail-uploader>\n      </div>\n    </div>\n  </div>\n  <div class=\"modal-footer\">\n    <button class=\"btn btn-secondary\" ng-click=\"$ctrl.cancel()\" type=\"button\">Cancel</button>\n    <button class=\"btn btn-success protractor-test-confirm-subtopic-creation-button\"\n            type=\"submit\" ng-disabled=\"!$ctrl.isSubtopicValid() || $ctrl.subtopicUrlFragmentExists\" ng-click=\"$ctrl.save()\">\n      Create Subtopic\n    </button>\n  </div>\n</div>\n<style>\n  .new-subtopic-editor .form-text {\n    margin-left: 37.5%;\n    margin-top: -3%;\n  }\n  .new-subtopic-editor .thumbnail-editor {\n    margin: 25px 0;\n  }\n  .new-subtopic-editor .description-editor {\n    margin: 10px 0 0;\n  }\n  .new-subtopic-editor .error-msg {\n    color: #f00;\n    font-size: smaller;\n    margin: 10px 0 0;\n  }\n  .oppia-create-new-subtopic-container .create-new-subtopic-content {\n    margin: 15px 0;\n  }\n  .oppia-create-new-subtopic-container .oppia-new-subtopic-editable-field {\n    font-size: 12px;\n  }\n  @media screen and (max-width: 768px) {\n    .create-new-subtopic .modal-dialog {\n      border: 0;\n      border-radius: 0;\n      margin: 0;\n      padding: 0;\n      width: 100vw;\n    }\n    .create-new-subtopic .modal-content {\n      border: 0;\n      border-radius: 0;\n      height: 100vh;\n      overflow: auto;\n    }\n    .create-new-subtopic .modal-header {\n      align-items: center;\n      background-color: #00609C;\n      display: flex;\n    }\n    .create-new-subtopic .modal-header h3 {\n      color: #FFF;\n    }\n    .create-new-subtopic .create-new-subtopic-input-field {\n      margin: 25px 0;\n    }\n    .create-new-subtopic .modal-close-button {\n      color: #FFF;\n      display: block;\n      font-size: 20px;\n    }\n    .create-new-subtopic .ng-touched.ng-empty.required {\n     outline: 1px solid #F00;\n    }\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/modal-templates/preview-thumbnail.component.html",
      "content": "<div class=\"oppia-thumbnail-container protractor-test-thumbnail-container\"\n     [ngStyle]=\"{width: aspectRatio === '4:3' ? '248px' : '280px' }\">\n  <oppia-thumbnail-display [classes]=\"['oppia-thumbnail-image']\"\n                           [imgSrc]=\"editableThumbnailDataUrl\"\n                           [background]=\"thumbnailBgColor\"\n                           [aspectRatio]=\"'16:9'\">\n  </oppia-thumbnail-display>\n  <div class=\"oppia-thumbnail-preview-title\">\n      {{ name }}\n  </div>\n  <div class=\"oppia-thumbnail-preview-footer\">\n    {{ previewFooter }}\n  </div>\n  <div class=\"oppia-thumbnail-preview-description\">\n    {{ description }}\n  </div>\n</div>\n<style>\n  .oppia-thumbnail-container {\n    background: #2F6687;\n    border-radius: 4px 4px 4px 4px;\n    box-shadow: 0 4.5px 10px rgba(0, 0, 0, 0.25);\n    color: #FFF;\n    height: 260px;\n    margin: 0 auto 15px auto;\n    max-width: 100%;\n    position: relative;\n    width: 186px;\n  }\n\n  .oppia-thumbnail-container img {\n    border-radius: 4px 4px 0 0;\n  }\n\n  .oppia-thumbnail-preview-description {\n    font-size: 16px;\n    line-height: 1.2;\n    overflow: hidden;\n    padding: 0 16px 0 16px;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n\n  .oppia-thumbnail-preview-footer {\n    bottom: 10px;\n    font-size: 16px;\n    font-style: italic;\n    line-height: 1.2;\n    padding: 0 16px 0 16px;\n    position: absolute;\n  }\n\n  .oppia-thumbnail-preview-title {\n    font-size: 18px;\n    font-weight: bold;\n    overflow: hidden;\n    padding: 10px 16px 10px 16px;\n    text-align: left;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n</style>\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/modal-templates/preview-thumbnail.component.spec.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Unit tests for the preview thumbnail component.\n */\n\nimport { HttpClientTestingModule } from '@angular/common/http/testing';\nimport { ComponentFixture, TestBed, waitForAsync } from '@angular/core/testing';\nimport { ThumbnailDisplayComponent } from 'components/forms/custom-forms-directives/thumbnail-display.component';\nimport { ContextService } from 'services/context.service';\nimport { ImageUploadHelperService } from 'services/image-upload-helper.service';\nimport { PreviewThumbnailComponent } from './preview-thumbnail.component';\n\ndescribe('Preview Thumbnail Component', function() {\n  let componentInstance: PreviewThumbnailComponent;\n  let fixture: ComponentFixture<PreviewThumbnailComponent>;\n  let imageUploadHelperService: ImageUploadHelperService;\n  let testUrl = 'test_url';\n\n  beforeEach(waitForAsync(() => {\n    TestBed.configureTestingModule({\n      imports: [HttpClientTestingModule],\n      declarations: [\n        PreviewThumbnailComponent,\n        ThumbnailDisplayComponent\n      ],\n      providers: [\n        ImageUploadHelperService,\n        ContextService\n      ]\n    }).compileComponents();\n  }));\n\n  beforeEach(() => {\n    fixture = TestBed.createComponent(PreviewThumbnailComponent);\n    componentInstance = fixture.componentInstance;\n    imageUploadHelperService = (\n       TestBed.inject(ImageUploadHelperService) as unknown) as\n         jasmine.SpyObj<ImageUploadHelperService>;\n    spyOn(\n      imageUploadHelperService, 'getTrustedResourceUrlForThumbnailFilename')\n      .and.returnValue(testUrl);\n  });\n\n  it('should create', () => {\n    expect(componentInstance).toBeDefined();\n  });\n\n  it('should initialize', () => {\n    componentInstance.ngOnInit();\n    expect(componentInstance.editableThumbnailDataUrl).toEqual(testUrl);\n  });\n});\n"
    },
    {
      "filename": "core/templates/pages/topic-editor-page/rearrange-skills-in-subtopics-modal.controller.ts",
      "content": "// Copyright 2020 The Oppia Authors. All Rights Reserved.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//      http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS-IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n/**\n * @fileoverview Controller for RearrangeSkillsInSubtopicsModal.\n */\n\nrequire(\n  'components/forms/custom-forms-directives/thumbnail-uploader.component.ts');\n\nrequire(\n  'components/common-layout-directives/common-elements/' +\n    'confirm-or-cancel-modal.controller.ts');\n\nrequire('domain/editor/undo_redo/undo-redo.service.ts');\nrequire('domain/topic/topic-update.service.ts');\nrequire('domain/utilities/url-interpolation.service.ts');\nrequire('pages/topic-editor-page/services/topic-editor-state.service.ts');\n\nimport { Subscription } from 'rxjs';\n\nangular.module('oppia').controller(\n  'RearrangeSkillsInSubtopicsModalController', [\n    '$controller', '$scope', '$uibModalInstance', 'SubtopicValidationService',\n    'TopicEditorStateService',\n    'TopicUpdateService', 'UrlInterpolationService',\n    function(\n        $controller, $scope, $uibModalInstance, SubtopicValidationService,\n        TopicEditorStateService, TopicUpdateService, UrlInterpolationService) {\n      $controller('ConfirmOrCancelModalController', {\n        $scope: $scope,\n        $uibModalInstance: $uibModalInstance\n      });\n      var ctrl = this;\n      var SKILL_EDITOR_URL_TEMPLATE = '/skill_editor/<skillId>';\n      ctrl.directiveSubscriptions = new Subscription();\n      ctrl.initEditor = function() {\n        ctrl.topic = TopicEditorStateService.getTopic();\n        ctrl.subtopics = ctrl.topic.getSubtopics();\n        ctrl.uncategorizedSkillSummaries = (\n          ctrl.topic.getUncategorizedSkillSummaries());\n      };\n\n      ctrl.getSkillEditorUrl = function(skillId) {\n        return UrlInterpolationService.interpolateUrl(\n          SKILL_EDITOR_URL_TEMPLATE, {\n            skillId: skillId\n          }\n        );\n      };\n\n      /**\n       * @param {string|null} oldSubtopicId - The id of the subtopic from\n       *    which the skill is to be moved, or null if the origin is the\n       *    uncategorized section.\n       * @param {SkillSummary} skillSummary - The summary of the skill that\n       *    is to be moved.\n       */\n      ctrl.onMoveSkillStart = function(oldSubtopicId, skillSummary) {\n        ctrl.skillSummaryToMove = skillSummary;\n        ctrl.oldSubtopicId = oldSubtopicId ? oldSubtopicId : null;\n      };\n\n      /**\n       * @param {string|null} newSubtopicId - The subtopic to which the\n       *    skill is to be moved, or null if the destination is the\n       *    uncategorized section.\n       */\n      ctrl.onMoveSkillEnd = function(newSubtopicId) {\n        if (newSubtopicId === ctrl.oldSubtopicId) {\n          return;\n        }\n\n        if (newSubtopicId === null) {\n          TopicUpdateService.removeSkillFromSubtopic(\n            ctrl.topic, ctrl.oldSubtopicId, ctrl.skillSummaryToMove);\n        } else {\n          TopicUpdateService.moveSkillToSubtopic(\n            ctrl.topic, ctrl.oldSubtopicId, newSubtopicId,\n            ctrl.skillSummaryToMove);\n        }\n        ctrl.initEditor();\n      };\n\n\n      ctrl.updateSubtopicTitle = function(subtopicId) {\n        if (!SubtopicValidationService.checkValidSubtopicName(\n          ctrl.editableName)) {\n          ctrl.errorMsg = 'A subtopic with this title already exists';\n          return;\n        }\n\n        TopicUpdateService.setSubtopicTitle(\n          ctrl.topic, subtopicId, ctrl.editableName);\n        ctrl.editNameOfSubtopicWithId(null);\n      };\n\n      ctrl.editNameOfSubtopicWithId = function(subtopicId) {\n        if (!subtopicId) {\n          ctrl.editableName = '';\n        }\n        ctrl.selectedSubtopicId = subtopicId;\n      };\n\n      ctrl.init = function() {\n        ctrl.editableName = '';\n        ctrl.directiveSubscriptions.add(\n          TopicEditorStateService.onTopicInitialized.subscribe(\n            () => ctrl.initEditor()\n          ));\n        ctrl.directiveSubscriptions.add(\n          TopicEditorStateService.onTopicReinitialized.subscribe(\n            () => ctrl.initEditor()\n          ));\n        ctrl.initEditor();\n      };\n      ctrl.init();\n      ctrl.$onDestroy = function() {\n        ctrl.directiveSubscriptions.unsubscribe();\n      };\n    }\n  ]\n);\n"
    }
  ],
  "questions": [
    "@masterboy376 Please go with the first solution. Can you explain what changes you'll make exactly and show proof that those changes don't result in warnings?\r\n\r\nAlso, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow? (As part of the fix for this issue, we should maybe add a backend test that tries to load dummy data so it catches this, and the backend ought to fail noisily if the dummy data doesn't pass strict validation -- that way, anyone who makes changes that result in strict validation failing will need to fix them so that this doesn't break other developers, and that is probably better than leaving the dummy data invalid which would cause problems for other devs.)",
    "> @masterboy376 Please go with the first solution. Can you explain what changes you'll make exactly and show proof that those changes don't result in warnings?\r\n> \r\n> Also, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow? (As part of the fix for this issue, we should maybe add a backend test that tries to load dummy data so it catches this, and the backend ought to fail noisily if the dummy data doesn't pass strict validation -- that way, anyone who makes changes that result in strict validation failing will need to fix them so that this doesn't break other developers, and that is probably better than leaving the dummy data invalid which would cause problems for other devs.)\r\n\r\n@seanlip ,\r\n\r\nI will change implementation of function _load_dummy_new_structures_data so that the all the validation checks passes on the dummy topic by default.\r\n\r\nFor the part of loading dummy data, the thing I found wrong is that it requires  the user to be a Curriculum Admin to load dummy data, but on the activities page it erroneously writes: admin can access that particular feature instead of writing Curriculum Admin.\r\n\r\nAlso, we can add a backend test that tries load dummy data by adding some tests to the existing activities.component.spec.ts.\r\n\r\nResult:\r\n![Screenshot (12)](https://github.com/oppia/oppia/assets/92575005/3018bfe5-f6f1-4841-a50b-53ecbb4b2a72)\r\n\r\nDummy data ready to be published by default.",
    "@masterboy376 Thanks, some notes:\r\n\r\n- You haven't answered this question: \"Also, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow?\". Why is the current dummy data not resulting in a server error when the button is clicked, and what specifically would you modify in the code to make that happen? For this question, please point to the specific line of code and show your proposed edits.\r\n- Re \"For the part of loading dummy data, the thing I found wrong is that it requires the user to be a Curriculum Admin to load dummy data, but on the activities page it erroneously writes: admin can access that particular feature instead of writing Curriculum Admin.\" -- we might need to fix that, yup. Probably just changing the text is enough (to direct the admin to give themselves Curriculum Admin permissions on the Roles tab).\r\n- \"Also, we can add a backend test that tries load dummy data by adding some tests to the existing activities.component.spec.ts.\" - I don't think this will work. The file you're referring to is a frontend file and it's not going to have access to the backend data. Given that this response is wrong, I can't conclude that you have a good enough understanding of this project to tackle it (at least not yet). I'm now going to ask that you try actually writing the test, running it to make sure it works, and screenshotting it here, before we assign you the issue.\r\n\r\nFeel free to ask if you have any questions about the above -- thanks.",
    "@seanlip, Thank you so much for these valuable inputs.\r\n\r\n1. Current Dummy data is not resulting in a server error, because currently the \"load data button\" generate two topics with incomplete fields, which fails the pre-publish validation checks preventing these topics to be readily published. There is no validation tests to test whether the generated topic ( by the function \"_load_dummy_new_structures_data\" ) passes all validation checks until we actually try to publish it (we should add a backend test to check this). I made following changes to resolve the validation warning issues:\r\n  1.1. added meta data content to the dummy topic 1:\r\n   ![Screenshot (13)](https://github.com/oppia/oppia/assets/92575005/1781b4d4-c871-4f89-a679-f52a2c7d244e)\r\n   1.2. added default thumbnail background image and color:\r\n   ![Screenshot (14)](https://github.com/oppia/oppia/assets/92575005/01750215-06ec-46f1-9718-9ff9864b12f6)\r\n   1.3. added default thumbnail background image and color to dummy subtopic:\r\n   ![Screenshot (15)](https://github.com/oppia/oppia/assets/92575005/ebaa1cd5-7f2a-49ae-9dea-24c430cdd6d4)\r\n   1.4. added diagnostic test to the topic testing atleast one skill (with at least 3 quesstions):\r\n   ![Screenshot (16)](https://github.com/oppia/oppia/assets/92575005/ad29723e-45a4-4d69-a880-3d2f26e79a09)\r\n   ![Screenshot (17)](https://github.com/oppia/oppia/assets/92575005/607c079b-1519-4536-8ff1-0e3bf868d1e9)\r\n   ![Screenshot (18)](https://github.com/oppia/oppia/assets/92575005/35794f89-3db8-448c-8e00-1b9a261e8477)\r\n   ![Screenshot (19)](https://github.com/oppia/oppia/assets/92575005/d6754888-4ee5-4ac1-92f7-6f940f25329b)\r\n   ![Screenshot (20)](https://github.com/oppia/oppia/assets/92575005/15dabf14-be8f-4ff7-8d67-247e91c285f6)\r\n\r\n2. I am working on the Backend test and will soon come up with it.\r\n\r\nI have following queries related to this issue:\r\n\r\n1.  Currently the \"_load_dummy_new_structures_data\" function generates two topics with name \"Dummy Topic 1\" and \"Empty Topic\". In the above screenshots I only resolved the validation warnings is the \"Dummy Topic 1\". In the later one, as the suggests, the topic should be empty. So, should I resolve warnings in \"Empty Topic\" as well or should it be left as it is? \r\n2. On the thumbnail upload modal there are two different guidelines of which the first on is applicable in the dev server.\r\n![Screenshot (21)](https://github.com/oppia/oppia/assets/92575005/401430c0-aed0-4787-9b34-4354f161b659)",
    "Thanks @masterboy376  -- I'll wait to see your backend test.\r\n\r\nFor the validation error analysis: just to check, when we load the dummy data, does it not end up in a \"published\" state? If not, then your explanation seems reasonable. But if it is, then my question stands: on the (automatic) publication why doesn't the publication fail?\r\n\r\nFor your questions:\r\n1. What's the empty topic used for?\r\n2. This is a bit weird and might be a bug. The uploaded image should satisfy all the guidelines given. But I think the person who implemented the inline warning in the \"Drag an image into this area\" section might not have seen this modal. If you get a chance, could you please find which PR did that (perhaps using git blame) so that I can advise on what to do here? Thanks!",
    "OK thanks. One question then. Should those topics end up in a \"published\" state, do you think?\r\n\r\n1. Hm, I think it's OK to just delete \"Empty topic\" TBH. If the dev wants a new topic they can easily create it. Let's optimize so that the final state of things is easy for devs to use.\r\n2. Sounds good, please let me know when you do that.\r\n\r\nAlso noting here that this is still waiting on the backend test (so it doesn't get lost in the comments above).",
    "Hello @seanlip ,\r\nFor the backend testing part I made following changes to [test_load_new_structures_data](https://github.com/oppia/oppia/blob/6171792008266ad07826564316712b4b7b10eb61/core/controllers/admin_test.py#L537C1-L537C1) function in admin_test.py file:\r\n![Screenshot (23)](https://github.com/oppia/oppia/assets/92575005/effd1af1-6c09-4f29-904a-fa2d7e1232ea)\r\nthese changes successfully tests for all the possible validation errors:\r\n![Screenshot (24)](https://github.com/oppia/oppia/assets/92575005/5f54658b-b89e-4124-bdbc-fbf87ee63b99)\r\nI would appreciate any valuable suggestions.\r\n\r\nI think the generated topics, through load dummy data button, should not end up in \"published\" state. There is an existing functionality serving that purpose:\r\n![Screenshot (25)](https://github.com/oppia/oppia/assets/92575005/b0736797-b178-4e76-bcee-01d98c269154)\r\n\r\nAlso, I think it would be best to leave to \"Empty topic as it is\" because its already mentioned to the user that the load dummy data will load 2 topics (one of which will be Empty). So, I will wait for your confirmation on this one to make changes.\r\n![Screenshot (26)](https://github.com/oppia/oppia/assets/92575005/e669e6e3-13da-41d0-92a9-8287ec9dc4eb)\r\n\r\nI believe [this commit](https://github.com/oppia/oppia/commit/77d2c9e84e281ca32da9ebfab246270da8293470) from [this PR](https://github.com/oppia/oppia/pull/12667) cause the bug in thumbnail uploader modal.\r\nTo solve this bug we have to change image-uploader component. I believe it is as a much larger issue because there are different components that use the same image uploader, and all these components have there own criteria for allowed image format. If you allow I can create a separate issue and a PR for this one (As I have already figured out the possible way of solving this one).\r\n\r\nCan I create PR for this issue now?",
    "@masterboy376 Thanks. Let's clean things up a bit:\r\n\r\n1. It is fine to clean up the empty topic and update the admin page message accordingly.\r\n2. Let's publish the generated topics. I don't see any harm in doing that. If the developer wants to create unpublished topics subsequently, they can do so manually.\r\n3. For the backend test, I wouldn't put all the individual validations in admin_test.py. I think publishing the topics (as mentioned in point 2 above) might solve it because a validation step runs, so it might get tested automatically if you do that step and just load the dummy data in tests. If/When you create a PR for this issue, then please demonstrate in the opening description that, if you change the dummy data to something invalid, then the backend test fails.\r\n4. Thanks for finding the old PR. I think that's not actually the issue -- there was probably a PR that changed the error message in the bottom-left yellow box. Can you find it? I think it is also OK to file a new issue to fix that.\r\n5. For the PR that broke the subtopic editor -- I don't quite understand what you mean. If there are no subtopics in the topic then how does a user get to the page with the error?\r\n\r\nIf you can respond with the answers to (4) and (5) (and file a clear issue for point 4), then I'd be happy to assign you to this issue. Thanks!",
    "Great -- you are correct re (4). /cc @AFZL210 so that he's aware of the breakage here. Can you please file the new issue?\r\n\r\nFor (5), ok sounds good, you might as well just fix it I think.\r\n\r\nPlease file the issue mentioned above and then link it here, then I'll assign you to this. Thanks!"
  ],
  "golden_answers": [
    "> @masterboy376 Please go with the first solution. Can you explain what changes you'll make exactly and show proof that those changes don't result in warnings?\r\n> \r\n> Also, could you please investigate and explain why the dummy data loading doesn't error here -- does it pass validation somehow? (As part of the fix for this issue, we should maybe add a backend test that tries to load dummy data so it catches this, and the backend ought to fail noisily if the dummy data doesn't pass strict validation -- that way, anyone who makes changes that result in strict validation failing will need to fix them so that this doesn't break other developers, and that is probably better than leaving the dummy data invalid which would cause problems for other devs.)\r\n\r\n@seanlip ,\r\n\r\nI will change implementation of function _load_dummy_new_structures_data so that the all the validation checks passes on the dummy topic by default.\r\n\r\nFor the part of loading dummy data, the thing I found wrong is that it requires  the user to be a Curriculum Admin to load dummy data, but on the activities page it erroneously writes: admin can access that particular feature instead of writing Curriculum Admin.\r\n\r\nAlso, we can add a backend test that tries load dummy data by adding some tests to the existing activities.component.spec.ts.\r\n\r\nResult:\r\n![Screenshot (12)](https://github.com/oppia/oppia/assets/92575005/3018bfe5-f6f1-4841-a50b-53ecbb4b2a72)\r\n\r\nDummy data ready to be published by default.",
    "@seanlip, Thank you so much for these valuable inputs.\r\n\r\n1. Current Dummy data is not resulting in a server error, because currently the \"load data button\" generate two topics with incomplete fields, which fails the pre-publish validation checks preventing these topics to be readily published. There is no validation tests to test whether the generated topic ( by the function \"_load_dummy_new_structures_data\" ) passes all validation checks until we actually try to publish it (we should add a backend test to check this). I made following changes to resolve the validation warning issues:\r\n  1.1. added meta data content to the dummy topic 1:\r\n   ![Screenshot (13)](https://github.com/oppia/oppia/assets/92575005/1781b4d4-c871-4f89-a679-f52a2c7d244e)\r\n   1.2. added default thumbnail background image and color:\r\n   ![Screenshot (14)](https://github.com/oppia/oppia/assets/92575005/01750215-06ec-46f1-9718-9ff9864b12f6)\r\n   1.3. added default thumbnail background image and color to dummy subtopic:\r\n   ![Screenshot (15)](https://github.com/oppia/oppia/assets/92575005/ebaa1cd5-7f2a-49ae-9dea-24c430cdd6d4)\r\n   1.4. added diagnostic test to the topic testing atleast one skill (with at least 3 quesstions):\r\n   ![Screenshot (16)](https://github.com/oppia/oppia/assets/92575005/ad29723e-45a4-4d69-a880-3d2f26e79a09)\r\n   ![Screenshot (17)](https://github.com/oppia/oppia/assets/92575005/607c079b-1519-4536-8ff1-0e3bf868d1e9)\r\n   ![Screenshot (18)](https://github.com/oppia/oppia/assets/92575005/35794f89-3db8-448c-8e00-1b9a261e8477)\r\n   ![Screenshot (19)](https://github.com/oppia/oppia/assets/92575005/d6754888-4ee5-4ac1-92f7-6f940f25329b)\r\n   ![Screenshot (20)](https://github.com/oppia/oppia/assets/92575005/15dabf14-be8f-4ff7-8d67-247e91c285f6)\r\n\r\n2. I am working on the Backend test and will soon come up with it.\r\n\r\nI have following queries related to this issue:\r\n\r\n1.  Currently the \"_load_dummy_new_structures_data\" function generates two topics with name \"Dummy Topic 1\" and \"Empty Topic\". In the above screenshots I only resolved the validation warnings is the \"Dummy Topic 1\". In the later one, as the suggests, the topic should be empty. So, should I resolve warnings in \"Empty Topic\" as well or should it be left as it is? \r\n2. On the thumbnail upload modal there are two different guidelines of which the first on is applicable in the dev server.\r\n![Screenshot (21)](https://github.com/oppia/oppia/assets/92575005/401430c0-aed0-4787-9b34-4354f161b659)",
    "@seanlip, Thank you so much for these valuable inputs.\r\n\r\n1. Current Dummy data is not resulting in a server error, because currently the \"load data button\" generate two topics with incomplete fields, which fails the pre-publish validation checks preventing these topics to be readily published. There is no validation tests to test whether the generated topic ( by the function \"_load_dummy_new_structures_data\" ) passes all validation checks until we actually try to publish it (we should add a backend test to check this). I made following changes to resolve the validation warning issues:\r\n  1.1. added meta data content to the dummy topic 1:\r\n   ![Screenshot (13)](https://github.com/oppia/oppia/assets/92575005/1781b4d4-c871-4f89-a679-f52a2c7d244e)\r\n   1.2. added default thumbnail background image and color:\r\n   ![Screenshot (14)](https://github.com/oppia/oppia/assets/92575005/01750215-06ec-46f1-9718-9ff9864b12f6)\r\n   1.3. added default thumbnail background image and color to dummy subtopic:\r\n   ![Screenshot (15)](https://github.com/oppia/oppia/assets/92575005/ebaa1cd5-7f2a-49ae-9dea-24c430cdd6d4)\r\n   1.4. added diagnostic test to the topic testing atleast one skill (with at least 3 quesstions):\r\n   ![Screenshot (16)](https://github.com/oppia/oppia/assets/92575005/ad29723e-45a4-4d69-a880-3d2f26e79a09)\r\n   ![Screenshot (17)](https://github.com/oppia/oppia/assets/92575005/607c079b-1519-4536-8ff1-0e3bf868d1e9)\r\n   ![Screenshot (18)](https://github.com/oppia/oppia/assets/92575005/35794f89-3db8-448c-8e00-1b9a261e8477)\r\n   ![Screenshot (19)](https://github.com/oppia/oppia/assets/92575005/d6754888-4ee5-4ac1-92f7-6f940f25329b)\r\n   ![Screenshot (20)](https://github.com/oppia/oppia/assets/92575005/15dabf14-be8f-4ff7-8d67-247e91c285f6)\r\n\r\n2. I am working on the Backend test and will soon come up with it.\r\n\r\nI have following queries related to this issue:\r\n\r\n1.  Currently the \"_load_dummy_new_structures_data\" function generates two topics with name \"Dummy Topic 1\" and \"Empty Topic\". In the above screenshots I only resolved the validation warnings is the \"Dummy Topic 1\". In the later one, as the suggests, the topic should be empty. So, should I resolve warnings in \"Empty Topic\" as well or should it be left as it is? \r\n2. On the thumbnail upload modal there are two different guidelines of which the first on is applicable in the dev server.\r\n![Screenshot (21)](https://github.com/oppia/oppia/assets/92575005/401430c0-aed0-4787-9b34-4354f161b659)",
    "@seanlip ,\r\nAs per current implementation, upon loading dummy data, dummy topics do not end up in \"published\" state.\r\n\r\nFor questions:\r\n\r\n1. \"Empty topic\" is the name of one of the dummy topics generated. \"Empty topic\" is similar to other topics generated on loading dummy data. I suggest changing its name to \"Dummy Topic 2\" to make it more reasonable.\r\n2. I will find PR thet might have been caused this bug shortly.",
    "@seanlip ,\r\nAs per current implementation, upon loading dummy data, dummy topics do not end up in \"published\" state.\r\n\r\nFor questions:\r\n\r\n1. \"Empty topic\" is the name of one of the dummy topics generated. \"Empty topic\" is similar to other topics generated on loading dummy data. I suggest changing its name to \"Dummy Topic 2\" to make it more reasonable.\r\n2. I will find PR thet might have been caused this bug shortly.",
    "Hello @seanlip ,\r\nFor the backend testing part I made following changes to [test_load_new_structures_data](https://github.com/oppia/oppia/blob/6171792008266ad07826564316712b4b7b10eb61/core/controllers/admin_test.py#L537C1-L537C1) function in admin_test.py file:\r\n![Screenshot (23)](https://github.com/oppia/oppia/assets/92575005/effd1af1-6c09-4f29-904a-fa2d7e1232ea)\r\nthese changes successfully tests for all the possible validation errors:\r\n![Screenshot (24)](https://github.com/oppia/oppia/assets/92575005/5f54658b-b89e-4124-bdbc-fbf87ee63b99)\r\nI would appreciate any valuable suggestions.\r\n\r\nI think the generated topics, through load dummy data button, should not end up in \"published\" state. There is an existing functionality serving that purpose:\r\n![Screenshot (25)](https://github.com/oppia/oppia/assets/92575005/b0736797-b178-4e76-bcee-01d98c269154)\r\n\r\nAlso, I think it would be best to leave to \"Empty topic as it is\" because its already mentioned to the user that the load dummy data will load 2 topics (one of which will be Empty). So, I will wait for your confirmation on this one to make changes.\r\n![Screenshot (26)](https://github.com/oppia/oppia/assets/92575005/e669e6e3-13da-41d0-92a9-8287ec9dc4eb)\r\n\r\nI believe [this commit](https://github.com/oppia/oppia/commit/77d2c9e84e281ca32da9ebfab246270da8293470) from [this PR](https://github.com/oppia/oppia/pull/12667) cause the bug in thumbnail uploader modal.\r\nTo solve this bug we have to change image-uploader component. I believe it is as a much larger issue because there are different components that use the same image uploader, and all these components have there own criteria for allowed image format. If you allow I can create a separate issue and a PR for this one (As I have already figured out the possible way of solving this one).\r\n\r\nCan I create PR for this issue now?",
    "Hello @seanlip ,\r\nWhile browsing the codebase I found that someone has made some changes to Dummy Topic 1 in this [commit ](https://github.com/oppia/oppia/commit/6171792008266ad07826564316712b4b7b10eb61) so it partially passes the validation checks and still there is no backend test for the same.\r\nAlso after this commit we are unable to open the subtopic editor :\r\n![Screenshot (45)](https://github.com/oppia/oppia/assets/92575005/6f38b404-4020-453c-aabe-963136a6d76e)\r\nthis is because the implementation in this commit does not add a subtopic to the dummy topic. In my implementation I have fixed this error using topic_id_1.add_subtopic() function.\r\nIf you allow then I can proceed with the PR which solves the above issue completely.",
    "@seanlip Thank you for your remarks:\r\n\r\n1. Point 1, 2, 3 are done as suggested.\r\n2.  Point 4: I think the PR that changed the error message in the bottom-left yellow box is [Fix #17711: Add Image Upload Prerequisites (#19194)](https://github.com/oppia/oppia/commit/5e8738af4a8daf0a02ecc7f22e36fbf8cb898816).\r\n3. Point 5: I apologies if the previous comment was not clear. I meant to say that the PR I referred to earlier added a subtopic to \"subtopics\" array property of \"Dummy Topic 1\" without using the proper function to do that, which is \"add_subtopic()\"function which properly creates a default subtopic associated with a topic, current Implementation broke the subtopic editor due to this reason. The same issue can also be seen in the topics generated by \"generate_dummy_classroom\" button.\r\nCurrent Implementation:\r\n![Screenshot (54)](https://github.com/oppia/oppia/assets/92575005/bb8de485-b08e-4bef-8f2b-a9a15d5ea45e)\r\nSuggested Implementation:\r\n![Screenshot (53)](https://github.com/oppia/oppia/assets/92575005/eb8fc400-c183-4a82-b145-ab3cdd16a700)\r\nThe suggested Implementation fixes the subtopic editor.",
    "@seanlip Thankyou,\r\nI created the following [Issue](https://github.com/oppia/oppia/issues/19424) Please take a look and suggest any changes if any."
  ],
  "questions_generated": [
    "What is the primary issue reported in the oppia_oppia repository regarding the dev server's dummy topic?",
    "What steps are suggested to reproduce and address the validation errors in the dummy topic on the dev server?",
    "What is the significance of having a specific SVG file in the context of this issue, and why is it considered 'weird'?",
    "How does the 'TopicCreationService' in 'topic-creation.service.ts' relate to the issue at hand?",
    "What role does the 'TopicsAndSkillsDashboardBackendApiService' play in the context of this issue?",
    "Why is it important to chronicle progress in a debugging document when working on this issue?",
    "What might be the impact of infrastructural changes on dummy data loading, and how should these be addressed?"
  ],
  "golden_answers_generated": [
    "The primary issue is that the dummy topic loaded on the dev server contains four validation errors, which need to be fixed. The dummy topic should come pre-populated without any validation errors to prevent developers from having to manually fix these errors before publishing.",
    "The suggested steps include: 1) Reproducing the error locally by loading dummy data through the admin interface and recording the errors. 2) Fixing each error to ensure seamless loading of dummy data. 3) Giving oneself superadmin permissions, visiting the editor pages for each dummy data item, and checking that they are saveable without warnings. 4) Extending dummy data loading to account for infrastructural changes and ensuring accurate wording next to buttons.",
    "The specific SVG file is mentioned as something the developer has always had saved on their computer specifically for uploading to Oppia's dev server, which highlights a workaround for a validation error. It is considered 'weird' because ideally, the dev server should not require manual uploads of assets to avoid validation errors, implying that the dummy data should be complete and error-free upon loading.",
    "The 'TopicCreationService' in 'topic-creation.service.ts' is likely involved in the creation of topics, including dummy topics. This service might need to be reviewed or modified to address the validation errors mentioned, ensuring that topics created via this service do not contain errors and are compliant with current validation rules.",
    "The 'TopicsAndSkillsDashboardBackendApiService' is involved in backend operations related to topics and skills, which may include loading and validating dummy data. Its role in this issue would be to ensure that the API correctly handles dummy data without resulting in validation errors, potentially requiring updates or fixes to its implementation.",
    "Chronicling progress in a debugging document is important because it provides a clear record of the steps taken to identify and fix the issue, helps in tracking changes, and allows others to understand the progress made. This collaborative documentation can be crucial for seeking help, ensuring continuity, and avoiding duplication of efforts.",
    "Infrastructural changes can affect how dummy data is loaded, potentially introducing new validation rules or requirements that were not previously accounted for. To address these, the dummy data loading process should be extended to include any new steps necessary to satisfy current infrastructure requirements, ensuring that the process is up-to-date and error-free."
  ]
}